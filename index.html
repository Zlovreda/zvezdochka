<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СНТ "Звездочка" - Учет электроэнергии и взносов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a252f 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            color: #f1c40f;
        }
        
        .logo-text h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        /* Auth Section */
        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        /* Auth Forms */
        .auth-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 2rem auto;
        }
        
        .auth-form h2 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
            flex: 1;
            text-align: center;
        }
        
        .tab:hover {
            background-color: #f8f9fa;
        }
        
        .tab.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            background-color: #f0f8ff;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-top: 4px solid var(--secondary);
        }
        
        .card-icon {
            font-size: 2rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }
        
        .card h3 {
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background-color: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #e9ecef;
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Meters */
        .meters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .meter-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--success);
        }
        
        .meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .meter-title {
            font-weight: 600;
            color: var(--dark);
        }
        
        .meter-status {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .status-inactive {
            background-color: #fdebd0;
            color: #f39c12;
        }
        
        /* Reading Form */
        .reading-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background-color: #d5f4e6;
            color: #27ae60;
            border-left: 4px solid #27ae60;
        }
        
        .alert-warning {
            background-color: #fdebd0;
            color: #f39c12;
            border-left: 4px solid #f39c12;
        }
        
        .alert-danger {
            background-color: #fadbd8;
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
        }
        
        .alert-info {
            background-color: #d6eaf8;
            color: #3498db;
            border-left: 4px solid #3498db;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: var(--secondary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        /* Supabase Test */
        .test-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 1rem; }
        .mt-2 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 2rem; }
        .d-none { display: none; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .meters-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
            
            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .auth-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .user-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="logo-text">
                    <h1>СНТ "Звездочка"</h1>
                    <p>Учет электроэнергии и членских взносов</p>
                </div>
            </div>
            
            <div class="auth-section" id="authSection">
                <!-- Будет заполнено JavaScript -->
            </div>
        </header>
        
        <!-- Основной контент (зависит от авторизации) -->
        <div id="mainContent">
            <!-- Показываем форму входа по умолчанию -->
            <div class="auth-form" id="loginForm">
                <h2><i class="fas fa-sign-in-alt"></i> Вход в систему</h2>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="ваш@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Ваш пароль">
                </div>
                <button class="btn btn-primary btn-block" onclick="login()">
                    <span class="loading" id="loginLoading" style="display: none;"></span>
                    Войти
                </button>
                <div class="mt-1 text-center">
                    <small>Демо доступ: admin@zvezdochka.ru / admin123</small>
                </div>
            </div>
        </div>
        
        <!-- Тестирование Supabase -->
        <div class="test-section">
            <h3><i class="fas fa-database"></i> Проверка подключения к базе данных</h3>
            <p>Проверьте доступность сервера Supabase перед началом работы</p>
            <div class="test-buttons">
                <button class="btn btn-primary" onclick="testSupabaseConnection()">
                    <i class="fas fa-plug"></i> Проверить подключение
                </button>
                <button class="btn btn-warning" onclick="testSupabaseTables()">
                    <i class="fas fa-table"></i> Проверить таблицы
                </button>
                <button class="btn btn-success" onclick="initializeDatabase()">
                    <i class="fas fa-database"></i> Инициализировать БД
                </button>
            </div>
            <div id="testResults" class="mt-1"></div>
        </div>
    </div>
    
    <!-- Модальные окна -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Панель администратора</h3>
                <button class="close-modal" onclick="closeAdminModal()">×</button>
            </div>
            <div id="adminModalContent">
                <!-- Контент будет заполнен JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Скрипты -->
    <script>
        // ===================== КОНФИГУРАЦИЯ =====================
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ2JkYnVpcXpkbXdpbml5eHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU';
        
        // Инициализация Supabase клиента
        const supabaseClient = {
            url: SUPABASE_URL,
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            }
        };
        
        // ===================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====================
        let currentUser = null;
        let userRole = 'guest';
        let currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
        
        // ===================== ФУНКЦИИ АВТОРИЗАЦИИ =====================
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loading = document.getElementById('loginLoading');
            
            if (!email || !password) {
                showAlert('Введите email и пароль', 'warning');
                return;
            }
            
            loading.style.display = 'inline-block';
            
            try {
                // В реальном приложении здесь будет запрос к Supabase Auth
                // Для демо используем фиктивную авторизацию
                await fakeAuth(email, password);
                
                // Получаем данные пользователя
                const userData = await getUserData(email);
                currentUser = userData;
                userRole = userData.role || 'user';
                
                // Показываем интерфейс в зависимости от роли
                showUserInterface();
                
                showAlert('Успешный вход в систему', 'success');
                
            } catch (error) {
                showAlert(`Ошибка входа: ${error.message}`, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }
        
        async function fakeAuth(email, password) {
            // Фиктивная авторизация для демо
            // В реальном приложении заменить на Supabase Auth
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Демо данные
                    const demoUsers = {
                        'admin@zvezdochka.ru': { 
                            password: 'admin123', 
                            role: 'admin',
                            name: 'Администратор СНТ'
                        },
                        'user1@zvezdochka.ru': { 
                            password: 'user123', 
                            role: 'user',
                            name: 'Иванов Иван Иванович'
                        },
                        'user2@zvezdochka.ru': { 
                            password: 'user123', 
                            role: 'user',
                            name: 'Петров Петр Петрович'
                        }
                    };
                    
                    if (demoUsers[email] && demoUsers[email].password === password) {
                        resolve({ email, ...demoUsers[email] });
                    } else {
                        reject(new Error('Неверный email или пароль'));
                    }
                }, 500);
            });
        }
        
        async function getUserData(email) {
            // Получение данных пользователя из "базы данных"
            // В реальном приложении будет запрос к таблице profiles
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/profiles?email=eq.${email}`, {
                    method: 'GET',
                    headers: supabaseClient.headers
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.length > 0) {
                        return data[0];
                    }
                }
            } catch (error) {
                console.warn('Не удалось получить данные пользователя:', error);
            }
            
            // Если нет в базе, возвращаем демо данные
            const demoData = {
                'admin@zvezdochka.ru': {
                    id: 'admin-001',
                    email: 'admin@zvezdochka.ru',
                    full_name: 'Администратор СНТ',
                    role: 'admin',
                    plot_number: 'АДМ',
                    sotki: 0,
                    plots_count: 1
                },
                'user1@zvezdochka.ru': {
                    id: 'user-001',
                    email: 'user1@zvezdochka.ru',
                    full_name: 'Иванов Иван Иванович',
                    role: 'user',
                    plot_number: '15',
                    sotki: 6,
                    plots_count: 1
                },
                'user2@zvezdochka.ru': {
                    id: 'user-002',
                    email: 'user2@zvezdochka.ru',
                    full_name: 'Петров Петр Петрович',
                    role: 'user',
                    plot_number: '22',
                    sotki: 8,
                    plots_count: 2
                }
            };
            
            return demoData[email] || {
                id: 'guest-001',
                email: email,
                full_name: email.split('@')[0],
                role: 'user',
                plot_number: '00',
                sotki: 6,
                plots_count: 1
            };
        }
        
        function logout() {
            currentUser = null;
            userRole = 'guest';
            showLoginForm();
            showAlert('Вы вышли из системы', 'info');
        }
        
        function showLoginForm() {
            document.getElementById('mainContent').innerHTML = `
                <div class="auth-form" id="loginForm">
                    <h2><i class="fas fa-sign-in-alt"></i> Вход в систему</h2>
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="ваш@email.com">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Пароль</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Ваш пароль">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="login()">
                        <span class="loading" id="loginLoading" style="display: none;"></span>
                        Войти
                    </button>
                    <div class="mt-1 text-center">
                        <small>Демо доступ: admin@zvezdochka.ru / admin123</small>
                    </div>
                </div>
            `;
            
            updateAuthSection();
        }
        
        function showUserInterface() {
            updateAuthSection();
            
            if (userRole === 'admin') {
                showAdminInterface();
            } else {
                showUserDashboard();
            }
        }
        
        function updateAuthSection() {
            const authSection = document.getElementById('authSection');
            
            if (currentUser) {
                authSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${currentUser.full_name}</div>
                        <div class="user-role">${userRole === 'admin' ? 'Администратор' : 'Участник СНТ'}</div>
                    </div>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </button>
                `;
            } else {
                authSection.innerHTML = '';
            }
        }
        
        // ===================== ИНТЕРФЕЙС ПОЛЬЗОВАТЕЛЯ =====================
        function showUserDashboard() {
            document.getElementById('mainContent').innerHTML = `
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('user-dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Панель управления
                    </div>
                    <div class="tab" onclick="switchTab('user-electricity')">
                        <i class="fas fa-bolt"></i> Электроэнергия
                    </div>
                    <div class="tab" onclick="switchTab('user-fees')">
                        <i class="fas fa-ruble-sign"></i> Членские взносы
                    </div>
                    <div class="tab" onclick="switchTab('user-history')">
                        <i class="fas fa-history"></i> История
                    </div>
                </div>
                
                <div id="user-dashboard" class="tab-content active">
                    <h2><i class="fas fa-home"></i> Мой участок</h2>
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-user"></i></div>
                            <h3>Участок №${currentUser.plot_number}</h3>
                            <p>Количество соток: ${currentUser.sotki}</p>
                            <div class="card-value">${currentUser.full_name}</div>
                        </div>
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-bolt"></i></div>
                            <h3>Электроэнергия</h3>
                            <p>К оплате за текущий месяц</p>
                            <div class="card-value" id="electricityDue">Загрузка...</div>
                        </div>
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-ruble-sign"></i></div>
                            <h3>Членские взносы</h3>
                            <p>К оплате за текущий месяц</p>
                            <div class="card-value" id="feesDue">Загрузка...</div>
                        </div>
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
                            <h3>Общая сумма</h3>
                            <p>Всего к оплате</p>
                            <div class="card-value" id="totalDue">Загрузка...</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Информация:</strong> Для внесения показаний счетчиков перейдите во вкладку "Электроэнергия"
                    </div>
                </div>
                
                <div id="user-electricity" class="tab-content">
                    <h2><i class="fas fa-bolt"></i> Учет электроэнергии</h2>
                    <div id="userMetersSection"></div>
                    <div id="electricityHistory"></div>
                </div>
                
                <div id="user-fees" class="tab-content">
                    <h2><i class="fas fa-ruble-sign"></i> Членские взносы</h2>
                    <div id="userFeesSection"></div>
                </div>
                
                <div id="user-history" class="tab-content">
                    <h2><i class="fas fa-history"></i> История платежей</h2>
                    <div id="paymentHistory"></div>
                </div>
            `;
            
            loadUserDashboardData();
            loadUserMeters();
            loadUserFees();
            loadPaymentHistory();
        }
        
        async function loadUserDashboardData() {
            try {
                // Расчет суммы за электроэнергию
                const electricityDue = await calculateElectricityDue();
                document.getElementById('electricityDue').innerHTML = `${electricityDue.toFixed(2)} ₽`;
                
                // Расчет членских взносов
                const feesDue = await calculateFeesDue();
                document.getElementById('feesDue').innerHTML = `${feesDue.toFixed(2)} ₽`;
                
                // Общая сумма
                const totalDue = electricityDue + feesDue;
                document.getElementById('totalDue').innerHTML = `${totalDue.toFixed(2)} ₽`;
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                document.getElementById('electricityDue').innerHTML = 'Ошибка';
                document.getElementById('feesDue').innerHTML = 'Ошибка';
                document.getElementById('totalDue').innerHTML = 'Ошибка';
            }
        }
        
        async function loadUserMeters() {
            const section = document.getElementById('userMetersSection');
            section.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Загружаем данные счетчиков...
                </div>
            `;
            
            try {
                // Получаем счетчики пользователя
                const response = await fetch(`${SUPABASE_URL}/rest/v1/meters?user_id=eq.${currentUser.id}`, {
                    method: 'GET',
                    headers: supabaseClient.headers
                });
                
                let meters = [];
                if (response.ok) {
                    meters = await response.json();
                }
                
                // Если нет счетчиков, создаем демо
                if (meters.length === 0) {
                    meters = [
                        {
                            id: 'meter-1',
                            meter_number: 'ЭС-001',
                            installation_date: '2023-01-15',
                            is_active: true,
                            last_reading: 1250
                        },
                        {
                            id: 'meter-2',
                            meter_number: 'ЭС-002',
                            installation_date: '2023-03-20',
                            is_active: true,
                            last_reading: 560
                        }
                    ];
                }
                
                // Отображаем счетчики
                let html = `<h3>Мои счетчики</h3><div class="meters-grid">`;
                
                meters.forEach(meter => {
                    html += `
                        <div class="meter-card">
                            <div class="meter-header">
                                <div class="meter-title">Счетчик ${meter.meter_number}</div>
                                <div class="meter-status ${meter.is_active ? 'status-active' : 'status-inactive'}">
                                    ${meter.is_active ? 'Активен' : 'Неактивен'}
                                </div>
                            </div>
                            <p>Установлен: ${new Date(meter.installation_date).toLocaleDateString('ru-RU')}</p>
                            <p>Последнее показание: <strong>${meter.last_reading || 0} кВт.ч</strong></p>
                            <div class="reading-form mt-1">
                                <div class="form-group">
                                    <label>Текущие показания (кВт.ч)</label>
                                    <input type="number" class="form-control" id="reading-${meter.id}" 
                                           placeholder="Введите текущие показания">
                                </div>
                                <button class="btn btn-success btn-block" onclick="submitReading('${meter.id}')">
                                    <i class="fas fa-paper-plane"></i> Отправить показания
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                section.innerHTML = html;
                
            } catch (error) {
                section.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ошибка загрузки счетчиков: ${error.message}
                    </div>
                `;
            }
        }
        
        async function submitReading(meterId) {
            const readingInput = document.getElementById(`reading-${meterId}`);
            const readingValue = parseInt(readingInput.value);
            
            if (!readingValue || readingValue < 0) {
                showAlert('Введите корректные показания', 'warning');
                return;
            }
            
            try {
                // Сохраняем показания
                const readingData = {
                    meter_id: meterId,
                    user_id: currentUser.id,
                    reading_value: readingValue,
                    reading_date: new Date().toISOString().split('T')[0],
                    month: currentMonth,
                    created_at: new Date().toISOString()
                };
                
                // В реальном приложении: отправка на сервер
                showAlert(`Показания ${readingValue} кВт.ч успешно отправлены`, 'success');
                readingInput.value = '';
                
                // Обновляем данные
                loadUserDashboardData();
                
            } catch (error) {
                showAlert(`Ошибка отправки показаний: ${error.message}`, 'danger');
            }
        }
        
        async function calculateElectricityDue() {
            // Сложный расчет тарифа
            // 1. Потери: весь объем * тариф потерь
            // 2. До 100 кВт.ч: первые 100 * тариф до 100
            // 3. Свыше 100: оставшийся объем * тариф свыше 100
            
            // Демо расчет
            const totalConsumption = 763; // кВт.ч
            const tariffLoss = 0.36; // руб/кВт.ч
            const tariffUnder100 = 6.1; // руб/кВт.ч
            const tariffOver100 = 7.3; // руб/кВт.ч
            
            // Расчет
            const lossAmount = totalConsumption * tariffLoss;
            const under100Amount = Math.min(totalConsumption, 100) * tariffUnder100;
            const over100Amount = totalConsumption > 100 ? (totalConsumption - 100) * tariffOver100 : 0;
            
            return lossAmount + under100Amount + over100Amount;
        }
        
        async function loadUserFees() {
            const section = document.getElementById('userFeesSection');
            
            // Демо данные по взносам
            const feesData = {
                salary_fee: 939.00 * currentUser.plots_count,
                maintenance_fee: 44.00 * currentUser.sotki,
                additional1: 0,
                additional2: 0,
                additional3: 0
            };
            
            const totalFees = Object.values(feesData).reduce((a, b) => a + b, 0);
            
            section.innerHTML = `
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <h3>Взнос с зарплаты</h3>
                        <p>${currentUser.plots_count} участок(ов) × 939.00 ₽</p>
                        <div class="card-value">${feesData.salary_fee.toFixed(2)} ₽</div>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-tools"></i></div>
                        <h3>Содержание</h3>
                        <p>${currentUser.sotki} соток × 44.00 ₽</p>
                        <div class="card-value">${feesData.maintenance_fee.toFixed(2)} ₽</div>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-plus-circle"></i></div>
                        <h3>Дополнительные</h3>
                        <p>Прочие взносы</p>
                        <div class="card-value">${(feesData.additional1 + feesData.additional2 + feesData.additional3).toFixed(2)} ₽</div>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-calculator"></i></div>
                        <h3>Итого взносы</h3>
                        <p>Всего за месяц</p>
                        <div class="card-value">${totalFees.toFixed(2)} ₽</div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-2">
                    <i class="fas fa-info-circle"></i>
                    <strong>Расчет членских взносов:</strong><br>
                    1. Взнос с зарплаты: 939.00 ₽ × количество участков (${currentUser.plots_count})<br>
                    2. Содержание: 44.00 ₽ × количество соток (${currentUser.sotki})<br>
                    3. Дополнительные взносы устанавливаются правлением СНТ
                </div>
            `;
        }
        
        async function calculateFeesDue() {
            // Расчет членских взносов
            const salaryPerPlot = 939.00;
            const maintenancePerSotka = 44.00;
            
            return (salaryPerPlot * (currentUser.plots_count || 1)) + 
                   (maintenancePerSotka * (currentUser.sotki || 6));
        }
        
        async function loadPaymentHistory() {
            const section = document.getElementById('paymentHistory');
            
            // Демо история платежей
            const history = [
                { month: '2024-01', electricity: 5842.30, fees: 1203.00, status: 'оплачено', date: '2024-01-25' },
                { month: '2023-12', electricity: 5120.50, fees: 1203.00, status: 'оплачено', date: '2023-12-22' },
                { month: '2023-11', electricity: 4987.80, fees: 1203.00, status: 'оплачено', date: '2023-11-28' },
                { month: '2023-10', electricity: 5234.10, fees: 1203.00, status: 'оплачено', date: '2023-10-24' }
            ];
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Месяц</th>
                            <th>Электроэнергия</th>
                            <th>Членские взносы</th>
                            <th>Всего</th>
                            <th>Статус</th>
                            <th>Дата оплаты</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            history.forEach(item => {
                const total = item.electricity + item.fees;
                html += `
                    <tr>
                        <td>${item.month}</td>
                        <td>${item.electricity.toFixed(2)} ₽</td>
                        <td>${item.fees.toFixed(2)} ₽</td>
                        <td><strong>${total.toFixed(2)} ₽</strong></td>
                        <td><span class="status-active">${item.status}</span></td>
                        <td>${item.date}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            section.innerHTML = html;
        }
        
        // ===================== ИНТЕРФЕЙС АДМИНИСТРАТОРА =====================
        function showAdminInterface() {
            document.getElementById('mainContent').innerHTML = `
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('admin-dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Дашборд
                    </div>
                    <div class="tab" onclick="switchTab('admin-users')">
                        <i class="fas fa-users"></i> Участники
                    </div>
                    <div class="tab" onclick="switchTab('admin-electricity')">
                        <i class="fas fa-bolt"></i> Электроэнергия
                    </div>
                    <div class="tab" onclick="switchTab('admin-fees')">
                        <i class="fas fa-ruble-sign"></i> Взносы
                    </div>
                    <div class="tab" onclick="switchTab('admin-tariffs')">
                        <i class="fas fa-chart-line"></i> Тарифы
                    </div>
                    <div class="tab" onclick="switchTab('admin-import')">
                        <i class="fas fa-file-import"></i> Импорт/Экспорт
                    </div>
                </div>
                
                <div id="admin-dashboard" class="tab-content active">
                    <div class="d-flex justify-between align-center mb-2">
                        <h2><i class="fas fa-cogs"></i> Панель администратора</h2>
                        <button class="btn btn-primary" onclick="showAdminModal('settings')">
                            <i class="fas fa-cog"></i> Настройки системы
                        </button>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-users"></i></div>
                            <h3>Участники</h3>
                            <p>Всего зарегистрировано</p>
                            <div class="card-value" id="totalUsers">Загрузка...</div>
                        </div>
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-bolt"></i></div>
                            <h3>Электроэнергия</h3>
                            <p>Ожидает оплаты</p>
                            <div class="card-value" id="totalElectricity">Загрузка...</div>
                        </div>
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-ruble-sign"></i></div>
                            <h3>Членские взносы</h3>
                            <p>Ожидает оплаты</p>
                            <div class="card-value" id="totalFees">Загрузка...</div>
                        </div>
                        <div class="card">
                            <div class="card-icon"><i class="fas fa-calendar-check"></i></div>
                            <h3>Текущий месяц</h3>
                            <p>${new Date().toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}</p>
                            <div class="card-value">${currentMonth}</div>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <h3>Быстрые действия</h3>
                        <div class="test-buttons">
                            <button class="btn btn-success" onclick="showAdminModal('addUser')">
                                <i class="fas fa-user-plus"></i> Добавить участника
                            </button>
                            <button class="btn btn-warning" onclick="showAdminModal('editTariffs')">
                                <i class="fas fa-edit"></i> Редактировать тарифы
                            </button>
                            <button class="btn btn-primary" onclick="showAdminModal('batchReadings')">
                                <i class="fas fa-table"></i> Пакетный ввод показаний
                            </button>
                            <button class="btn btn-danger" onclick="generateReports()">
                                <i class="fas fa-file-pdf"></i> Сформировать отчеты
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="admin-users" class="tab-content">
                    <h2><i class="fas fa-users"></i> Управление участниками</h2>
                    <div id="usersList"></div>
                </div>
                
                <div id="admin-electricity" class="tab-content">
                    <h2><i class="fas fa-bolt"></i> Управление электроэнергией</h2>
                    <div id="electricityManagement"></div>
                </div>
                
                <div id="admin-fees" class="tab-content">
                    <h2><i class="fas fa-ruble-sign"></i> Управление взносами</h2>
                    <div id="feesManagement"></div>
                </div>
                
                <div id="admin-tariffs" class="tab-content">
                    <h2><i class="fas fa-chart-line"></i> Управление тарифами</h2>
                    <div id="tariffsManagement"></div>
                </div>
                
                <div id="admin-import" class="tab-content">
                    <h2><i class="fas fa-file-import"></i> Импорт и экспорт данных</h2>
                    <div id="importExportSection"></div>
                </div>
            `;
            
            loadAdminDashboard();
            loadUsersList();
            loadElectricityManagement();
            loadFeesManagement();
            loadTariffsManagement();
            loadImportExport();
        }
        
        async function loadAdminDashboard() {
            try {
                // Получаем данные для админ-панели
                document.getElementById('totalUsers').innerHTML = '~200';
                document.getElementById('totalElectricity').innerHTML = '~450,000 ₽';
                document.getElementById('totalFees').innerHTML = '~240,000 ₽';
                
            } catch (error) {
                console.error('Ошибка загрузки админ-дашборда:', error);
            }
        }
        
        async function loadUsersList() {
            const section = document.getElementById('usersList');
            
            // Демо список пользователей
            const users = [
                { id: 1, name: 'Иванов И.И.', plot: '15', sotki: 6, plots: 1, phone: '+7 (123) 456-78-90', email: 'ivanov@mail.ru' },
                { id: 2, name: 'Петров П.П.', plot: '22', sotki: 8, plots: 2, phone: '+7 (123) 456-78-91', email: 'petrov@mail.ru' },
                { id: 3, name: 'Сидоров С.С.', plot: '18', sotki: 6, plots: 1, phone: '+7 (123) 456-78-92', email: 'sidorov@mail.ru' },
                { id: 4, name: 'Кузнецов К.К.', plot: '25', sotki: 10, plots: 1, phone: '+7 (123) 456-78-93', email: 'kuznetsov@mail.ru' },
                { id: 5, name: 'Смирнов С.С.', plot: '30', sotki: 6, plots: 1, phone: '+7 (123) 456-78-94', email: 'smirnov@mail.ru' }
            ];
            
            let html = `
                <div class="d-flex justify-between align-center mb-2">
                    <button class="btn btn-success" onclick="showAdminModal('addUser')">
                        <i class="fas fa-user-plus"></i> Добавить участника
                    </button>
                    <button class="btn btn-primary" onclick="exportUsers()">
                        <i class="fas fa-download"></i> Экспорт в Excel
                    </button>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ФИО</th>
                            <th>Участок</th>
                            <th>Сотки</th>
                            <th>Участков</th>
                            <th>Телефон</th>
                            <th>Email</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.plot}</td>
                        <td>${user.sotki}</td>
                        <td>${user.plots}</td>
                        <td>${user.phone}</td>
                        <td>${user.email}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            section.innerHTML = html;
        }
        
        function showAdminModal(modalType) {
            const modal = document.getElementById('adminModal');
            const content = document.getElementById('adminModalContent');
            
            let modalContent = '';
            
            switch(modalType) {
                case 'addUser':
                    modalContent = `
                        <h3 class="modal-title">Добавить нового участника</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ФИО</label>
                                <input type="text" class="form-control" id="newUserName">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" id="newUserEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Номер участка</label>
                                <input type="text" class="form-control" id="newUserPlot">
                            </div>
                            <div class="form-group">
                                <label>Количество соток</label>
                                <input type="number" class="form-control" id="newUserSotki" value="6">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Количество участков</label>
                                <input type="number" class="form-control" id="newUserPlots" value="1">
                            </div>
                            <div class="form-group">
                                <label>Телефон</label>
                                <input type="tel" class="form-control" id="newUserPhone">
                            </div>
                        </div>
                        <button class="btn btn-success btn-block" onclick="saveNewUser()">
                            <i class="fas fa-save"></i> Сохранить участника
                        </button>
                    `;
                    break;
                    
                case 'batchReadings':
                    modalContent = `
                        <h3 class="modal-title">Пакетный ввод показаний</h3>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Загрузите Excel-файл с показаниями счетчиков или введите данные вручную
                        </div>
                        
                        <div class="form-group">
                            <label>Месяц</label>
                            <input type="month" class="form-control" id="batchMonth" value="${currentMonth}">
                        </div>
                        
                        <div class="form-group">
                            <label>Данные для ввода (JSON или CSV)</label>
                            <textarea class="form-control" id="batchData" rows="10" placeholder='[{"user_id": "1", "meter_number": "ЭС-001", "reading": 1500}, ...]'></textarea>
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-primary" onclick="uploadReadingsFile()">
                                <i class="fas fa-upload"></i> Загрузить из файла
                            </button>
                            <button class="btn btn-success" onclick="processBatchReadings()">
                                <i class="fas fa-check"></i> Обработать данные
                            </button>
                            <button class="btn btn-warning" onclick="downloadReadingsTemplate()">
                                <i class="fas fa-download"></i> Шаблон для заполнения
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'editTariffs':
                    modalContent = `
                        <h3 class="modal-title">Редактирование тарифов</h3>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Изменение тарифов применяется с нового расчетного периода
                        </div>
                        
                        <h4>Тарифы на электроэнергию</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Потери (руб/кВт.ч)</label>
                                <input type="number" step="0.01" class="form-control" id="tariffLoss" value="0.36">
                            </div>
                            <div class="form-group">
                                <label>До 100 кВт.ч (руб/кВт.ч)</label>
                                <input type="number" step="0.01" class="form-control" id="tariffUnder100" value="6.10">
                            </div>
                            <div class="form-group">
                                <label>Свыше 100 кВт.ч (руб/кВт.ч)</label>
                                <input type="number" step="0.01" class="form-control" id="tariffOver100" value="7.30">
                            </div>
                        </div>
                        
                        <h4 class="mt-2">Членские взносы</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Взнос с зарплаты (руб/участок)</label>
                                <input type="number" step="0.01" class="form-control" id="feeSalary" value="939.00">
                            </div>
                            <div class="form-group">
                                <label>Содержание (руб/сотка)</label>
                                <input type="number" step="0.01" class="form-control" id="feeMaintenance" value="44.00">
                            </div>
                        </div>
                        
                        <div class="form-row mt-2">
                            <div class="form-group">
                                <label>Дополнительный взнос 1</label>
                                <input type="number" step="0.01" class="form-control" id="feeAdditional1" value="0">
                            </div>
                            <div class="form-group">
                                <label>Дополнительный взнос 2</label>
                                <input type="number" step="0.01" class="form-control" id="feeAdditional2" value="0">
                            </div>
                            <div class="form-group">
                                <label>Дополнительный взнос 3</label>
                                <input type="number" step="0.01" class="form-control" id="feeAdditional3" value="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Дата вступления в силу</label>
                            <input type="date" class="form-control" id="tariffValidFrom">
                        </div>
                        
                        <button class="btn btn-success btn-block mt-2" onclick="saveTariffs()">
                            <i class="fas fa-save"></i> Сохранить тарифы
                        </button>
                    `;
                    break;
                    
                default:
                    modalContent = `<h3 class="modal-title">Настройки системы</h3><p>Контент настроек</p>`;
            }
            
            content.innerHTML = modalContent;
            modal.classList.add('active');
        }
        
        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('active');
        }
        
        // ===================== ФУНКЦИИ ПЕРЕКЛЮЧЕНИЯ ВКЛАДОК =====================
        function switchTab(tabName) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Убрать активный класс у всех вкладок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показать выбранную вкладку
            document.getElementById(tabName).classList.add('active');
            
            // Активировать соответствующую кнопку вкладки
            const activeTab = Array.from(document.querySelectorAll('.tab')).find(tab => 
                tab.textContent.includes(document.getElementById(tabName).querySelector('h2').textContent)
            );
            if (activeTab) activeTab.classList.add('active');
        }
        
        // ===================== ТЕСТИРОВАНИЕ SUPABASE =====================
        async function testSupabaseConnection() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="alert alert-info"><span class="loading"></span> Проверяем подключение к Supabase...</div>';
            
            try {
                // Проверка доступности сервера
                const response = await fetch(SUPABASE_URL, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>✅ Supabase доступен!</strong><br>
                            Сервер отвечает корректно. Статус: ${response.status}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>⚠️ Supabase отвечает с ошибкой</strong><br>
                            Статус: ${response.status} ${response.statusText}
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i>
                        <strong>❌ Ошибка подключения к Supabase!</strong><br>
                        ${error.message}<br>
                        Проверьте URL: ${SUPABASE_URL}
                    </div>
                `;
            }
        }
        
        async function testSupabaseTables() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="alert alert-info"><span class="loading"></span> Проверяем доступность таблиц...</div>';
            
            try {
                // Проверка основных таблиц
                const tables = ['profiles', 'meters', 'electricity_readings', 'membership_fees', 'tariffs'];
                let results = [];
                
                for (const table of tables) {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?limit=1`, {
                            method: 'GET',
                            headers: supabaseClient.headers
                        });
                        
                        if (response.ok) {
                            results.push(`✅ ${table}`);
                        } else if (response.status === 404) {
                            results.push(`⚠️ ${table} (не найдена)`);
                        } else {
                            results.push(`❌ ${table} (ошибка ${response.status})`);
                        }
                    } catch (error) {
                        results.push(`❌ ${table} (${error.message})`);
                    }
                }
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-table"></i>
                        <strong>Результаты проверки таблиц:</strong><br>
                        ${results.join('<br>')}
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i>
                        <strong>Ошибка проверки таблиц:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function initializeDatabase() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="alert alert-info"><span class="loading"></span> Инициализация базы данных...</div>';
            
            try {
                // Создание демо данных
                showAlert('Инициализация базы данных выполнена успешно!', 'success');
                
                // Автоматическое тестирование после инициализации
                setTimeout(() => {
                    testSupabaseConnection();
                    setTimeout(testSupabaseTables, 1000);
                }, 500);
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i>
                        <strong>Ошибка инициализации:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        // ===================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====================
        function showAlert(message, type = 'info') {
            // Создаем уведомление
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            // Добавляем в начало контейнера
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Автоматически удаляем через 5 секунд
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, есть ли сохраненная сессия
            const savedUser = localStorage.getItem('zvezdochka_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    userRole = currentUser.role || 'user';
                    showUserInterface();
                } catch (e) {
                    localStorage.removeItem('zvezdochka_user');
                }
            }
            
            // Автоматически проверяем подключение к Supabase
            setTimeout(testSupabaseConnection, 1000);
        });
        
        // Функции для админ-панели (заглушки)
        function loadElectricityManagement() {
            document.getElementById('electricityManagement').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Раздел управления электроэнергией. Здесь можно просматривать и редактировать показания всех счетчиков.
                </div>
            `;
        }
        
        function loadFeesManagement() {
            document.getElementById('feesManagement').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Раздел управления членскими взносами. Здесь можно настраивать тарифы и просматривать историю платежей.
                </div>
            `;
        }
        
        function loadTariffsManagement() {
            document.getElementById('tariffsManagement').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Раздел управления тарифами. История изменения тарифов и установка новых значений.
                </div>
            `;
        }
        
        function loadImportExport() {
            document.getElementById('importExportSection').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Раздел импорта и экспорта данных. Загрузка данных из Excel и выгрузка отчетов.
                </div>
            `;
        }
        
        function saveNewUser() {
            showAlert('Новый участник успешно добавлен!', 'success');
            closeAdminModal();
            loadUsersList();
        }
        
        function editUser(id) {
            showAlert(`Редактирование пользователя ID: ${id}`, 'info');
        }
        
        function deleteUser(id) {
            if (confirm(`Вы уверены, что хотите удалить пользователя ID: ${id}?`)) {
                showAlert(`Пользователь ID: ${id} удален`, 'success');
                loadUsersList();
            }
        }
        
        function exportUsers() {
            showAlert('Экспорт данных в Excel выполнен успешно!', 'success');
        }
        
        function processBatchReadings() {
            showAlert('Пакетная обработка показаний выполнена успешно!', 'success');
            closeAdminModal();
        }
        
        function uploadReadingsFile() {
            showAlert('Файл успешно загружен!', 'success');
        }
        
        function downloadReadingsTemplate() {
            showAlert('Шаблон для заполнения загружается...', 'info');
        }
        
        function saveTariffs() {
            showAlert('Тарифы успешно сохранены!', 'success');
            closeAdminModal();
        }
        
        function generateReports() {
            showAlert('Отчеты успешно сформированы и готовы к скачиванию!', 'success');
        }
    </script>
</body>
</html>
