<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет электроэнергии</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .hidden { display: none; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Блок авторизации -->
        <div id="auth-section" class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">Вход в систему</h4>
                    </div>
                    <div class="card-body">
                        <div id="login-form">
                            <div class="mb-3">
                                <label for="login" class="form-label">Логин</label>
                                <input type="text" class="form-control" id="login" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Пароль</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <button class="btn btn-primary w-100" onclick="login()">Войти</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Личный кабинет пользователя -->
        <div id="user-dashboard" class="hidden">
            <nav class="navbar navbar-light bg-light mb-4">
                <div class="container-fluid">
                    <span class="navbar-brand">Личный кабинет</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()">Выйти</button>
                </div>
            </nav>

            <div class="row">
                <!-- Счетчики -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Мои счетчики</h5>
                        </div>
                        <div class="card-body">
                            <div id="meters-list"></div>
                            <form id="meter-reading-form">
                                <div class="mb-3">
                                    <label class="form-label">Выберите счетчик</label>
                                    <select class="form-select" id="meter-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Текущие показания</label>
                                    <input type="number" step="0.01" class="form-control" id="current-reading" required>
                                </div>
                                <button type="submit" class="btn btn-success">Передать показания</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Задолженность -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Моя задолженность</h5>
                        </div>
                        <div class="card-body">
                            <div id="debt-info">
                                <p>Загрузка...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кабинет администратора -->
        <div id="admin-dashboard" class="hidden">
            <nav class="navbar navbar-light bg-light mb-4">
                <div class="container-fluid">
                    <span class="navbar-brand">Панель администратора</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()">Выйти</button>
                </div>
            </nav>

            <ul class="nav nav-tabs" id="adminTabs">
                <li class="nav-item">
                    <button class="nav-link active" onclick="showAdminTab('tariffs')">Тарифы</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showAdminTab('users')">Пользователи</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showAdminTab('import-export')">Импорт/Экспорт</button>
                </li>
            </ul>

            <!-- Тарифы -->
            <div id="tariffs-tab" class="admin-tab">
                <h4 class="my-3">Управление тарифами</h4>
                
                <div class="card">
                    <div class="card-header">Членские взносы</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">За участок (руб)</label>
                                    <input type="number" step="0.01" class="form-control" id="membership-per-plot" value="939.00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">За сотку (руб)</label>
                                    <input type="number" step="0.01" class="form-control" id="membership-per-hundred" value="8.77">
                                </div>
                            </div>
                        </div>
                        <div class="row" id="additional-fees"></div>
                        <button class="btn btn-secondary" onclick="addFeeField()">+ Добавить сбор</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Тарифы на электроэнергию</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Потери (руб/кВт·ч)</label>
                                    <input type="number" step="0.001" class="form-control" id="loss-rate" value="0.036">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">До 100 кВт·ч (руб)</label>
                                    <input type="number" step="0.01" class="form-control" id="rate-under-100" value="6.10">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Свыше 100 кВт·ч (руб)</label>
                                    <input type="number" step="0.01" class="form-control" id="rate-over-100" value="7.30">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveTariffs()">Сохранить тарифы</button>
                    </div>
                </div>
            </div>

            <!-- Пользователи -->
            <div id="users-tab" class="admin-tab" style="display: none;">
                <h4 class="my-3">Управление пользователями</h4>
                <button class="btn btn-success mb-3" onclick="showAddUserModal()">Добавить пользователя</button>
                <div id="users-list"></div>
            </div>

            <!-- Импорт/Экспорт -->
            <div id="import-export-tab" class="admin-tab" style="display: none;">
                <h4 class="my-3">Импорт/Экспорт данных</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Экспорт данных</div>
                            <div class="card-body">
                                <button class="btn btn-primary me-2" onclick="exportData('readings')">Экспорт показаний</button>
                                <button class="btn btn-primary" onclick="exportData('users')">Экспорт пользователей</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Импорт данных</div>
                            <div class="card-body">
                                <input type="file" class="form-control mb-3" id="import-file" accept=".csv,.json">
                                <button class="btn btn-success" onclick="importData()">Импортировать</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления пользователя -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить пользователя</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-user-form">
                        <div class="mb-3">
                            <label class="form-label">Логин</label>
                            <input type="text" class="form-control" id="new-user-login" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Пароль</label>
                            <input type="password" class="form-control" id="new-user-password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Количество участков</label>
                            <input type="number" class="form-control" id="new-user-plots" value="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Количество соток</label>
                            <input type="number" step="0.01" class="form-control" id="new-user-hundreds">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Инициализация Supabase
        const SUPABASE_URL = 'https://ihydjzxctlguvflswzhg.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ2JkYnVpcXpkbXdpbml5eHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
        
        let currentUser = null
        
        // Авторизация
        async function login() {
            const login = document.getElementById('login').value
            const password = document.getElementById('password').value
            
            // Проверка администратора (для примера, в реальной системе нужно хранить в БД)
            if (login === 'admin' && password === 'admin123') {
                currentUser = { id: 0, role: 'admin', login: 'admin' }
                showAdminPanel()
                return
            }
            
            // Проверка обычного пользователя
            const { data: users, error } = await supabase
                .from('users')
                .select('*')
                .eq('login', login)
                .eq('password', password)
                .single()
            
            if (error || !users) {
                alert('Неверный логин или пароль')
                return
            }
            
            currentUser = users
            showUserPanel()
            loadUserData()
        }
        
        function logout() {
            currentUser = null
            document.getElementById('auth-section').classList.remove('hidden')
            document.getElementById('user-dashboard').classList.add('hidden')
            document.getElementById('admin-dashboard').classList.add('hidden')
        }
        
        function showUserPanel() {
            document.getElementById('auth-section').classList.add('hidden')
            document.getElementById('user-dashboard').classList.remove('hidden')
        }
        
        function showAdminPanel() {
            document.getElementById('auth-section').classList.add('hidden')
            document.getElementById('admin-dashboard').classList.remove('hidden')
            showAdminTab('tariffs')
        }
        
        // Личный кабинет
        async function loadUserData() {
            // Загрузка счетчиков пользователя
            const { data: meters } = await supabase
                .from('meters')
                .select('*')
                .eq('user_id', currentUser.id)
            
            const metersList = document.getElementById('meters-list')
            const meterSelect = document.getElementById('meter-select')
            
            metersList.innerHTML = ''
            meterSelect.innerHTML = ''
            
            if (meters && meters.length > 0) {
                meters.forEach(meter => {
                    metersList.innerHTML += `
                        <div class="border p-2 mb-2">
                            <strong>${meter.name || 'Счетчик'}</strong><br>
                            Последние показания: ${meter.last_reading || 'нет данных'}<br>
                            Дата: ${meter.last_reading_date || '—'}
                        </div>
                    `
                    
                    const option = document.createElement('option')
                    option.value = meter.id
                    option.textContent = meter.name || `Счетчик #${meter.id}`
                    meterSelect.appendChild(option)
                })
            } else {
                metersList.innerHTML = '<p>Нет зарегистрированных счетчиков</p>'
            }
            
            // Загрузка задолженности
            await calculateDebt()
        }
        
        async function calculateDebt() {
            // Расчет задолженности по формуле из задания
            const { data: tariff } = await supabase
                .from('tariffs')
                .select('*')
                .eq('type', 'electricity')
                .single()
            
            const { data: meters } = await supabase
                .from('meters')
                .select('*')
                .eq('user_id', currentUser.id)
            
            let totalElectricity = 0
            
            if (meters && tariff) {
                meters.forEach(meter => {
                    if (meter.last_reading && meter.previous_reading) {
                        const consumption = meter.last_reading - meter.previous_reading
                        let cost = 0
                        
                        if (consumption > 100) {
                            cost = (consumption - 100) * tariff.rate_over_100 + 100 * tariff.rate_under_100
                        } else {
                            cost = consumption * tariff.rate_under_100
                        }
                        
                        // Добавляем потери
                        cost += meter.previous_reading * tariff.loss_rate
                        
                        totalElectricity += cost
                    }
                })
            }
            
            // Расчет членских взносов
            const membershipFee = (currentUser.plots || 0) * 939.00 + (currentUser.hundreds || 0) * 8.77
            
            document.getElementById('debt-info').innerHTML = `
                <p><strong>Электроэнергия:</strong> ${totalElectricity.toFixed(2)} руб.</p>
                <p><strong>Членские взносы:</strong> ${membershipFee.toFixed(2)} руб.</p>
                <p><strong>Итого:</strong> ${(totalElectricity + membershipFee).toFixed(2)} руб.</p>
            `
        }
        
        // Передача показаний
        document.getElementById('meter-reading-form').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const meterId = document.getElementById('meter-select').value
            const reading = parseFloat(document.getElementById('current-reading').value)
            
            // Обновляем показания в базе
            const { data: meter } = await supabase
                .from('meters')
                .select('*')
                .eq('id', meterId)
                .single()
            
            await supabase
                .from('meter_readings')
                .insert({
                    meter_id: meterId,
                    reading: reading,
                    date: new Date().toISOString()
                })
            
            await supabase
                .from('meters')
                .update({
                    previous_reading: meter.last_reading,
                    last_reading: reading,
                    last_reading_date: new Date().toISOString()
                })
                .eq('id', meterId)
            
            alert('Показания успешно переданы!')
            document.getElementById('current-reading').value = ''
            loadUserData()
        })
        
        // Администратор
        function showAdminTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.style.display = 'none'
            })
            document.getElementById(`${tabName}-tab`).style.display = 'block'
            
            document.querySelectorAll('#adminTabs .nav-link').forEach(link => {
                link.classList.remove('active')
            })
            event.target.classList.add('active')
            
            if (tabName === 'users') {
                loadUsersList()
            }
        }
        
        async function saveTariffs() {
            const tariffs = {
                membership_per_plot: parseFloat(document.getElementById('membership-per-plot').value),
                membership_per_hundred: parseFloat(document.getElementById('membership-per-hundred').value),
                loss_rate: parseFloat(document.getElementById('loss-rate').value),
                rate_under_100: parseFloat(document.getElementById('rate-under-100').value),
                rate_over_100: parseFloat(document.getElementById('rate-over-100').value),
                updated_at: new Date().toISOString()
            }
            
            const { error } = await supabase
                .from('tariffs')
                .upsert({ type: 'electricity', ...tariffs })
            
            if (error) {
                alert('Ошибка сохранения: ' + error.message)
            } else {
                alert('Тарифы сохранены!')
            }
        }
        
        async function loadUsersList() {
            const { data: users } = await supabase
                .from('users')
                .select('*')
                .neq('login', 'admin')
            
            let html = '<table class="table"><thead><tr><th>Логин</th><th>Участки</th><th>Сотки</th><th>Действия</th></tr></thead><tbody>'
            
            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.login}</td>
                        <td>${user.plots || 0}</td>
                        <td>${user.hundreds || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})">Изменить</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Удалить</button>
                        </td>
                    </tr>
                `
            })
            
            html += '</tbody></table>'
            document.getElementById('users-list').innerHTML = html
        }
        
        function showAddUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'))
            modal.show()
        }
        
        async function addUser() {
            const userData = {
                login: document.getElementById('new-user-login').value,
                password: document.getElementById('new-user-password').value,
                plots: parseInt(document.getElementById('new-user-plots').value),
                hundreds: parseFloat(document.getElementById('new-user-hundreds').value),
                role: 'user'
            }
            
            const { error } = await supabase
                .from('users')
                .insert([userData])
            
            if (error) {
                alert('Ошибка: ' + error.message)
            } else {
                alert('Пользователь добавлен!')
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide()
                loadUsersList()
            }
        }
        
        // Импорт/экспорт
        async function exportData(type) {
            let data, filename
            
            if (type === 'readings') {
                const { data: readings } = await supabase
                    .from('meter_readings')
                    .select(`
                        *,
                        meters (name, user_id),
                        users (login)
                    `)
                data = readings
                filename = 'readings.json'
            } else {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                data = users
                filename = 'users.json'
            }
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = filename
            a.click()
        }
        
        function addFeeField() {
            const container = document.getElementById('additional-fees')
            const id = Date.now()
            container.innerHTML += `
                <div class="col-md-6" id="fee-${id}">
                    <div class="mb-3">
                        <label class="form-label">Название сбора</label>
                        <input type="text" class="form-control" placeholder="Например: Ремонт дороги">
                        <label class="form-label mt-2">Сумма (руб)</label>
                        <input type="number" step="0.01" class="form-control" value="0">
                        <button class="btn btn-sm btn-danger mt-2" onclick="document.getElementById('fee-${id}').remove()">Удалить</button>
                    </div>
                </div>
            `
        }
        
        // Проверка авторизации при загрузке
        window.onload = function() {
            // Проверяем, есть ли сохраненная сессия
            const savedUser = localStorage.getItem('currentUser')
            if (savedUser) {
                currentUser = JSON.parse(savedUser)
                if (currentUser.role === 'admin') {
                    showAdminPanel()
                } else {
                    showUserPanel()
                    loadUserData()
                }
            }
        }
    </script>
</body>
</html>
