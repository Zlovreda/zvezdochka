<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СНТ "Звездочка" - Учет электроэнергии и взносов</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .app-status {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }
        
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            border-bottom-color: #007bff;
            background: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .auth-section {
            max-width: 400px;
            margin: 40px auto;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .btn {
            padding: 12px 25px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            width: 100%;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #bd2130;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .card h3 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .meter-reading {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .payment-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .payment-total {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #dee2e6;
        }
        
        .admin-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,123,255,0.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
                border-bottom: none;
                border-right: 3px solid transparent;
            }
            
            .tab.active {
                border-right-color: #007bff;
                border-bottom: none;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>СНТ "Звездочка"</h1>
            <p>Учет электроэнергии и членских взносов</p>
        </header>
        
        <div class="app-status">
            <div id="supabaseStatus">
                <span class="loading"></span> Проверка подключения к Supabase...
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="login">Вход</div>
            <div class="tab" data-tab="user-dashboard" id="userTab">Личный кабинет</div>
            <div class="tab" data-tab="meter-reading">Показания счетчиков</div>
            <div class="tab" data-tab="payments">Платежи</div>
            <div class="tab" data-tab="admin" id="adminTab">Админ-панель</div>
            <div class="tab" data-tab="api-test">Тест API</div>
        </div>
        
        <!-- Вход/Регистрация -->
        <div id="login" class="tab-content active">
            <div class="auth-section">
                <h2 style="text-align: center; margin-bottom: 20px;">Вход в систему</h2>
                
                <div id="authError" class="alert alert-error hidden"></div>
                
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="ваш@email.com">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword" placeholder="Ваш пароль">
                </div>
                
                <button class="btn" onclick="login()">Войти</button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <p>Нет аккаунта? <a href="#" onclick="showRegister()">Зарегистрироваться</a></p>
                </div>
            </div>
            
            <div class="auth-section hidden" id="registerSection">
                <h2 style="text-align: center; margin-bottom: 20px;">Регистрация</h2>
                
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" placeholder="ваш@email.com">
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Пароль (мин. 6 символов):</label>
                    <input type="password" id="registerPassword" placeholder="Придумайте пароль">
                </div>
                
                <div class="form-group">
                    <label for="registerFullName">ФИО:</label>
                    <input type="text" id="registerFullName" placeholder="Иванов Иван Иванович">
                </div>
                
                <div class="form-group">
                    <label for="registerPlotNumber">Номер участка:</label>
                    <input type="text" id="registerPlotNumber" placeholder="Например: 15">
                </div>
                
                <button class="btn btn-success" onclick="register()">Зарегистрироваться</button>
                <button class="btn" onclick="hideRegister()" style="margin-top: 10px;">Отмена</button>
            </div>
        </div>
        
        <!-- Личный кабинет пользователя -->
        <div id="user-dashboard" class="tab-content">
            <div class="user-info">
                <h3 id="userGreeting">Добро пожаловать!</h3>
                <p>Участок №<span id="userPlotNumber">-</span></p>
                <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px; width: auto;">Выйти</button>
            </div>
            
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Текущие показания</h3>
                    <div id="currentReadings">
                        <p>Загрузка данных...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Последние платежи</h3>
                    <div id="recentPayments">
                        <p>Загрузка данных...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Тарифы на электроэнергию</h3>
                    <div id="currentTariffs">
                        <p>Потери: <span id="tariffLoss">-</span> руб/кВт·ч</p>
                        <p>До 100 кВт·ч: <span id="tariffLow">-</span> руб/кВт·ч</p>
                        <p>Свыше 100 кВт·ч: <span id="tariffHigh">-</span> руб/кВт·ч</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Членские взносы</h3>
                    <div id="membershipFeesInfo">
                        <p>Взнос с зарплаты: <span id="salaryFee">-</span> руб</p>
                        <p>Содержание: <span id="maintenanceFee">-</span> руб/сотку</p>
                        <p>Площадь участка: <span id="plotArea">-</span> соток</p>
                    </div>
                </div>
            </div>
            
            <div class="payment-summary">
                <h3>Итог к оплате за текущий месяц</h3>
                <div id="paymentCalculation">
                    <p>Расчет производится...</p>
                </div>
            </div>
        </div>
        
        <!-- Внесение показаний -->
        <div id="meter-reading" class="tab-content">
            <div class="card">
                <h3>Внесение показаний счетчиков</h3>
                <p>Текущий месяц: <span id="currentMonth">Январь 2026</span></p>
                
                <div id="meterForms"></div>
                
                <button class="btn btn-success" onclick="submitReadings()">Отправить показания</button>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>История показаний</h3>
                <div id="readingHistory">
                    <p>Загрузка истории...</p>
                </div>
            </div>
        </div>
        
        <!-- Платежи -->
        <div id="payments" class="tab-content">
            <div class="card">
                <h3>История платежей</h3>
                <div id="paymentHistory">
                    <p>Загрузка данных...</p>
                </div>
            </div>
        </div>
        
        <!-- Админ-панель -->
        <div id="admin" class="tab-content">
            <div class="admin-panel">
                <h2>Административная панель</h2>
                
                <div class="tabs" style="margin: 20px 0; background: none; border: none;">
                    <div class="tab active" data-subtab="users">Пользователи</div>
                    <div class="tab" data-subtab="tariffs">Тарифы</div>
                    <div class="tab" data-subtab="bulk">Пакетная обработка</div>
                </div>
                
                <div id="adminUsers" class="admin-subtab active">
                    <h3>Управление пользователями</h3>
                    <div id="usersTable"></div>
                </div>
                
                <div id="adminTariffs" class="admin-subtab">
                    <h3>Управление тарифами</h3>
                    <div class="card">
                        <h4>Текущие тарифы</h4>
                        <div id="adminTariffsInfo"></div>
                        
                        <h4 style="margin-top: 20px;">Установить новые тарифы</h4>
                        <div class="form-group">
                            <label>Тариф "Потери":</label>
                            <input type="number" id="adminTariffLoss" step="0.01" placeholder="0.36">
                        </div>
                        <div class="form-group">
                            <label>Тариф до 100 кВт·ч:</label>
                            <input type="number" id="adminTariffLow" step="0.01" placeholder="6.10">
                        </div>
                        <div class="form-group">
                            <label>Тариф свыше 100 кВт·ч:</label>
                            <input type="number" id="adminTariffHigh" step="0.01" placeholder="7.30">
                        </div>
                        <button class="btn" onclick="updateTariffs()">Обновить тарифы</button>
                    </div>
                </div>
                
                <div id="adminBulk" class="admin-subtab">
                    <h3>Пакетная обработка</h3>
                    <div class="card">
                        <h4>Загрузка данных</h4>
                        <div class="form-group">
                            <label>Выберите тип данных:</label>
                            <select id="bulkDataType">
                                <option value="readings">Показания счетчиков</option>
                                <option value="payments">Платежи</option>
                                <option value="users">Пользователи</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Данные (JSON формат):</label>
                            <textarea id="bulkData" rows="10" placeholder='[{"user_id": "xxx", "reading": 100, "month": "2026-01"}]'></textarea>
                        </div>
                        <button class="btn btn-success" onclick="bulkUpload()">Загрузить данные</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Тест API -->
        <div id="api-test" class="tab-content">
            <div class="card">
                <h3>Тестирование Supabase API</h3>
                
                <div class="form-group">
                    <label>Выберите тест:</label>
                    <select id="testSelect" onchange="runSelectedTest()">
                        <option value="">Выберите тест...</option>
                        <option value="connection">Проверка подключения</option>
                        <option value="rest">REST API</option>
                        <option value="auth">Auth API</option>
                        <option value="tables">Получить список таблиц</option>
                    </select>
                </div>
                
                <div id="testResults" class="alert alert-info">
                    Результаты тестов будут отображены здесь
                </div>
                
                <button class="btn" onclick="runAllTests()">Запустить все тесты</button>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ2JkYnVpcXpkbXdpbml5eHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU';
        
        // Глобальные переменные
        let currentUser = null;
        let userProfile = null;
        let currentMonth = new Date().toLocaleString('ru-RU', { month: 'long', year: 'numeric' });
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
            // Настройка вкладок
            setupTabs();
            
            // Проверка подключения к Supabase
            await checkSupabaseConnection();
            
            // Проверка авторизации
            await checkAuth();
            
            // Обновление месяца
            document.getElementById('currentMonth').textContent = currentMonth;
        });
        
        // Настройка системы вкладок
        function setupTabs() {
            // Основные вкладки
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Скрыть все вкладки
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Убрать активный класс у всех вкладок
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Показать выбранную вкладку
                    document.getElementById(tabId).classList.add('active');
                    tab.classList.add('active');
                });
            });
            
            // Вкладки админ-панели
            document.querySelectorAll('[data-subtab]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const subtabId = tab.getAttribute('data-subtab');
                    
                    // Скрыть все подвкладки
                    document.querySelectorAll('.admin-subtab').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Убрать активный класс у всех подвкладок
                    document.querySelectorAll('[data-subtab]').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Показать выбранную подвкладку
                    document.getElementById('admin' + subtabId.charAt(0).toUpperCase() + subtabId.slice(1)).classList.add('active');
                    tab.classList.add('active');
                });
            });
        }
        
        // Проверка подключения к Supabase
        async function checkSupabaseConnection() {
            const statusElement = document.getElementById('supabaseStatus');
            
            try {
                // Тест REST API [citation:1]
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    statusElement.innerHTML = '<span class="status-online">✓ Supabase подключен и работает</span>';
                    console.log('Supabase подключен успешно');
                    
                    // Тест получения данных о таблицах
                    const data = await response.json();
                    console.log('Доступные таблицы:', Object.keys(data.paths || {}));
                    
                } else {
                    statusElement.innerHTML = '<span class="status-offline">✗ Ошибка подключения к Supabase</span>';
                    console.error('Ошибка Supabase:', await response.text());
                }
            } catch (error) {
                statusElement.innerHTML = '<span class="status-offline">✗ Не удалось подключиться к Supabase</span>';
                console.error('Ошибка подключения:', error);
            }
        }
        
        // Проверка авторизации
        async function checkAuth() {
            try {
                // Проверяем сохраненную сессию
                const token = localStorage.getItem('supabase_auth_token');
                
                if (token) {
                    // В реальном приложении здесь должна быть проверка токена через Supabase Auth
                    // Для демо-версии используем упрощенную проверку
                    const userEmail = localStorage.getItem('user_email');
                    const userProfileData = localStorage.getItem('user_profile');
                    
                    if (userEmail && userProfileData) {
                        currentUser = { email: userEmail };
                        userProfile = JSON.parse(userProfileData);
                        
                        // Обновляем интерфейс
                        updateUIForLoggedInUser();
                        return true;
                    }
                }
            } catch (error) {
                console.error('Ошибка проверки авторизации:', error);
            }
            
            return false;
        }
        
        // Вход пользователя
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('authError');
            
            // Валидация
            if (!email || !password) {
                errorElement.textContent = 'Пожалуйста, заполните все поля';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // В реальном приложении здесь должен быть вызов Supabase Auth
            // Для демо-версии используем заглушку
            try {
                // Имитация загрузки
                errorElement.classList.add('hidden');
                
                // В реальном приложении:
                // const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                
                // Для демо: создаем тестового пользователя
                currentUser = { email: email };
                userProfile = {
                    id: 'demo-user-id',
                    full_name: 'Иванов Иван Иванович',
                    plot_number: '15',
                    plot_area: 6,
                    role: 'user',
                    created_at: new Date().toISOString()
                };
                
                // Сохраняем в localStorage
                localStorage.setItem('supabase_auth_token', 'demo-token-' + Date.now());
                localStorage.setItem('user_email', email);
                localStorage.setItem('user_profile', JSON.stringify(userProfile));
                
                // Обновляем интерфейс
                updateUIForLoggedInUser();
                
                // Переключаем на личный кабинет
                document.querySelector('[data-tab="user-dashboard"]').click();
                
            } catch (error) {
                errorElement.textContent = 'Ошибка входа: ' + error.message;
                errorElement.classList.remove('hidden');
            }
        }
        
        // Регистрация пользователя
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const fullName = document.getElementById('registerFullName').value;
            const plotNumber = document.getElementById('registerPlotNumber').value;
            
            // Валидация
            if (!email || !password || !fullName || !plotNumber) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            if (password.length < 6) {
                alert('Пароль должен содержать минимум 6 символов');
                return;
            }
            
            // В реальном приложении здесь должен быть вызов Supabase Auth и создание записи в profiles
            // Для демо-версии используем заглушку
            try {
                // Имитация успешной регистрации
                currentUser = { email: email };
                userProfile = {
                    id: 'new-user-' + Date.now(),
                    full_name: fullName,
                    plot_number: plotNumber,
                    plot_area: 6, // По умолчанию 6 соток
                    role: 'user',
                    created_at: new Date().toISOString()
                };
                
                // Сохраняем
                localStorage.setItem('supabase_auth_token', 'demo-token-' + Date.now());
                localStorage.setItem('user_email', email);
                localStorage.setItem('user_profile', JSON.stringify(userProfile));
                
                alert('Регистрация успешна! Теперь вы можете войти в систему.');
                hideRegister();
                document.getElementById('loginEmail').value = email;
                document.getElementById('loginPassword').value = '';
                
            } catch (error) {
                alert('Ошибка регистрации: ' + error.message);
            }
        }
        
        // Выход из системы
        function logout() {
            currentUser = null;
            userProfile = null;
            
            // Очищаем localStorage
            localStorage.removeItem('supabase_auth_token');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_profile');
            
            // Обновляем интерфейс
            updateUIForLoggedOutUser();
            
            // Переключаем на вкладку входа
            document.querySelector('[data-tab="login"]').click();
        }
        
        // Обновление интерфейса для авторизованного пользователя
        function updateUIForLoggedInUser() {
            // Обновляем приветствие
            document.getElementById('userGreeting').textContent = `Добро пожаловать, ${userProfile.full_name}!`;
            document.getElementById('userPlotNumber').textContent = userProfile.plot_number;
            
            // Показываем вкладки пользователя
            document.getElementById('userTab').style.display = 'block';
            
            // Если пользователь админ, показываем админ-панель
            if (userProfile.role === 'admin') {
                document.getElementById('adminTab').style.display = 'block';
            } else {
                document.getElementById('adminTab').style.display = 'none';
            }
            
            // Загружаем данные пользователя
            loadUserData();
        }
        
        // Обновление интерфейса для неавторизованного пользователя
        function updateUIForLoggedOutUser() {
            // Скрываем вкладки пользователя
            document.getElementById('userTab').style.display = 'none';
            document.getElementById('adminTab').style.display = 'none';
        }
        
        // Загрузка данных пользователя
        async function loadUserData() {
            if (!currentUser) return;
            
            // Загружаем тарифы
            await loadTariffs();
            
            // Загружаем показания
            await loadMeterReadings();
            
            // Загружаем платежи
            await loadPayments();
            
            // Расчет суммы к оплате
            calculatePayment();
        }
        
        // Загрузка тарифов
        async function loadTariffs() {
            try {
                // В реальном приложении здесь запрос к Supabase
                // Для демо используем заглушку
                const tariffs = {
                    loss_tariff: 0.36,
                    low_tariff: 6.10,
                    high_tariff: 7.30,
                    salary_fee: 939.00,
                    maintenance_per_sotka: 44.00,
                    effective_date: '2026-01-01'
                };
                
                // Обновляем интерфейс
                document.getElementById('tariffLoss').textContent = tariffs.loss_tariff;
                document.getElementById('tariffLow').textContent = tariffs.low_tariff;
                document.getElementById('tariffHigh').textContent = tariffs.high_tariff;
                document.getElementById('salaryFee').textContent = tariffs.salary_fee;
                document.getElementById('maintenanceFee').textContent = tariffs.maintenance_per_sotka;
                document.getElementById('plotArea').textContent = userProfile.plot_area || 6;
                
                // Для админ-панели
                document.getElementById('adminTariffsInfo').innerHTML = `
                    <p>Потери: ${tariffs.loss_tariff} руб/кВт·ч</p>
                    <p>До 100 кВт·ч: ${tariffs.low_tariff} руб/кВт·ч</p>
                    <p>Свыше 100 кВт·ч: ${tariffs.high_tariff} руб/кВт·ч</p>
                    <p>Действуют с: ${tariffs.effective_date}</p>
                `;
                
            } catch (error) {
                console.error('Ошибка загрузки тарифов:', error);
            }
        }
        
        // Загрузка показаний счетчиков
        async function loadMeterReadings() {
            try {
                // В реальном приложении здесь запрос к Supabase
                // Для демо создаем тестовые данные
                const readings = [
                    {
                        id: 1,
                        meter_number: 'СЧ-001',
                        previous_reading: 1500,
                        current_reading: null,
                        month: currentMonth,
                        consumption: null
                    },
                    {
                        id: 2,
                        meter_number: 'СЧ-002',
                        previous_reading: 2300,
                        current_reading: null,
                        month: currentMonth,
                        consumption: null
                    }
                ];
                
                // Обновляем интерфейс текущих показаний
                let readingsHtml = '';
                readings.forEach(reading => {
                    readingsHtml += `
                        <div class="meter-reading">
                            <p><strong>Счетчик ${reading.meter_number}</strong></p>
                            <p>Предыдущее показание: ${reading.previous_reading} кВт·ч</p>
                            <p>Текущее показание: ${reading.current_reading || 'не внесено'}</p>
                        </div>
                    `;
                });
                
                document.getElementById('currentReadings').innerHTML = readingsHtml;
                
                // Создаем формы для внесения показаний
                let formsHtml = '';
                readings.forEach((reading, index) => {
                    formsHtml += `
                        <div class="form-group">
                            <label for="meter${index}">Счетчик ${reading.meter_number} (предыдущее: ${reading.previous_reading} кВт·ч):</label>
                            <input type="number" id="meter${index}" placeholder="Текущее показание" min="${reading.previous_reading}">
                        </div>
                    `;
                });
                
                document.getElementById('meterForms').innerHTML = formsHtml;
                
                // Загружаем историю (демо-данные)
                const history = [
                    { month: 'Декабрь 2025', reading: 1500, consumption: 200, amount: 1460.00 },
                    { month: 'Ноябрь 2025', reading: 1300, consumption: 180, amount: 1314.00 },
                    { month: 'Октябрь 2025', reading: 1120, consumption: 150, amount: 1095.00 }
                ];
                
                let historyHtml = '<table class="data-table">';
                historyHtml += '<tr><th>Месяц</th><th>Показание</th><th>Расход</th><th>Сумма</th></tr>';
                history.forEach(item => {
                    historyHtml += `<tr>
                        <td>${item.month}</td>
                        <td>${item.reading} кВт·ч</td>
                        <td>${item.consumption} кВт·ч</td>
                        <td>${item.amount.toFixed(2)} руб</td>
                    </tr>`;
                });
                historyHtml += '</table>';
                
                document.getElementById('readingHistory').innerHTML = historyHtml;
                
            } catch (error) {
                console.error('Ошибка загрузки показаний:', error);
            }
        }
        
        // Загрузка платежей
        async function loadPayments() {
            try {
                // Демо-данные
                const payments = [
                    { month: 'Декабрь 2025', electricity: 1460.00, membership: 1203.00, total: 2663.00, status: 'оплачен' },
                    { month: 'Ноябрь 2025', electricity: 1314.00, membership: 1203.00, total: 2517.00, status: 'оплачен' },
                    { month: 'Октябрь 2025', electricity: 1095.00, membership: 1203.00, total: 2298.00, status: 'оплачен' }
                ];
                
                // Обновляем историю платежей
                let paymentHtml = '<table class="data-table">';
                paymentHtml += '<tr><th>Месяц</th><th>Электричество</th><th>Взносы</th><th>Итого</th><th>Статус</th></tr>';
                payments.forEach(payment => {
                    paymentHtml += `<tr>
                        <td>${payment.month}</td>
                        <td>${payment.electricity.toFixed(2)} руб</td>
                        <td>${payment.membership.toFixed(2)} руб</td>
                        <td>${payment.total.toFixed(2)} руб</td>
                        <td><span style="color: green;">${payment.status}</span></td>
                    </tr>`;
                });
                paymentHtml += '</table>';
                
                document.getElementById('paymentHistory').innerHTML = paymentHtml;
                
                // Обновляем последние платежи
                document.getElementById('recentPayments').innerHTML = `
                    <p>Декабрь 2025: ${payments[0].total.toFixed(2)} руб (оплачен)</p>
                    <p>Ноябрь 2025: ${payments[1].total.toFixed(2)} руб (оплачен)</p>
                `;
                
            } catch (error) {
                console.error('Ошибка загрузки платежей:', error);
            }
        }
        
        // Расчет суммы к оплате
        function calculatePayment() {
            // Получаем введенные показания
            const meterInputs = document.querySelectorAll('#meterForms input');
            let totalConsumption = 0;
            
            meterInputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value) && value > 0) {
                    // В реальном приложении здесь расчет расхода на основе предыдущих показаний
                    totalConsumption += 200; // Демо-значение
                }
            });
            
            // Если показания не внесены, используем среднее значение
            if (totalConsumption === 0) {
                totalConsumption = 200;
            }
            
            // Расчет стоимости электроэнергии по сложному тарифу
            const lossTariff = parseFloat(document.getElementById('tariffLoss').textContent) || 0.36;
            const lowTariff = parseFloat(document.getElementById('tariffLow').textContent) || 6.10;
            const highTariff = parseFloat(document.getElementById('tariffHigh').textContent) || 7.30;
            
            // Расчет по формуле: потери + до 100 кВт·ч + свыше 100 кВт·ч
            let electricityCost = 0;
            
            // 1. Потери (вся потребленная энергия)
            electricityCost += totalConsumption * lossTariff;
            
            // 2. До 100 кВт·ч
            const lowConsumption = Math.min(totalConsumption, 100);
            electricityCost += lowConsumption * lowTariff;
            
            // 3. Свыше 100 кВт·ч
            if (totalConsumption > 100) {
                const highConsumption = totalConsumption - 100;
                electricityCost += highConsumption * highTariff;
            }
            
            // Расчет членских взносов
            const salaryFee = parseFloat(document.getElementById('salaryFee').textContent) || 939.00;
            const maintenancePerSotka = parseFloat(document.getElementById('maintenanceFee').textContent) || 44.00;
            const plotArea = parseFloat(document.getElementById('plotArea').textContent) || 6;
            
            const membershipCost = salaryFee + (maintenancePerSotka * plotArea);
            
            // Итоговая сумма
            const totalCost = electricityCost + membershipCost;
            
            // Обновляем интерфейс
            document.getElementById('paymentCalculation').innerHTML = `
                <div class="payment-item">
                    <span>Электроэнергия (${totalConsumption} кВт·ч):</span>
                    <span>${electricityCost.toFixed(2)} руб</span>
                </div>
                <div class="payment-item">
                    <span>Членские взносы (${plotArea} соток):</span>
                    <span>${membershipCost.toFixed(2)} руб</span>
                </div>
                <div class="payment-item payment-total">
                    <span>ИТОГО К ОПЛАТЕ:</span>
                    <span>${totalCost.toFixed(2)} руб</span>
                </div>
            `;
        }
        
        // Отправка показаний
        async function submitReadings() {
            if (!currentUser) {
                alert('Пожалуйста, войдите в систему');
                return;
            }
            
            const meterInputs = document.querySelectorAll('#meterForms input');
            let hasReadings = false;
            const readings = [];
            
            meterInputs.forEach((input, index) => {
                const value = parseFloat(input.value);
                if (!isNaN(value) && value > 0) {
                    hasReadings = true;
                    readings.push({
                        meter_number: `СЧ-00${index + 1}`,
                        reading: value,
                        date: new Date().toISOString()
                    });
                }
            });
            
            if (!hasReadings) {
                alert('Пожалуйста, введите показания хотя бы одного счетчика');
                return;
            }
            
            // В реальном приложении здесь отправка данных в Supabase
            alert(`Показания успешно отправлены! Внесено показаний: ${readings.length}`);
            
            // Обновляем расчет
            calculatePayment();
            
            // Очищаем поля
            meterInputs.forEach(input => input.value = '');
        }
        
        // Обновление тарифов (админ)
        async function updateTariffs() {
            if (!currentUser || userProfile.role !== 'admin') {
                alert('Доступно только администраторам');
                return;
            }
            
            const lossTariff = parseFloat(document.getElementById('adminTariffLoss').value);
            const lowTariff = parseFloat(document.getElementById('adminTariffLow').value);
            const highTariff = parseFloat(document.getElementById('adminTariffHigh').value);
            
            if (isNaN(lossTariff) || isNaN(lowTariff) || isNaN(highTariff)) {
                alert('Пожалуйста, введите корректные значения тарифов');
                return;
            }
            
            // В реальном приложении здесь сохранение в Supabase
            alert(`Тарифы успешно обновлены!
Потери: ${lossTariff} руб/кВт·ч
До 100 кВт·ч: ${lowTariff} руб/кВт·ч
Свыше 100 кВт·ч: ${highTariff} руб/кВт·ч`);
            
            // Обновляем отображение
            loadTariffs();
        }
        
        // Пакетная загрузка данных (админ)
        async function bulkUpload() {
            if (!currentUser || userProfile.role !== 'admin') {
                alert('Доступно только администраторам');
                return;
            }
            
            const dataType = document.getElementById('bulkDataType').value;
            const dataText = document.getElementById('bulkData').value;
            
            if (!dataText.trim()) {
                alert('Пожалуйста, введите данные');
                return;
            }
            
            try {
                const data = JSON.parse(dataText);
                
                // В реальном приложении здесь обработка и загрузка в Supabase
                alert(`Успешно загружено ${data.length} записей типа "${dataType}"`);
                
                // Очищаем поле
                document.getElementById('bulkData').value = '';
                
            } catch (error) {
                alert('Ошибка парсинга JSON: ' + error.message);
            }
        }
        
        // Показать форму регистрации
        function showRegister() {
            document.getElementById('registerSection').classList.remove('hidden');
        }
        
        // Скрыть форму регистрации
        function hideRegister() {
            document.getElementById('registerSection').classList.add('hidden');
        }
        
        // Запуск тестов API
        async function runSelectedTest() {
            const testType = document.getElementById('testSelect').value;
            if (!testType) return;
            
            await runTest(testType);
        }
        
        async function runAllTests() {
            const tests = ['connection', 'rest', 'auth', 'tables'];
            const results = [];
            
            for (const test of tests) {
                const result = await runTest(test);
                results.push(result);
            }
            
            document.getElementById('testResults').innerHTML = `
                <h4>Результаты всех тестов:</h4>
                <pre>${JSON.stringify(results, null, 2)}</pre>
            `;
        }
        
        async function runTest(testType) {
            const resultsElement = document.getElementById('testResults');
            let result = { test: testType, status: 'unknown', message: '' };
            
            try {
                switch (testType) {
                    case 'connection':
                        // Проверка базового подключения
                        const response = await fetch(SUPABASE_URL, {
                            headers: { 'apikey': SUPABASE_ANON_KEY }
                        });
                        
                        if (response.ok) {
                            result.status = 'success';
                            result.message = 'Подключение к Supabase успешно';
                        } else {
                            result.status = 'error';
                            result.message = `Ошибка подключения: ${response.status}`;
                        }
                        break;
                        
                    case 'rest':
                        // Проверка REST API [citation:1]
                        const restResponse = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        
                        if (restResponse.ok) {
                            const data = await restResponse.json();
                            result.status = 'success';
                            result.message = `REST API работает. Обнаружено таблиц: ${Object.keys(data.paths || {}).length}`;
                        } else {
                            result.status = 'error';
                            result.message = `Ошибка REST API: ${restResponse.status}`;
                        }
                        break;
                        
                    case 'auth':
                        // Проверка Auth API
                        const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/health`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY
                            }
                        });
                        
                        if (authResponse.ok || authResponse.status === 404) {
                            result.status = 'success';
                            result.message = 'Auth API доступен';
                        } else {
                            result.status = 'error';
                            result.message = `Ошибка Auth API: ${authResponse.status}`;
                        }
                        break;
                        
                    case 'tables':
                        // Получение списка таблиц через REST API
                        const tablesResponse = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        
                        if (tablesResponse.ok) {
                            const data = await tablesResponse.json();
                            const tables = Object.keys(data.paths || {})
                                .filter(path => !path.startsWith('/'))
                                .map(path => path.replace('/', ''));
                            
                            result.status = 'success';
                            result.message = `Доступные таблицы: ${tables.join(', ') || 'не обнаружены'}`;
                        } else {
                            result.status = 'error';
                            result.message = `Не удалось получить список таблиц: ${tablesResponse.status}`;
                        }
                        break;
                }
            } catch (error) {
                result.status = 'error';
                result.message = `Исключение: ${error.message}`;
            }
            
            // Отображаем результат
            const statusClass = result.status === 'success' ? 'alert-success' : 
                              result.status === 'error' ? 'alert-error' : 'alert-info';
            
            resultsElement.innerHTML = `
                <div class="alert ${statusClass}">
                    <strong>Тест: ${testType}</strong><br>
                    Статус: ${result.status}<br>
                    Сообщение: ${result.message}
                </div>
            `;
            
            return result;
        }
    </script>
</body>
</html>
