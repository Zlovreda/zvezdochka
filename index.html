<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ù–¢ "–ó–≤–µ–∑–¥–æ—á–∫–∞" - –£—á—ë—Ç –ø–æ–∫–∞–∑–∞–Ω–∏–π</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f2f5; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #3b82f6; }
        h1 { color: #3b82f6; }
        h2 { color: #4b5563; margin: 25px 0 15px; }
        .hidden { display: none !important; }
        #app { min-height: 400px; }
        .card { background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 20px; }
        .btn {
            background-color: #3b82f6; color: white; border: none; padding: 12px 24px;
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s;
            margin: 5px;
        }
        .btn:hover { background-color: #2563eb; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #10b981; }
        .btn-success:hover { background-color: #059669; }
        input, select {
            width: 100%; padding: 12px; margin: 8px 0 20px; border: 1px solid #d1d5db;
            border-radius: 6px; font-size: 16px;
        }
        label { font-weight: 600; display: block; margin-top: 10px; }
        .alert {
            padding: 15px; border-radius: 6px; margin: 20px 0;
        }
        .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-info { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #ddd; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tabs { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #3b82f6; font-weight: bold; color: #3b82f6; }
        .status-bar { background: #1e293b; color: white; padding: 10px 20px; border-radius: 6px; margin-bottom: 20px; font-family: monospace; font-size: 14px; }
        .status-up { color: #10b981; }
        .status-down { color: #ef4444; }
        .user-info { background: #eff6ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { background-color: #f8fafc; font-weight: 600; }
        .admin-panel { background: #fef3c7; border-left-color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–°–ù–¢ "–ó–≤–µ–∑–¥–æ—á–∫–∞"</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –∏ —á–ª–µ–Ω—Å–∫–∏—Ö –≤–∑–Ω–æ—Å–æ–≤</p>
            <div id="connectionStatus" class="status-bar">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase...</div>
        </header>

        <!-- –≠–∫—Ä–∞–Ω—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
        <div id="authScreen">
            <div class="tabs">
                <div class="tab active" onclick="showTab('login')">–í—Ö–æ–¥</div>
                <div class="tab" onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            <div id="loginTab" class="tab-content">
                <h2>–í—Ö–æ–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
                <div id="authMessage" class="alert hidden"></div>
                <form id="loginForm">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required placeholder="–≤–∞—à@email.com">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" required placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
                    <button type="submit" class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
                </form>
                <p style="margin-top: 15px; font-size: 0.9em; color: #6b7280;">
                    –î–ª—è —Ç–µ—Å—Ç–∞: –∞–¥–º–∏–Ω <code>admin@zvezdochka.local</code> / –ø–∞—Ä–æ–ª—å: <code>admin123</code><br>
                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>user@zvezdochka.local</code> / –ø–∞—Ä–æ–ª—å: <code>user123</code>
                </p>
            </div>
            <div id="registerTab" class="tab-content hidden">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <form id="registerForm">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" required>
                    <label for="regPassword">–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤):</label>
                    <input type="password" id="regPassword" required minlength="6">
                    <label for="fullName">–§–ò–û:</label>
                    <input type="text" id="fullName" required>
                    <label for="plotNumber">–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞:</label>
                    <input type="text" id="plotNumber" required>
                    <label for="plotArea">–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞ (—Å–æ—Ç–æ–∫):</label>
                    <input type="number" id="plotArea" value="6" min="1" step="0.01" required>
                    <button type="submit" class="btn btn-success" id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </form>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
        <div id="appScreen" class="hidden">
            <div class="user-info">
                –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong id="currentUserName"></strong> (<span id="currentUserRole"></span>)
                <button onclick="logout()" class="btn btn-danger" style="float:right;">–í—ã–π—Ç–∏</button>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
            <div id="adminPanel" class="card admin-panel hidden">
                <h2>ü§ñ –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞–º–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.</p>
                <div class="tabs">
                    <div class="tab active" onclick="showAdminTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                    <div class="tab" onclick="showAdminTab('tariffs')">–¢–∞—Ä–∏—Ñ—ã</div>
                    <div class="tab" onclick="showAdminTab('batch')">–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</div>
                </div>
                <div id="adminUsersTab" class="admin-tab-content">
                    <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>Email</th><th>–§–ò–û</th><th>–£—á–∞—Å—Ç–æ–∫</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                        <tbody id="usersList"></tbody>
                    </table>
                </div>
                <div id="adminTariffsTab" class="admin-tab-content hidden">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏</h3>
                    <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä—ë—Ö—Å—Ç–∞–≤–æ—á–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –Ω–∞ –º–µ—Å—è—Ü.</p>
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ -->
                </div>
                <div id="adminBatchTab" class="admin-tab-content hidden">
                    <h3>–ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞/–≤—ã–≥—Ä—É–∑–∫–∞</h3>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ Excel/CSV —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–∫–∞–∑–∞–Ω–∏—è–º–∏.</p>
                </div>
            </div>

            <!-- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div id="userPanel" class="card hidden">
                <h2>üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
                <div class="tabs">
                    <div class="tab active" onclick="showUserTab('meters')">–ü–æ–∫–∞–∑–∞–Ω–∏—è</div>
                    <div class="tab" onclick="showUserTab('fees')">–í–∑–Ω–æ—Å—ã</div>
                    <div class="tab" onclick="showUserTab('history')">–ò—Å—Ç–æ—Ä–∏—è</div>
                </div>
                <div id="userMetersTab" class="user-tab-content">
                    <h3>–ü–µ—Ä–µ–¥–∞—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ—Å—á—ë—Ç—á–∏–∫–æ–≤</h3>
                    <p>–£ –≤–∞—Å <span id="metersCount">1</span> —Å—á—ë—Ç—á–∏–∫(–æ–≤).</p>
                    <form id="meterReadingForm">
                        <label for="currentReading">–¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è (–∫–í—Ç¬∑—á):</label>
                        <input type="number" id="currentReading" step="0.01" min="0" required>
                        <label for="readingMonth">–ó–∞ –º–µ—Å—è—Ü:</label>
                        <select id="readingMonth">
                            <!-- –û–ø—Ü–∏–∏ –º–µ—Å—è—Ü–µ–≤ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                        </select>
                        <button type="submit" class="btn btn-success">–ü–µ—Ä–µ–¥–∞—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è</button>
                    </form>
                    <div id="calculationResult" class="alert alert-info hidden"></div>
                </div>
                <div id="userFeesTab" class="user-tab-content hidden">
                    <h3>–ß–ª–µ–Ω—Å–∫–∏–µ –≤–∑–Ω–æ—Å—ã –∫ –æ–ø–ª–∞—Ç–µ</h3>
                    <p>–†–∞—Å—Å—á—ë—Ç –∑–∞ <select id="feesMonth"></select></p>
                    <div class="alert">
                        <h4>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: <span id="totalFee">0.00</span> —Ä—É–±.</h4>
                        <ul style="margin-top: 10px;">
                            <li>–ó–∞—Ä–ø–ª–∞—Ç–∞ (939 —Ä—É–±. —Å —É—á–∞—Å—Ç–∫–∞): <span id="salaryFee">939.00</span> —Ä—É–±.</li>
                            <li>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (44 —Ä—É–±./—Å–æ—Ç–∫—É): <span id="maintenanceFee">264.00</span> —Ä—É–±.</li>
                            <li>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å 1: <span id="extraFee1">0.00</span> —Ä—É–±.</li>
                        </ul>
                    </div>
                </div>
                <div id="userHistoryTab" class="user-tab-content hidden">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∏ –ø–æ–∫–∞–∑–∞–Ω–∏–π</h3>
                    <table class="data-table">
                        <thead><tr><th>–ú–µ—Å—è—Ü</th><th>–ü–æ–∫–∞–∑–∞–Ω–∏—è</th><th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
                        <tbody id="paymentHistory"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="testPanel" class="card">
            <h2>üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Supabase</h2>
            <p>URL: <code id="supabaseUrl">https://chgbdbuiqzdmwiniyxrk.supabase.co</code></p>
            <button onclick="testConnection()" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
            <button onclick="testRestApi()" class="btn">–¢–µ—Å—Ç REST API</button>
            <button onclick="testAuth()" class="btn">–¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</button>
            <div id="testResults" style="margin-top:15px;"></div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏[citation:2]
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ2JkYnVpcXpkbXdpbml5eHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ON_KEY, {
            auth: { persistSession: true, autoRefreshToken: true }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUser = null;
        let userProfile = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            updateConnectionStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞...', '');
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/', {
                    headers: { 'apikey': SUPABASE_ANON_KEY }
                });
                if (response.ok) {
                    updateConnectionStatus('‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω', 'status-up');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è[citation:1]
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) {
                        currentUser = session.user;
                        await fetchUserProfile();
                        showAppScreen();
                    } else {
                        showAuthScreen();
                    }
                } else {
                    updateConnectionStatus('‚ùå Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'status-down');
                }
            } catch (error) {
                updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'status-down');
            }
            
            // –ù–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –º–µ—Å—è—Ü–∞–º–∏
            populateMonthSelects();
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏[citation:1]
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth event:', event);
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await fetchUserProfile();
                    showAppScreen();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    userProfile = null;
                    showAuthScreen();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('authMessage').classList.add('hidden');
        }
        function showAppScreen() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            if (userProfile && userProfile.role === 'admin') {
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('userPanel').classList.add('hidden');
                loadUsersList(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω–∞
            } else {
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
            }
            document.getElementById('currentUserName').textContent = userProfile?.full_name || currentUser?.email;
            document.getElementById('currentUserRole').textContent = (userProfile?.role === 'admin') ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–£—á–∞—Å—Ç–Ω–∏–∫ –°–ù–¢';
        }
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
        }
        function showAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.remove('hidden');
        }
        function showUserTab(tabName) {
            document.querySelectorAll('.user-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('user' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.remove('hidden');
        }
        function updateConnectionStatus(message, className) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = message;
            statusEl.className = 'status-bar ' + className;
        }

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è[citation:1][citation:4]
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            const msg = document.getElementById('authMessage');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> –í—Ö–æ–¥...';
            msg.classList.add('hidden');
            const { data, error } = await supabase.auth.signInWithPassword({ email, password })[citation:1];
            if (error) {
                msg.textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message;
                msg.className = 'alert alert-error';
                msg.classList.remove('hidden');
            } else {
                msg.textContent = '–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';
                msg.className = 'alert alert-success';
                msg.classList.remove('hidden');
            }
            btn.disabled = false;
            btn.textContent = '–í–æ–π—Ç–∏';
        });
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const fullName = document.getElementById('fullName').value;
            const plotNumber = document.getElementById('plotNumber').value;
            const plotArea = document.getElementById('plotArea').value;
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: { full_name: fullName, plot_number: plotNumber, plot_area: plotArea, role: 'user' }
                }
            })[citation:1][citation:4];
            if (error) {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            } else {
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ) –∏ –≤–æ–π–¥–∏—Ç–µ.');
                showTab('login');
            }
            btn.disabled = false;
            btn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            e.target.reset();
        });
        async function logout() {
            await supabase.auth.signOut();
        }
        async function fetchUserProfile() {
            if (!currentUser) return;
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .maybeSingle(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º maybeSingle, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç
            if (error && error.code !== 'PGRST116') { // PGRST116 - —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —ç—Ç–æ –æ–∫
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            }
            userProfile = data;
            // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç –≤ public.profiles, —Å–æ–∑–¥–∞—ë–º –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ auth.users
            if (!data && currentUser.user_metadata) {
                const { data: newProfile, error: insertError } = await supabase
                    .from('profiles')
                    .insert([{
                        id: currentUser.id,
                        full_name: currentUser.user_metadata.full_name || currentUser.email,
                        role: currentUser.user_metadata.role || 'user',
                        plot_number: currentUser.user_metadata.plot_number || '1',
                        plot_area: currentUser.user_metadata.plot_area || 6
                    }])
                    .select()
                    .single();
                if (!insertError) userProfile = newProfile;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function loadUsersList() {
            const { data, error } = await supabase.from('profiles').select('*').order('full_name');
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                return;
            }
            const tbody = document.getElementById('usersList');
            tbody.innerHTML = '';
            data.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id.substring(0,8)}...</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.full_name || '-'}</td>
                    <td>${user.plot_number || '-'} (${user.plot_area || 0} —Å–æ—Ç.)</td>
                    <td>${user.role || 'user'}</td>
                    <td><button class="btn" onclick="editUser('${user.id}')">–ü—Ä–∞–≤–∏—Ç—å</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        function editUser(userId) {
            alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID: ' + userId + ' –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ.');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function populateMonthSelects() {
            const months = ['–Ø–Ω–≤–∞—Ä—å 2026', '–§–µ–≤—Ä–∞–ª—å 2026', '–ú–∞—Ä—Ç 2026', '–ê–ø—Ä–µ–ª—å 2026', '–ú–∞–π 2026', '–ò—é–Ω—å 2026'];
            const select1 = document.getElementById('readingMonth');
            const select2 = document.getElementById('feesMonth');
            select1.innerHTML = select2.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        document.getElementById('meterReadingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const reading = parseFloat(document.getElementById('currentReading').value);
            const month = document.getElementById('readingMonth').value;
            // –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ –ø–æ —Ç—Ä—ë—Ö—Å—Ç–∞–≤–æ—á–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É
            const lossTariff = 0.36; // –¢–∞—Ä–∏—Ñ –Ω–∞ –ø–æ—Ç–µ—Ä–∏ (–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–¥–º–∏–Ω–∞)
            const tariffUnder100 = 6.1; // –¢–∞—Ä–∏—Ñ –¥–æ 100 –∫–í—Ç¬∑—á
            const tariffOver100 = 7.3; // –¢–∞—Ä–∏—Ñ —Å–≤—ã—à–µ 100 –∫–í—Ç¬∑—á
            let total = reading * lossTariff;
            if (reading > 100) {
                total += 100 * tariffUnder100 + (reading - 100) * tariffOver100;
            } else {
                total += reading * tariffUnder100;
            }
            document.getElementById('calculationResult').innerHTML = `
                <strong>–†–∞—Å—Å—á—ë—Ç –∑–∞ ${month}:</strong><br>
                –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ: ${reading.toFixed(2)} –∫–í—Ç¬∑—á<br>
                –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: <strong>${total.toFixed(2)} —Ä—É–±.</strong><br>
                (–ü–æ—Ç–µ—Ä–∏: ${(reading * lossTariff).toFixed(2)} —Ä—É–±. + –≠–Ω–µ—Ä–≥–∏—è: ${(total - reading * lossTariff).toFixed(2)} —Ä—É–±.)
            `;
            document.getElementById('calculationResult').classList.remove('hidden');
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
        });

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        async function testConnection() {
            const res = document.getElementById('testResults');
            res.innerHTML = '<div class="alert alert-info"><span class="loading"></span> –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>';
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/', {
                    headers: { 'apikey': SUPABASE_ANON_KEY }
                });
                const text = await response.text();
                res.innerHTML = `<div class="alert alert-success"><strong>‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–π–¥–µ–Ω</strong><br>–°—Ç–∞—Ç—É—Å: ${response.status}<br>–û—Ç–≤–µ—Ç: ${text.substring(0,150)}...</div>`;
            } catch (error) {
                res.innerHTML = `<div class="alert alert-error"><strong>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</strong><br>${error.message}</div>`;
            }
        }
        async function testRestApi() {
            const res = document.getElementById('testResults');
            res.innerHTML = '<div class="alert alert-info"><span class="loading"></span> –¢–µ—Å—Ç REST API...</div>';
            const { data, error } = await supabase.from('test_table').select('*').limit(2);
            if (error) {
                res.innerHTML = `<div class="alert alert-error"><strong>‚ùå –û—à–∏–±–∫–∞ REST API</strong><br>${error.message}</div>`;
            } else {
                res.innerHTML = `<div class="alert alert-success"><strong>‚úÖ REST API —Ä–∞–±–æ—Ç–∞–µ—Ç</strong><br>–ü–æ–ª—É—á–µ–Ω–æ —Å—Ç—Ä–æ–∫ –∏–∑ test_table: ${data.length}<br>${JSON.stringify(data)}</div>`;
            }
        }
        async function testAuth() {
            const res = document.getElementById('testResults');
            res.innerHTML = '<div class="alert alert-info"><span class="loading"></span> –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏)...</div>';
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                res.innerHTML = `<div class="alert alert-error"><strong>‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</strong><br>${error.message}</div>`;
            } else if (session) {
                res.innerHTML = `<div class="alert alert-success"><strong>‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç</strong><br>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${session.user.email}<br>ID: ${session.user.id.substring(0,10)}...</div>`;
            } else {
                res.innerHTML = `<div class="alert alert-info"><strong>‚ÑπÔ∏è –°–µ—Å—Å–∏–∏ –Ω–µ—Ç</strong><br>–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.</div>`;
            }
        }
    </script>
</body>
</html>
