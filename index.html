<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СНТ "Звездочка" - Показания и Взносы</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .logo i {
            font-size: 2rem;
            color: var(--warning-color);
        }
        
        .auth-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            background-color: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }
        
        .card-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .table tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-unpaid {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 25px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 1rem;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .meter-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .electricity-calc {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .meter-row {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .tabs {
                overflow-x: auto;
            }
        }
    </style>
    <!-- Подключаем Supabase JS библиотеку -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Подключаем иконки Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Контейнер приложения -->
    <div id="app" class="hidden">
        <!-- Шапка -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-star"></i>
                        <h1>СНТ "Звездочка"</h1>
                    </div>
                    <div class="auth-info">
                        <div class="user-info" id="userInfo">
                            <span id="userName"></span>
                            <span id="userRole" class="status-badge"></span>
                        </div>
                        <button class="btn btn-danger" onclick="logout()">Выйти</button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Основной контент -->
        <div class="container">
            <!-- Панель вкладок (для пользователя) -->
            <div id="userTabs" class="tabs">
                <div class="tab active" onclick="switchTab('dashboard')">Дашборд</div>
                <div class="tab" onclick="switchTab('electricity')">Электроэнергия</div>
                <div class="tab" onclick="switchTab('membership')">Членские взносы</div>
                <div class="tab" onclick="switchTab('history')">История</div>
            </div>
            
            <!-- Панель вкладок (для администратора) -->
            <div id="adminTabs" class="tabs hidden">
                <div class="tab active" onclick="switchTab('adminDashboard')">Админ-панель</div>
                <div class="tab" onclick="switchTab('manageUsers')">Управление пользователями</div>
                <div class="tab" onclick="switchTab('manageTariffs')">Управление тарифами</div>
                <div class="tab" onclick="switchTab('bulkOperations')">Пакетные операции</div>
            </div>
            
            <!-- Дашборд пользователя -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2 class="card-title">Общая информация</h2>
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-label">Текущая задолженность</div>
                            <div class="stat-value" id="currentDebt">0 ₽</div>
                            <div class="stat-label">на <span id="currentDate"></span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Электроэнергия</div>
                            <div class="stat-value" id="electricityAmount">0 кВт·ч</div>
                            <div class="stat-label">потреблено в текущем месяце</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Участков</div>
                            <div class="stat-value" id="plotsCount">0</div>
                            <div class="stat-label">соток: <span id="acresCount">0</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Последние показания</h2>
                    <div id="lastReadings"></div>
                </div>
            </div>
            
            <!-- Форма подачи показаний электроэнергии -->
            <div id="electricity" class="tab-content">
                <div class="card">
                    <h2 class="card-title">Показания электроэнергии</h2>
                    <div id="electricityForm"></div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Мои счетчики</h2>
                    <div id="myMeters"></div>
                </div>
            </div>
            
            <!-- Членские взносы -->
            <div id="membership" class="tab-content">
                <div class="card">
                    <h2 class="card-title">Членские взносы</h2>
                    <div id="membershipInfo"></div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Расчет взносов на текущий месяц</h2>
                    <div id="membershipCalculation"></div>
                </div>
            </div>
            
            <!-- История показаний и платежей -->
            <div id="history" class="tab-content">
                <div class="card">
                    <h2 class="card-title">История показаний</h2>
                    <div id="readingsHistory"></div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">История платежей</h2>
                    <div id="paymentsHistory"></div>
                </div>
            </div>
            
            <!-- Админ-панель -->
            <div id="adminDashboard" class="tab-content">
                <div class="card">
                    <h2 class="card-title">Панель администратора</h2>
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-label">Всего пользователей</div>
                            <div class="stat-value" id="totalUsers">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Неоплаченных взносов</div>
                            <div class="stat-value" id="unpaidFees">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Сдано показаний за месяц</div>
                            <div class="stat-value" id="submittedReadings">0</div>
                        </div>
                    </div>
                    
                    <div class="admin-controls">
                        <button class="btn btn-success" onclick="exportData()">
                            <i class="fas fa-download"></i> Выгрузить данные
                        </button>
                        <button class="btn btn-warning" onclick="showImportModal()">
                            <i class="fas fa-upload"></i> Загрузить данные
                        </button>
                        <button class="btn btn-primary" onclick="generateMonthlyReport()">
                            <i class="fas fa-file-alt"></i> Сформировать отчет
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Управление пользователями -->
            <div id="manageUsers" class="tab-content">
                <div class="card">
                    <h2 class="card-title">Управление пользователями</h2>
                    <div class="admin-controls">
                        <button class="btn btn-success" onclick="showAddUserModal()">
                            <i class="fas fa-plus"></i> Добавить пользователя
                        </button>
                        <input type="text" id="userSearch" class="form-control" placeholder="Поиск пользователя..." style="max-width: 300px;">
                    </div>
                    <div id="usersTable"></div>
                </div>
            </div>
            
            <!-- Управление тарифами -->
            <div id="manageTariffs" class="tab-content">
                <div class="card">
                    <h2 class="card-title">Управление тарифами</h2>
                    <div id="tariffsManagement"></div>
                </div>
            </div>
            
            <!-- Пакетные операции -->
            <div id="bulkOperations" class="tab-content">
                <div class="card">
                    <h2 class="card-title">Пакетные операции</h2>
                    <div id="bulkOperationsContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Форма входа -->
    <div id="loginForm">
        <div class="login-container">
            <h2 class="login-title">Вход в систему</h2>
            <div id="loginAlert" class="alert alert-danger hidden"></div>
            <div class="form-group">
                <label class="form-label">Логин</label>
                <input type="text" id="loginUsername" class="form-control" placeholder="Введите логин">
            </div>
            <div class="form-group">
                <label class="form-label">Пароль</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Введите пароль">
            </div>
            <div class="form-group">
                <button class="btn btn-primary" style="width: 100%;" onclick="login()">Войти</button>
            </div>
            <div class="form-group" style="text-align: center;">
                <small>Для теста: admin / admin123</small>
            </div>
        </div>
    </div>
    
    <!-- Индикатор загрузки -->
    <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p>Загрузка приложения...</p>
        <div id="supabaseStatus"></div>
    </div>
    
    <!-- Модальные окна будут добавляться динамически -->
    
    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ2JkYnVpcXpkbXdpbml5eHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU';
        
        // Инициализация Supabase клиента
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Глобальные переменные
        let currentUser = null;
        let isAdmin = false;
        let currentMonth = new Date().getMonth() + 1;
        let currentYear = new Date().getFullYear();
        
        // Функция проверки подключения к Supabase
        async function checkSupabaseConnection() {
            try {
                document.getElementById('supabaseStatus').innerHTML = '<p>Проверка подключения к Supabase...</p>';
                
                // Пытаемся выполнить простой запрос
                const { data, error } = await supabase.from('users').select('count', { count: 'exact', head: true });
                
                if (error) {
                    // Если таблицы не существует, создаем ее
                    if (error.code === 'PGRST204' || error.message.includes('отношения') || error.message.includes('relation')) {
                        document.getElementById('supabaseStatus').innerHTML = '<p>Создание таблиц базы данных...</p>';
                        await createDatabaseTables();
                        return true;
                    }
                    throw error;
                }
                
                document.getElementById('supabaseStatus').innerHTML = '<p style="color:green">✓ Подключение к Supabase успешно</p>';
                return true;
            } catch (error) {
                console.error('Ошибка подключения к Supabase:', error);
                document.getElementById('supabaseStatus').innerHTML = 
                    `<p style="color:red">✗ Ошибка подключения: ${error.message}</p>`;
                return false;
            }
        }
        
        // Функция создания таблиц базы данных
        async function createDatabaseTables() {
            try {
                // Таблица пользователей
                const { error: usersError } = await supabase.rpc('create_users_table', {});
                if (usersError && !usersError.message.includes('already exists')) {
                    console.error('Ошибка создания таблицы users:', usersError);
                }
                
                // Таблица счетчиков
                const { error: metersError } = await supabase.rpc('create_meters_table', {});
                if (metersError && !metersError.message.includes('already exists')) {
                    console.error('Ошибка создания таблицы meters:', metersError);
                }
                
                // Таблица показаний
                const { error: readingsError } = await supabase.rpc('create_readings_table', {});
                if (readingsError && !readingsError.message.includes('already exists')) {
                    console.error('Ошибка создания таблицы readings:', readingsError);
                }
                
                // Таблица тарифов на электроэнергию
                const { error: tariffsError } = await supabase.rpc('create_tariffs_table', {});
                if (tariffsError && !tariffsError.message.includes('already exists')) {
                    console.error('Ошибка создания таблицы electricity_tariffs:', tariffsError);
                }
                
                // Таблица тарифов на членские взносы
                const { error: membershipTariffsError } = await supabase.rpc('create_membership_tariffs_table', {});
                if (membershipTariffsError && !membershipTariffsError.message.includes('already exists')) {
                    console.error('Ошибка создания таблицы membership_tariffs:', membershipTariffsError);
                }
                
                // Таблица платежей
                const { error: paymentsError } = await supabase.rpc('create_payments_table', {});
                if (paymentsError && !paymentsError.message.includes('already exists')) {
                    console.error('Ошибка создания таблицы payments:', paymentsError);
                }
                
                // Создаем администратора по умолчанию, если нет пользователей
                const { count } = await supabase.from('users').select('*', { count: 'exact', head: true });
                
                if (count === 0) {
                    const adminUser = {
                        username: 'admin',
                        password: 'admin123', // В реальном приложении пароль должен быть хэширован!
                        full_name: 'Администратор',
                        role: 'admin',
                        plots: 1,
                        acres: 6,
                        phone: '+79999999999',
                        address: 'Административный участок'
                    };
                    
                    await supabase.from('users').insert([adminUser]);
                    console.log('Администратор создан по умолчанию');
                }
                
                // Создаем тестового пользователя
                const testUser = {
                    username: 'testuser',
                    password: 'test123',
                    full_name: 'Тестовый Пользователь',
                    role: 'user',
                    plots: 1,
                    acres: 6,
                    phone: '+78888888888',
                    address: 'Участок №1'
                };
                
                // Проверяем, существует ли уже тестовый пользователь
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('id')
                    .eq('username', 'testuser')
                    .single();
                    
                if (!existingUser) {
                    await supabase.from('users').insert([testUser]);
                    console.log('Тестовый пользователь создан');
                }
                
                // Создаем начальные тарифы, если их нет
                const { data: existingTariffs } = await supabase
                    .from('electricity_tariffs')
                    .select('id')
                    .eq('month', currentMonth)
                    .eq('year', currentYear)
                    .single();
                    
                if (!existingTariffs) {
                    const defaultTariff = {
                        month: currentMonth,
                        year: currentYear,
                        loss_rate: 0.36,
                        rate_under_100: 6.1,
                        rate_over_100: 7.3
                    };
                    
                    await supabase.from('electricity_tariffs').insert([defaultTariff]);
                }
                
                // Создаем начальные тарифы на членские взносы
                const { data: existingMembershipTariffs } = await supabase
                    .from('membership_tariffs')
                    .select('id')
                    .eq('month', currentMonth)
                    .eq('year', currentYear)
                    .single();
                    
                if (!existingMembershipTariffs) {
                    const defaultMembershipTariff = {
                        month: currentMonth,
                        year: currentYear,
                        salary_per_plot: 939.00,
                        maintenance_per_acre: 44.00,
                        additional_field1_name: 'Ремонт дорог',
                        additional_field2_name: 'Вывоз мусора',
                        additional_field3_name: 'Охрана',
                        additional_field1_rate: 200,
                        additional_field2_rate: 150,
                        additional_field3_rate: 300
                    };
                    
                    await supabase.from('membership_tariffs').insert([defaultMembershipTariff]);
                }
                
                return true;
            } catch (error) {
                console.error('Ошибка создания таблиц:', error);
                return false;
            }
        }
        
        // Функция инициализации приложения
        async function initApp() {
            // Проверяем подключение к Supabase
            const connected = await checkSupabaseConnection();
            
            if (!connected) {
                document.getElementById('loading').innerHTML = 
                    '<p style="color:red">Не удалось подключиться к базе данных. Проверьте подключение к интернету.</p>';
                return;
            }
            
            // Проверяем, есть ли сохраненная сессия
            const savedUser = localStorage.getItem('snt_user');
            
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    // Проверяем валидность пользователя
                    const { data: validUser, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('username', user.username)
                        .eq('password', user.password)
                        .single();
                        
                    if (validUser && !error) {
                        currentUser = validUser;
                        isAdmin = validUser.role === 'admin';
                        showApp();
                    } else {
                        showLogin();
                    }
                } catch (error) {
                    showLogin();
                }
            } else {
                showLogin();
            }
            
            // Скрываем индикатор загрузки
            document.getElementById('loading').style.display = 'none';
            
            // Устанавливаем текущую дату
            const now = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ru-RU', options);
        }
        
        // Функция отображения формы входа
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
        
        // Функция отображения основного приложения
        function showApp() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Обновляем информацию о пользователе
            document.getElementById('userName').textContent = currentUser.full_name;
            document.getElementById('userRole').textContent = isAdmin ? 'Администратор' : 'Пользователь';
            document.getElementById('userRole').className = isAdmin ? 'status-badge status-paid' : 'status-badge status-unpaid';
            
            // Показываем соответствующие вкладки
            if (isAdmin) {
                document.getElementById('userTabs').classList.add('hidden');
                document.getElementById('adminTabs').classList.remove('hidden');
                loadAdminDashboard();
            } else {
                document.getElementById('userTabs').classList.remove('hidden');
                document.getElementById('adminTabs').classList.add('hidden');
                loadUserDashboard();
            }
            
            // Загружаем данные для дашборда
            updateDashboard();
        }
        
        // Функция входа в систему
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Очищаем предыдущие сообщения об ошибках
            document.getElementById('loginAlert').classList.add('hidden');
            
            if (!username || !password) {
                showLoginError('Введите логин и пароль');
                return;
            }
            
            try {
                // Ищем пользователя в базе данных
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();
                    
                if (error || !user) {
                    showLoginError('Неверный логин или пароль');
                    return;
                }
                
                // Сохраняем пользователя
                currentUser = user;
                isAdmin = user.role === 'admin';
                
                // Сохраняем в localStorage
                localStorage.setItem('snt_user', JSON.stringify({
                    username: user.username,
                    password: user.password // ВНИМАНИЕ: В реальном приложении не храните пароли в localStorage!
                }));
                
                // Показываем приложение
                showApp();
                
            } catch (error) {
                console.error('Ошибка входа:', error);
                showLoginError('Ошибка при входе в систему');
            }
        }
        
        // Функция показа ошибки входа
        function showLoginError(message) {
            const alert = document.getElementById('loginAlert');
            alert.textContent = message;
            alert.classList.remove('hidden');
        }
        
        // Функция выхода из системы
        function logout() {
            localStorage.removeItem('snt_user');
            currentUser = null;
            isAdmin = false;
            showLogin();
            
            // Очищаем поля входа
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }
        
        // Функция переключения вкладок
        function switchTab(tabName) {
            // Скрываем все вкладки
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Убираем активный класс со всех вкладок
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Показываем выбранную вкладку
            document.getElementById(tabName).classList.add('active');
            
            // Активируем соответствующую кнопку вкладки
            const activeTabButton = Array.from(tabButtons).find(button => 
                button.textContent.includes(getTabName(tabName))
            );
            if (activeTabButton) {
                activeTabButton.classList.add('active');
            }
            
            // Загружаем данные для вкладки
            if (tabName === 'dashboard' || tabName === 'adminDashboard') {
                updateDashboard();
            } else if (tabName === 'electricity') {
                loadElectricityForm();
                loadUserMeters();
            } else if (tabName === 'membership') {
                loadMembershipInfo();
            } else if (tabName === 'history') {
                loadReadingsHistory();
                loadPaymentsHistory();
            } else if (tabName === 'manageUsers') {
                loadUsersTable();
            } else if (tabName === 'manageTariffs') {
                loadTariffsManagement();
            } else if (tabName === 'bulkOperations') {
                loadBulkOperations();
            }
        }
        
        // Вспомогательная функция для получения имени вкладки
        function getTabName(tabId) {
            const tabNames = {
                'dashboard': 'Дашборд',
                'electricity': 'Электроэнергия',
                'membership': 'Членские взносы',
                'history': 'История',
                'adminDashboard': 'Админ-панель',
                'manageUsers': 'Управление пользователями',
                'manageTariffs': 'Управление тарифами',
                'bulkOperations': 'Пакетные операции'
            };
            return tabNames[tabId] || tabId;
        }
        
        // Функция обновления дашборда
        async function updateDashboard() {
            if (!currentUser) return;
            
            // Загружаем данные пользователя
            document.getElementById('plotsCount').textContent = currentUser.plots || 0;
            document.getElementById('acresCount').textContent = currentUser.acres || 0;
            
            if (isAdmin) {
                await loadAdminDashboard();
            } else {
                await loadUserDashboard();
            }
        }
        
        // Функция загрузки дашборда пользователя
        async function loadUserDashboard() {
            // Загружаем последние показания
            const { data: readings } = await supabase
                .from('readings')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('reading_date', { ascending: false })
                .limit(5);
                
            if (readings && readings.length > 0) {
                let html = '<table class="table">';
                html += '<thead><tr><th>Дата</th><th>Счетчик</th><th>Показания</th><th>Расход</th></tr></thead><tbody>';
                
                readings.forEach(reading => {
                    html += `<tr>
                        <td>${new Date(reading.reading_date).toLocaleDateString('ru-RU')}</td>
                        <td>${reading.meter_number || 'Основной'}</td>
                        <td>${reading.reading_value} кВт·ч</td>
                        <td>${reading.consumption || '—'} кВт·ч</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                document.getElementById('lastReadings').innerHTML = html;
            } else {
                document.getElementById('lastReadings').innerHTML = '<p>Показания еще не подавались</p>';
            }
            
            // Рассчитываем текущую задолженность
            await calculateCurrentDebt();
            
            // Загружаем общее потребление за текущий месяц
            const startOfMonth = new Date(currentYear, currentMonth - 1, 1).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            
            const { data: currentMonthReadings } = await supabase
                .from('readings')
                .select('reading_value, consumption')
                .eq('user_id', currentUser.id)
                .gte('reading_date', startOfMonth)
                .lte('reading_date', today);
                
            let totalConsumption = 0;
            if (currentMonthReadings) {
                currentMonthReadings.forEach(reading => {
                    totalConsumption += reading.consumption || 0;
                });
            }
            
            document.getElementById('electricityAmount').textContent = totalConsumption.toFixed(1);
        }
        
        // Функция расчета текущей задолженности
        async function calculateCurrentDebt() {
            if (!currentUser) return;
            
            let totalDebt = 0;
            
            // Расчет за электроэнергию
            const { data: lastReading } = await supabase
                .from('readings')
                .select('reading_value')
                .eq('user_id', currentUser.id)
                .order('reading_date', { ascending: false })
                .limit(1)
                .single();
                
            const { data: previousReading } = await supabase
                .from('readings')
                .select('reading_value')
                .eq('user_id', currentUser.id)
                .order('reading_date', { ascending: false })
                .limit(2);
                
            if (lastReading && previousReading && previousReading.length > 1) {
                const consumption = lastReading.reading_value - previousReading[1].reading_value;
                
                // Получаем текущий тариф
                const { data: tariff } = await supabase
                    .from('electricity_tariffs')
                    .select('*')
                    .eq('month', currentMonth)
                    .eq('year', currentYear)
                    .single();
                    
                if (tariff) {
                    // Расчет по трехставочному тарифу
                    const lossCost = consumption * tariff.loss_rate;
                    let under100Cost = 0;
                    let over100Cost = 0;
                    
                    if (consumption > 100) {
                        under100Cost = 100 * tariff.rate_under_100;
                        over100Cost = (consumption - 100) * tariff.rate_over_100;
                    } else {
                        under100Cost = consumption * tariff.rate_under_100;
                    }
                    
                    totalDebt += lossCost + under100Cost + over100Cost;
                }
            }
            
            // Расчет членских взносов
            const { data: membershipTariff } = await supabase
                .from('membership_tariffs')
                .select('*')
                .eq('month', currentMonth)
                .eq('year', currentYear)
                .single();
                
            if (membershipTariff) {
                // Зарплата с участков
                totalDebt += currentUser.plots * membershipTariff.salary_per_plot;
                
                // Содержание за сотки
                totalDebt += currentUser.acres * membershipTariff.maintenance_per_acre;
                
                // Дополнительные поля
                totalDebt += membershipTariff.additional_field1_rate || 0;
                totalDebt += membershipTariff.additional_field2_rate || 0;
                totalDebt += membershipTariff.additional_field3_rate || 0;
            }
            
            // Вычитаем оплаченные платежи
            const { data: payments } = await supabase
                .from('payments')
                .select('amount')
                .eq('user_id', currentUser.id)
                .eq('month', currentMonth)
                .eq('year', currentYear);
                
            if (payments) {
                payments.forEach(payment => {
                    totalDebt -= payment.amount || 0;
                });
            }
            
            document.getElementById('currentDebt').textContent = totalDebt.toFixed(2) + ' ₽';
        }
        
        // Функция загрузки формы подачи показаний электроэнергии
        async function loadElectricityForm() {
            if (!currentUser) return;
            
            // Загружаем счетчики пользователя
            const { data: meters } = await supabase
                .from('meters')
                .select('*')
                .eq('user_id', currentUser.id);
                
            let html = '';
            
            if (meters && meters.length > 0) {
                html += '<p>Введите текущие показания для каждого счетчика:</p>';
                
                meters.forEach((meter, index) => {
                    html += `
                    <div class="meter-row">
                        <div>
                            <label class="form-label">Счетчик №${meter.meter_number}</label>
                            <input type="number" step="0.01" id="meter_${meter.id}" class="form-control" 
                                   placeholder="Текущие показания" value="${meter.last_reading || ''}">
                            <small>Предыдущие: ${meter.last_reading || 'нет данных'}</small>
                        </div>
                        <div>
                            <label class="form-label">Дата снятия показаний</label>
                            <input type="date" id="date_${meter.id}" class="form-control" 
                                   value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-success" style="width:100%; margin-top:8px;" 
                                    onclick="submitReading('${meter.id}')">
                                <i class="fas fa-paper-plane"></i> Отправить
                            </button>
                        </div>
                    </div>`;
                });
            } else {
                html = '<p>У вас нет зарегистрированных счетчиков. Обратитесь к администратору.</p>';
            }
            
            // Добавляем возможность добавить новый счетчик
            if (isAdmin || meters.length === 0) {
                html += `
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showAddMeterModal()">
                        <i class="fas fa-plus"></i> Добавить счетчик
                    </button>
                </div>`;
            }
            
            document.getElementById('electricityForm').innerHTML = html;
        }
        
        // Функция загрузки счетчиков пользователя
        async function loadUserMeters() {
            if (!currentUser) return;
            
            const { data: meters } = await supabase
                .from('meters')
                .select('*')
                .eq('user_id', currentUser.id);
                
            let html = '';
            
            if (meters && meters.length > 0) {
                html = '<table class="table"><thead><tr><th>№ Счетчика</th><th>Последние показания</th><th>Дата</th><th>Статус</th></tr></thead><tbody>';
                
                meters.forEach(meter => {
                    html += `<tr>
                        <td>${meter.meter_number}</td>
                        <td>${meter.last_reading || '—'}</td>
                        <td>${meter.last_reading_date ? new Date(meter.last_reading_date).toLocaleDateString('ru-RU') : '—'}</td>
                        <td><span class="status-badge ${meter.last_reading ? 'status-paid' : 'status-unpaid'}">${meter.last_reading ? 'Активен' : 'Нет данных'}</span></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else {
                html = '<p>Нет зарегистрированных счетчиков.</p>';
            }
            
            document.getElementById('myMeters').innerHTML = html;
        }
        
        // Функция отправки показаний
        async function submitReading(meterId) {
            const readingValue = document.getElementById(`meter_${meterId}`).value;
            const readingDate = document.getElementById(`date_${meterId}`).value;
            
            if (!readingValue || !readingDate) {
                alert('Заполните все поля');
                return;
            }
            
            // Получаем данные счетчика
            const { data: meter } = await supabase
                .from('meters')
                .select('*')
                .eq('id', meterId)
                .single();
                
            if (!meter) {
                alert('Счетчик не найден');
                return;
            }
            
            // Рассчитываем потребление
            const previousReading = meter.last_reading || 0;
            const consumption = readingValue - previousReading;
            
            if (consumption < 0) {
                alert('Текущие показания не могут быть меньше предыдущих');
                return;
            }
            
            try {
                // Сохраняем показания в историю
                const { error: readingError } = await supabase
                    .from('readings')
                    .insert([{
                        user_id: currentUser.id,
                        meter_id: meterId,
                        meter_number: meter.meter_number,
                        reading_value: parseFloat(readingValue),
                        reading_date: readingDate,
                        consumption: consumption,
                        month: currentMonth,
                        year: currentYear
                    }]);
                    
                if (readingError) throw readingError;
                
                // Обновляем последние показания в счетчике
                const { error: meterError } = await supabase
                    .from('meters')
                    .update({
                        last_reading: readingValue,
                        last_reading_date: readingDate
                    })
                    .eq('id', meterId);
                    
                if (meterError) throw meterError;
                
                alert('Показания успешно отправлены!');
                
                // Обновляем данные на странице
                loadElectricityForm();
                loadUserMeters();
                updateDashboard();
                
            } catch (error) {
                console.error('Ошибка сохранения показаний:', error);
                alert('Ошибка при сохранении показаний');
            }
        }
        
        // Функция загрузки информации о членских взносах
        async function loadMembershipInfo() {
            if (!currentUser) return;
            
            // Загружаем тарифы на членские взносы
            const { data: tariff } = await supabase
                .from('membership_tariffs')
                .select('*')
                .eq('month', currentMonth)
                .eq('year', currentYear)
                .single();
                
            let html = '';
            
            if (tariff) {
                html += `
                <div class="form-group">
                    <label class="form-label">Количество участков:</label>
                    <input type="number" class="form-control" value="${currentUser.plots || 0}" readonly>
                    <small>Зарплата с участка: ${tariff.salary_per_plot} ₽ × ${currentUser.plots || 0} = ${(tariff.salary_per_plot * (currentUser.plots || 0)).toFixed(2)} ₽</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Количество соток:</label>
                    <input type="number" step="0.01" class="form-control" value="${currentUser.acres || 0}" readonly>
                    <small>Содержание за сотку: ${tariff.maintenance_per_acre} ₽ × ${currentUser.acres || 0} = ${(tariff.maintenance_per_acre * (currentUser.acres || 0)).toFixed(2)} ₽</small>
                </div>`;
                
                // Дополнительные поля
                if (tariff.additional_field1_name && tariff.additional_field1_rate) {
                    html += `
                    <div class="form-group">
                        <label class="form-label">${tariff.additional_field1_name}:</label>
                        <input type="number" class="form-control" value="${tariff.additional_field1_rate}" readonly>
                    </div>`;
                }
                
                if (tariff.additional_field2_name && tariff.additional_field2_rate) {
                    html += `
                    <div class="form-group">
                        <label class="form-label">${tariff.additional_field2_name}:</label>
                        <input type="number" class="form-control" value="${tariff.additional_field2_rate}" readonly>
                    </div>`;
                }
                
                if (tariff.additional_field3_name && tariff.additional_field3_rate) {
                    html += `
                    <div class="form-group">
                        <label class="form-label">${tariff.additional_field3_name}:</label>
                        <input type="number" class="form-control" value="${tariff.additional_field3_rate}" readonly>
                    </div>`;
                }
            } else {
                html = '<p>Тарифы на членские взносы не установлены на текущий месяц.</p>';
            }
            
            document.getElementById('membershipInfo').innerHTML = html;
            
            // Загружаем расчет
            await loadMembershipCalculation();
        }
        
        // Функция загрузки расчета членских взносов
        async function loadMembershipCalculation() {
            if (!currentUser) return;
            
            const { data: tariff } = await supabase
                .from('membership_tariffs')
                .select('*')
                .eq('month', currentMonth)
                .eq('year', currentYear)
                .single();
                
            let html = '';
            
            if (tariff) {
                let total = 0;
                let calculation = '';
                
                // Зарплата с участков
                const salaryAmount = (currentUser.plots || 0) * tariff.salary_per_plot;
                total += salaryAmount;
                calculation += `<p>Зарплата: ${currentUser.plots || 0} уч. × ${tariff.salary_per_plot} ₽ = ${salaryAmount.toFixed(2)} ₽</p>`;
                
                // Содержание за сотки
                const maintenanceAmount = (currentUser.acres || 0) * tariff.maintenance_per_acre;
                total += maintenanceAmount;
                calculation += `<p>Содержание: ${currentUser.acres || 0} сот. × ${tariff.maintenance_per_acre} ₽ = ${maintenanceAmount.toFixed(2)} ₽</p>`;
                
                // Дополнительные поля
                if (tariff.additional_field1_rate) {
                    total += tariff.additional_field1_rate;
                    calculation += `<p>${tariff.additional_field1_name}: ${tariff.additional_field1_rate} ₽</p>`;
                }
                
                if (tariff.additional_field2_rate) {
                    total += tariff.additional_field2_rate;
                    calculation += `<p>${tariff.additional_field2_name}: ${tariff.additional_field2_rate} ₽</p>`;
                }
                
                if (tariff.additional_field3_rate) {
                    total += tariff.additional_field3_rate;
                    calculation += `<p>${tariff.additional_field3_name}: ${tariff.additional_field3_rate} ₽</p>`;
                }
                
                html = `
                <div class="electricity-calc">
                    ${calculation}
                    <hr>
                    <h3 style="color: var(--primary-color);">Итого: ${total.toFixed(2)} ₽</h3>
                    <p><small>Расчет за ${currentMonth}.${currentYear}</small></p>
                </div>`;
            }
            
            document.getElementById('membershipCalculation').innerHTML = html;
        }
        
        // Функция загрузки истории показаний
        async function loadReadingsHistory() {
            if (!currentUser) return;
            
            const { data: readings } = await supabase
                .from('readings')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('reading_date', { ascending: false })
                .limit(50);
                
            let html = '';
            
            if (readings && readings.length > 0) {
                html = '<table class="table"><thead><tr><th>Дата</th><th>Счетчик</th><th>Показания</th><th>Расход</th><th>Месяц</th></tr></thead><tbody>';
                
                readings.forEach(reading => {
                    html += `<tr>
                        <td>${new Date(reading.reading_date).toLocaleDateString('ru-RU')}</td>
                        <td>${reading.meter_number}</td>
                        <td>${reading.reading_value} кВт·ч</td>
                        <td>${reading.consumption} кВт·ч</td>
                        <td>${reading.month}.${reading.year}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else {
                html = '<p>История показаний пуста.</p>';
            }
            
            document.getElementById('readingsHistory').innerHTML = html;
        }
        
        // Функция загрузки истории платежей
        async function loadPaymentsHistory() {
            if (!currentUser) return;
            
            const { data: payments } = await supabase
                .from('payments')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('payment_date', { ascending: false })
                .limit(50);
                
            let html = '';
            
            if (payments && payments.length > 0) {
                html = '<table class="table"><thead><tr><th>Дата</th><th>Сумма</th><th>Назначение</th><th>Месяц</th><th>Статус</th></tr></thead><tbody>';
                
                payments.forEach(payment => {
                    html += `<tr>
                        <td>${new Date(payment.payment_date).toLocaleDateString('ru-RU')}</td>
                        <td>${payment.amount} ₽</td>
                        <td>${payment.purpose || 'Членский взнос'}</td>
                        <td>${payment.month}.${payment.year}</td>
                        <td><span class="status-badge status-paid">Оплачено</span></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else {
                html = '<p>История платежей пуста.</p>';
            }
            
            document.getElementById('paymentsHistory').innerHTML = html;
        }
        
        // Функция загрузки дашборда администратора
        async function loadAdminDashboard() {
            // Получаем общее количество пользователей
            const { count: totalUsers } = await supabase
                .from('users')
                .select('*', { count: 'exact', head: true });
                
            document.getElementById('totalUsers').textContent = totalUsers || 0;
            
            // Получаем количество неподавших показания за текущий месяц
            const startOfMonth = new Date(currentYear, currentMonth - 1, 1).toISOString().split('T')[0];
            
            const { data: usersWithReadings } = await supabase
                .from('readings')
                .select('user_id')
                .eq('month', currentMonth)
                .eq('year', currentYear)
                .gte('reading_date', startOfMonth);
                
            const usersSubmitted = new Set(usersWithReadings?.map(r => r.user_id) || []).size;
            const submittedReadings = usersSubmitted || 0;
            
            document.getElementById('submittedReadings').textContent = submittedReadings;
            
            // Рассчитываем непогашенные взносы (упрощенный расчет)
            const { data: allUsers } = await supabase
                .from('users')
                .select('id, plots, acres')
                .eq('role', 'user');
                
            let totalUnpaid = 0;
            
            if (allUsers) {
                // Получаем текущие тарифы
                const { data: membershipTariff } = await supabase
                    .from('membership_tariffs')
                    .select('*')
                    .eq('month', currentMonth)
                    .eq('year', currentYear)
                    .single();
                    
                if (membershipTariff) {
                    allUsers.forEach(user => {
                        const userTotal = (user.plots || 0) * membershipTariff.salary_per_plot +
                                        (user.acres || 0) * membershipTariff.maintenance_per_acre +
                                        (membershipTariff.additional_field1_rate || 0) +
                                        (membershipTariff.additional_field2_rate || 0) +
                                        (membershipTariff.additional_field3_rate || 0);
                        totalUnpaid += userTotal;
                    });
                }
            }
            
            document.getElementById('unpaidFees').textContent = totalUnpaid.toFixed(2) + ' ₽';
        }
        
        // Функция загрузки таблицы пользователей для админа
        async function loadUsersTable() {
            const { data: users, error } = await supabase
                .from('users')
                .select('*')
                .order('full_name');
                
            if (error) {
                console.error('Ошибка загрузки пользователей:', error);
                document.getElementById('usersTable').innerHTML = '<p>Ошибка загрузки данных</p>';
                return;
            }
            
            let html = '<table class="table"><thead><tr><th>ID</th><th>ФИО</th><th>Логин</th><th>Роль</th><th>Участки</th><th>Сотки</th><th>Телефон</th><th>Действия</th></tr></thead><tbody>';
            
            users.forEach(user => {
                html += `<tr>
                    <td>${user.id.substring(0, 8)}...</td>
                    <td>${user.full_name}</td>
                    <td>${user.username}</td>
                    <td><span class="status-badge ${user.role === 'admin' ? 'status-paid' : 'status-unpaid'}">${user.role}</span></td>
                    <td>${user.plots || 0}</td>
                    <td>${user.acres || 0}</td>
                    <td>${user.phone || '—'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editUser('${user.id}')" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')" title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('usersTable').innerHTML = html;
        }
        
        // Функция загрузки управления тарифами
        async function loadTariffsManagement() {
            let html = `
            <div class="tabs">
                <div class="tab active" onclick="switchTariffTab('electricity')">Электроэнергия</div>
                <div class="tab" onclick="switchTariffTab('membership')">Членские взносы</div>
            </div>
            
            <div id="electricityTariffs" class="tab-content active">
                <h3>Тарифы на электроэнергию</h3>
                <div id="electricityTariffsContent"></div>
            </div>
            
            <div id="membershipTariffs" class="tab-content">
                <h3>Тарифы на членские взносы</h3>
                <div id="membershipTariffsContent"></div>
            </div>`;
            
            document.getElementById('tariffsManagement').innerHTML = html;
            
            // Загружаем тарифы на электроэнергию
            await loadElectricityTariffs();
        }
        
        // Функция переключения вкладок тарифов
        function switchTariffTab(tabType) {
            // Убираем активный класс со всех вкладок
            document.querySelectorAll('#tariffsManagement .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#tariffsManagement .tab-content').forEach(content => content.classList.remove('active'));
            
            // Активируем выбранную вкладку
            document.querySelector(`#tariffsManagement .tab:nth-child(${tabType === 'electricity' ? 1 : 2})`).classList.add('active');
            document.getElementById(`${tabType}Tariffs`).classList.add('active');
            
            // Загружаем соответствующие тарифы
            if (tabType === 'electricity') {
                loadElectricityTariffs();
            } else {
                loadMembershipTariffs();
            }
        }
        
        // Функция загрузки тарифов на электроэнергию
        async function loadElectricityTariffs() {
            const { data: tariffs } = await supabase
                .from('electricity_tariffs')
                .select('*')
                .order('year', { ascending: false })
                .order('month', { ascending: false });
                
            let html = '';
            
            if (tariffs && tariffs.length > 0) {
                html = `
                <button class="btn btn-success" onclick="showAddTariffModal('electricity')" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Добавить тариф
                </button>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Месяц/Год</th>
                            <th>Потери (₽/кВт·ч)</th>
                            <th>До 100 кВт·ч (₽/кВт·ч)</th>
                            <th>Свыше 100 кВт·ч (₽/кВт·ч)</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                tariffs.forEach(tariff => {
                    html += `<tr>
                        <td>${tariff.month}.${tariff.year}</td>
                        <td>${tariff.loss_rate}</td>
                        <td>${tariff.rate_under_100}</td>
                        <td>${tariff.rate_over_100}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editTariff('electricity', '${tariff.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTariff('electricity', '${tariff.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else {
                html = `
                <p>Тарифы не установлены.</p>
                <button class="btn btn-success" onclick="showAddTariffModal('electricity')">
                    <i class="fas fa-plus"></i> Добавить тариф
                </button>`;
            }
            
            document.getElementById('electricityTariffsContent').innerHTML = html;
        }
        
        // Функция загрузки тарифов на членские взносы
        async function loadMembershipTariffs() {
            const { data: tariffs } = await supabase
                .from('membership_tariffs')
                .select('*')
                .order('year', { ascending: false })
                .order('month', { ascending: false });
                
            let html = '';
            
            if (tariffs && tariffs.length > 0) {
                html = `
                <button class="btn btn-success" onclick="showAddTariffModal('membership')" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Добавить тариф
                </button>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Месяц/Год</th>
                            <th>Зарплата за участок (₽)</th>
                            <th>Содержание за сотку (₽)</th>
                            <th>Доп. поле 1</th>
                            <th>Доп. поле 2</th>
                            <th>Доп. поле 3</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                tariffs.forEach(tariff => {
                    html += `<tr>
                        <td>${tariff.month}.${tariff.year}</td>
                        <td>${tariff.salary_per_plot}</td>
                        <td>${tariff.maintenance_per_acre}</td>
                        <td>${tariff.additional_field1_name || '—'}<br><small>${tariff.additional_field1_rate || 0} ₽</small></td>
                        <td>${tariff.additional_field2_name || '—'}<br><small>${tariff.additional_field2_rate || 0} ₽</small></td>
                        <td>${tariff.additional_field3_name || '—'}<br><small>${tariff.additional_field3_rate || 0} ₽</small></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editTariff('membership', '${tariff.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTariff('membership', '${tariff.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else {
                html = `
                <p>Тарифы не установлены.</p>
                <button class="btn btn-success" onclick="showAddTariffModal('membership')">
                    <i class="fas fa-plus"></i> Добавить тариф
                </button>`;
            }
            
            document.getElementById('membershipTariffsContent').innerHTML = html;
        }
        
        // Функция загрузки пакетных операций
        async function loadBulkOperations() {
            const html = `
            <div class="card">
                <h3>Пакетная загрузка показаний</h3>
                <p>Загрузите CSV файл с показаниями счетчиков.</p>
                <div class="form-group">
                    <label class="form-label">Файл CSV</label>
                    <input type="file" id="bulkUploadFile" class="form-control" accept=".csv">
                    <small>Формат: user_id,meter_number,reading_value,reading_date</small>
                </div>
                <button class="btn btn-primary" onclick="uploadBulkReadings()">
                    <i class="fas fa-upload"></i> Загрузить
                </button>
            </div>
            
            <div class="card">
                <h3>Пакетная выгрузка данных</h3>
                <p>Выгрузите данные в формате CSV или Excel.</p>
                <div class="admin-controls">
                    <button class="btn btn-success" onclick="exportToCSV('users')">
                        <i class="fas fa-download"></i> Выгрузить пользователей (CSV)
                    </button>
                    <button class="btn btn-success" onclick="exportToCSV('readings')">
                        <i class="fas fa-download"></i> Выгрузить показания (CSV)
                    </button>
                    <button class="btn btn-success" onclick="exportToCSV('payments')">
                        <i class="fas fa-download"></i> Выгрузить платежи (CSV)
                    </button>
                </div>
            </div>`;
            
            document.getElementById('bulkOperationsContent').innerHTML = html;
        }
        
        // Функция экспорта данных
        async function exportToCSV(tableName) {
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*');
                    
                if (error) throw error;
                
                // Преобразуем в CSV
                const headers = Object.keys(data[0] || {}).join(',');
                const rows = data.map(row => 
                    Object.values(row).map(value => 
                        typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value
                    ).join(',')
                );
                
                const csv = [headers, ...rows].join('\n');
                
                // Создаем файл для скачивания
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${tableName}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Ошибка экспорта:', error);
                alert('Ошибка при экспорте данных');
            }
        }
        
        // Модальное окно для добавления пользователя
        function showAddUserModal() {
            const modalHtml = `
            <div id="addUserModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000;">
                <div style="background-color:white; padding:30px; border-radius:8px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto;">
                    <h2 style="margin-bottom:20px; color:var(--primary-color);">Добавить пользователя</h2>
                    <div id="addUserForm">
                        <div class="form-group">
                            <label class="form-label">ФИО</label>
                            <input type="text" id="newUserName" class="form-control" placeholder="Иванов Иван Иванович">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Логин</label>
                            <input type="text" id="newUserLogin" class="form-control" placeholder="ivanov">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Пароль</label>
                            <input type="password" id="newUserPassword" class="form-control" placeholder="Пароль">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Роль</label>
                            <select id="newUserRole" class="form-control">
                                <option value="user">Пользователь</option>
                                <option value="admin">Администратор</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Количество участков</label>
                            <input type="number" id="newUserPlots" class="form-control" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Количество соток</label>
                            <input type="number" step="0.01" id="newUserAcres" class="form-control" value="6.00" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Телефон</label>
                            <input type="tel" id="newUserPhone" class="form-control" placeholder="+79999999999">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Адрес</label>
                            <textarea id="newUserAddress" class="form-control" rows="3" placeholder="Адрес участка"></textarea>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn btn-success" onclick="saveNewUser()">Сохранить</button>
                        <button class="btn btn-danger" onclick="closeModal('addUserModal')">Отмена</button>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Функция сохранения нового пользователя
        async function saveNewUser() {
            const newUser = {
                full_name: document.getElementById('newUserName').value,
                username: document.getElementById('newUserLogin').value,
                password: document.getElementById('newUserPassword').value,
                role: document.getElementById('newUserRole').value,
                plots: parseInt(document.getElementById('newUserPlots').value) || 1,
                acres: parseFloat(document.getElementById('newUserAcres').value) || 6.0,
                phone: document.getElementById('newUserPhone').value,
                address: document.getElementById('newUserAddress').value
            };
            
            if (!newUser.full_name || !newUser.username || !newUser.password) {
                alert('Заполните обязательные поля: ФИО, логин и пароль');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .insert([newUser]);
                    
                if (error) throw error;
                
                alert('Пользователь успешно добавлен!');
                closeModal('addUserModal');
                loadUsersTable();
                
            } catch (error) {
                console.error('Ошибка сохранения пользователя:', error);
                alert('Ошибка при сохранении пользователя');
            }
        }
        
        // Функция закрытия модального окна
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }
        
        // Функция добавления счетчика
        function showAddMeterModal() {
            const modalHtml = `
            <div id="addMeterModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000;">
                <div style="background-color:white; padding:30px; border-radius:8px; max-width:400px; width:100%;">
                    <h2 style="margin-bottom:20px; color:var(--primary-color);">Добавить счетчик</h2>
                    <div id="addMeterForm">
                        <div class="form-group">
                            <label class="form-label">Номер счетчика</label>
                            <input type="text" id="newMeterNumber" class="form-control" placeholder="123456">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Начальные показания (опционально)</label>
                            <input type="number" step="0.01" id="newMeterInitial" class="form-control" placeholder="0.00">
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn btn-success" onclick="saveNewMeter()">Сохранить</button>
                        <button class="btn btn-danger" onclick="closeModal('addMeterModal')">Отмена</button>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Функция сохранения нового счетчика
        async function saveNewMeter() {
            const meterNumber = document.getElementById('newMeterNumber').value;
            const initialReading = document.getElementById('newMeterInitial').value;
            
            if (!meterNumber) {
                alert('Введите номер счетчика');
                return;
            }
            
            const newMeter = {
                user_id: currentUser.id,
                meter_number: meterNumber,
                last_reading: initialReading || null,
                last_reading_date: initialReading ? new Date().toISOString().split('T')[0] : null
            };
            
            try {
                const { error } = await supabase
                    .from('meters')
                    .insert([newMeter]);
                    
                if (error) throw error;
                
                alert('Счетчик успешно добавлен!');
                closeModal('addMeterModal');
                loadElectricityForm();
                loadUserMeters();
                
            } catch (error) {
                console.error('Ошибка сохранения счетчика:', error);
                alert('Ошибка при сохранении счетчика');
            }
        }
        
        // Функция редактирования пользователя
        async function editUser(userId) {
            const { data: user } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();
                
            if (!user) {
                alert('Пользователь не найден');
                return;
            }
            
            const modalHtml = `
            <div id="editUserModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000;">
                <div style="background-color:white; padding:30px; border-radius:8px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto;">
                    <h2 style="margin-bottom:20px; color:var(--primary-color);">Редактировать пользователя</h2>
                    <div id="editUserForm">
                        <div class="form-group">
                            <label class="form-label">ФИО</label>
                            <input type="text" id="editUserName" class="form-control" value="${user.full_name || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Логин</label>
                            <input type="text" id="editUserLogin" class="form-control" value="${user.username || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Новый пароль (оставьте пустым, если не меняется)</label>
                            <input type="password" id="editUserPassword" class="form-control" placeholder="Новый пароль">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Роль</label>
                            <select id="editUserRole" class="form-control">
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>Пользователь</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Администратор</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Количество участков</label>
                            <input type="number" id="editUserPlots" class="form-control" value="${user.plots || 1}" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Количество соток</label>
                            <input type="number" step="0.01" id="editUserAcres" class="form-control" value="${user.acres || 6.00}" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Телефон</label>
                            <input type="tel" id="editUserPhone" class="form-control" value="${user.phone || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Адрес</label>
                            <textarea id="editUserAddress" class="form-control" rows="3">${user.address || ''}</textarea>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn btn-success" onclick="saveUserChanges('${user.id}')">Сохранить</button>
                        <button class="btn btn-danger" onclick="closeModal('editUserModal')">Отмена</button>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Функция сохранения изменений пользователя
        async function saveUserChanges(userId) {
            const updatedUser = {
                full_name: document.getElementById('editUserName').value,
                username: document.getElementById('editUserLogin').value,
                role: document.getElementById('editUserRole').value,
                plots: parseInt(document.getElementById('editUserPlots').value) || 1,
                acres: parseFloat(document.getElementById('editUserAcres').value) || 6.0,
                phone: document.getElementById('editUserPhone').value,
                address: document.getElementById('editUserAddress').value
            };
            
            // Обновляем пароль только если он указан
            const newPassword = document.getElementById('editUserPassword').value;
            if (newPassword) {
                updatedUser.password = newPassword;
            }
            
            if (!updatedUser.full_name || !updatedUser.username) {
                alert('Заполните обязательные поля: ФИО и логин');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update(updatedUser)
                    .eq('id', userId);
                    
                if (error) throw error;
                
                alert('Данные пользователя обновлены!');
                closeModal('editUserModal');
                loadUsersTable();
                
            } catch (error) {
                console.error('Ошибка обновления пользователя:', error);
                alert('Ошибка при обновлении данных пользователя');
            }
        }
        
        // Функция удаления пользователя
        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                    
                if (error) throw error;
                
                alert('Пользователь удален!');
                loadUsersTable();
                
            } catch (error) {
                console.error('Ошибка удаления пользователя:', error);
                alert('Ошибка при удалении пользователя');
            }
        }
        
        // Функция отображения модального окна добавления тарифа
        function showAddTariffModal(type) {
            const isElectricity = type === 'electricity';
            const title = isElectricity ? 'Добавить тариф на электроэнергию' : 'Добавить тариф на членские взносы';
            
            let formHtml = '';
            
            if (isElectricity) {
                formHtml = `
                <div class="form-group">
                    <label class="form-label">Месяц</label>
                    <select id="newTariffMonth" class="form-control">
                        ${Array.from({length: 12}, (_, i) => 
                            `<option value="${i+1}" ${i+1 === currentMonth ? 'selected' : ''}>${i+1} - ${getMonthName(i+1)}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Год</label>
                    <input type="number" id="newTariffYear" class="form-control" value="${currentYear}" min="2023" max="2030">
                </div>
                <div class="form-group">
                    <label class="form-label">Тариф на потери (₽/кВт·ч)</label>
                    <input type="number" step="0.0001" id="newTariffLoss" class="form-control" value="0.36" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Тариф до 100 кВт·ч (₽/кВт·ч)</label>
                    <input type="number" step="0.01" id="newTariffUnder100" class="form-control" value="6.10" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Тариф свыше 100 кВт·ч (₽/кВт·ч)</label>
                    <input type="number" step="0.01" id="newTariffOver100" class="form-control" value="7.30" min="0">
                </div>`;
            } else {
                formHtml = `
                <div class="form-group">
                    <label class="form-label">Месяц</label>
                    <select id="newTariffMonth" class="form-control">
                        ${Array.from({length: 12}, (_, i) => 
                            `<option value="${i+1}" ${i+1 === currentMonth ? 'selected' : ''}>${i+1} - ${getMonthName(i+1)}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Год</label>
                    <input type="number" id="newTariffYear" class="form-control" value="${currentYear}" min="2023" max="2030">
                </div>
                <div class="form-group">
                    <label class="form-label">Зарплата за участок (₽)</label>
                    <input type="number" step="0.01" id="newTariffSalary" class="form-control" value="939.00" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Содержание за сотку (₽)</label>
                    <input type="number" step="0.01" id="newTariffMaintenance" class="form-control" value="44.00" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Доп. поле 1 - Название</label>
                    <input type="text" id="newTariffField1Name" class="form-control" value="Ремонт дорог">
                </div>
                <div class="form-group">
                    <label class="form-label">Доп. поле 1 - Сумма (₽)</label>
                    <input type="number" step="0.01" id="newTariffField1Rate" class="form-control" value="200.00" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Доп. поле 2 - Название</label>
                    <input type="text" id="newTariffField2Name" class="form-control" value="Вывоз мусора">
                </div>
                <div class="form-group">
                    <label class="form-label">Доп. поле 2 - Сумма (₽)</label>
                    <input type="number" step="0.01" id="newTariffField2Rate" class="form-control" value="150.00" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Доп. поле 3 - Название</label>
                    <input type="text" id="newTariffField3Name" class="form-control" value="Охрана">
                </div>
                <div class="form-group">
                    <label class="form-label">Доп. поле 3 - Сумма (₽)</label>
                    <input type="number" step="0.01" id="newTariffField3Rate" class="form-control" value="300.00" min="0">
                </div>`;
            }
            
            const modalHtml = `
            <div id="addTariffModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000;">
                <div style="background-color:white; padding:30px; border-radius:8px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto;">
                    <h2 style="margin-bottom:20px; color:var(--primary-color);">${title}</h2>
                    <div id="addTariffForm">
                        ${formHtml}
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn btn-success" onclick="saveNewTariff('${type}')">Сохранить</button>
                        <button class="btn btn-danger" onclick="closeModal('addTariffModal')">Отмена</button>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Вспомогательная функция для получения названия месяца
        function getMonthName(monthNumber) {
            const months = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            return months[monthNumber - 1];
        }
        
        // Функция сохранения нового тарифа
        async function saveNewTariff(type) {
            const isElectricity = type === 'electricity';
            const month = parseInt(document.getElementById('newTariffMonth').value);
            const year = parseInt(document.getElementById('newTariffYear').value);
            
            let newTariff;
            
            if (isElectricity) {
                newTariff = {
                    month: month,
                    year: year,
                    loss_rate: parseFloat(document.getElementById('newTariffLoss').value),
                    rate_under_100: parseFloat(document.getElementById('newTariffUnder100').value),
                    rate_over_100: parseFloat(document.getElementById('newTariffOver100').value)
                };
            } else {
                newTariff = {
                    month: month,
                    year: year,
                    salary_per_plot: parseFloat(document.getElementById('newTariffSalary').value),
                    maintenance_per_acre: parseFloat(document.getElementById('newTariffMaintenance').value),
                    additional_field1_name: document.getElementById('newTariffField1Name').value,
                    additional_field2_name: document.getElementById('newTariffField2Name').value,
                    additional_field3_name: document.getElementById('newTariffField3Name').value,
                    additional_field1_rate: parseFloat(document.getElementById('newTariffField1Rate').value),
                    additional_field2_rate: parseFloat(document.getElementById('newTariffField2Rate').value),
                    additional_field3_rate: parseFloat(document.getElementById('newTariffField3Rate').value)
                };
            }
            
            try {
                const tableName = isElectricity ? 'electricity_tariffs' : 'membership_tariffs';
                const { error } = await supabase
                    .from(tableName)
                    .insert([newTariff]);
                    
                if (error) throw error;
                
                alert('Тариф успешно добавлен!');
                closeModal('addTariffModal');
                
                // Обновляем соответствующую таблицу тарифов
                if (isElectricity) {
                    loadElectricityTariffs();
                } else {
                    loadMembershipTariffs();
                }
                
            } catch (error) {
                console.error('Ошибка сохранения тарифа:', error);
                alert('Ошибка при сохранении тарифа');
            }
        }
        
        // Функция удаления тарифа
        async function deleteTariff(type, tariffId) {
            if (!confirm('Вы уверены, что хотите удалить этот тариф?')) {
                return;
            }
            
            const tableName = type === 'electricity' ? 'electricity_tariffs' : 'membership_tariffs';
            
            try {
                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', tariffId);
                    
                if (error) throw error;
                
                alert('Тариф удален!');
                
                // Обновляем соответствующую таблицу тарифов
                if (type === 'electricity') {
                    loadElectricityTariffs();
                } else {
                    loadMembershipTariffs();
                }
                
            } catch (error) {
                console.error('Ошибка удаления тарифа:', error);
                alert('Ошибка при удалении тарифа');
            }
        }
        
        // Функция для пакетной загрузки показаний
        async function uploadBulkReadings() {
            const fileInput = document.getElementById('bulkUploadFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Выберите файл для загрузки');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());
                
                if (lines.length <= 1) {
                    alert('Файл пуст или содержит только заголовки');
                    return;
                }
                
                // Пропускаем заголовок (первую строку)
                const dataLines = lines.slice(1);
                let successCount = 0;
                let errorCount = 0;
                
                for (const line of dataLines) {
                    const [userId, meterNumber, readingValue, readingDate] = line.split(',');
                    
                    if (!userId || !meterNumber || !readingValue || !readingDate) {
                        errorCount++;
                        continue;
                    }
                    
                    try {
                        // Находим счетчик
                        const { data: meter } = await supabase
                            .from('meters')
                            .select('id, last_reading')
                            .eq('meter_number', meterNumber.trim())
                            .single();
                            
                        if (!meter) {
                            errorCount++;
                            continue;
                        }
                        
                        // Рассчитываем потребление
                        const previousReading = meter.last_reading || 0;
                        const consumption = parseFloat(readingValue) - previousReading;
                        
                        if (consumption < 0) {
                            errorCount++;
                            continue;
                        }
                        
                        // Получаем месяц и год из даты
                        const date = new Date(readingDate);
                        const month = date.getMonth() + 1;
                        const year = date.getFullYear();
                        
                        // Сохраняем показания
                        const { error: readingError } = await supabase
                            .from('readings')
                            .insert([{
                                user_id: userId.trim(),
                                meter_id: meter.id,
                                meter_number: meterNumber.trim(),
                                reading_value: parseFloat(readingValue),
                                reading_date: readingDate.trim(),
                                consumption: consumption,
                                month: month,
                                year: year
                            }]);
                            
                        if (readingError) {
                            errorCount++;
                            continue;
                        }
                        
                        // Обновляем счетчик
                        const { error: meterError } = await supabase
                            .from('meters')
                            .update({
                                last_reading: readingValue,
                                last_reading_date: readingDate
                            })
                            .eq('id', meter.id);
                            
                        if (meterError) {
                            errorCount++;
                            continue;
                        }
                        
                        successCount++;
                        
                    } catch (error) {
                        errorCount++;
                        console.error('Ошибка обработки строки:', line, error);
                    }
                }
                
                alert(`Загрузка завершена!\nУспешно: ${successCount}\nОшибок: ${errorCount}`);
                
                // Очищаем поле файла
                fileInput.value = '';
                
            };
            
            reader.readAsText(file);
        }
        
        // Функция экспорта данных
        function exportData() {
            alert('Функция экспорта данных будет реализована в следующей версии');
        }
        
        // Функция импорта данных
        function showImportModal() {
            alert('Функция импорта данных будет реализована в следующей версии');
        }
        
        // Функция генерации месячного отчета
        function generateMonthlyReport() {
            alert('Функция генерации отчета будет реализована в следующей версии');
        }
        
        // Запускаем инициализацию приложения при загрузке страницы
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Создаем SQL функции для создания таблиц (если они еще не созданы)
        // Это будет выполнено при первом запуске
        async function createRPCTables() {
            // Эта функция вызывается из checkSupabaseConnection при необходимости
            // В реальном приложении таблицы создаются через миграции или вручную
            console.log('Таблицы создаются при первом запуске...');
        }
        
    </script>
</body>
</html>
