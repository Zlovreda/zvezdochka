<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ù–¢ "–ó–≤–µ–∑–¥–æ—á–∫–∞" - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* –®–∞–ø–∫–∞ */
        header { background: #2c3e50; color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 8px 25px rgba(0,0,0,0.15); display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 2.2rem; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .role-badge { background: #e74c3c; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        .role-badge.admin { background: #27ae60; }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .content { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; }
        .main-content { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .sidebar { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        
        /* –§–æ—Ä–º—ã */
        .form-section { margin-bottom: 2.5rem; padding-bottom: 2rem; border-bottom: 2px solid #f0f0f0; }
        h2 { color: #2c3e50; margin-bottom: 1.5rem; font-size: 1.6rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; transition: border 0.3s; }
        .form-group input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { background: #3498db; color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219955; }
        .btn-logout { background: #e74c3c; }
        .btn-logout:hover { background: #c0392b; }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .table-container { overflow-x: auto; margin-top: 1.5rem; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 1rem; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #dee2e6; }
        td { padding: 1rem; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        
        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        #systemLog { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1.5rem; border-left: 4px solid #3498db; font-family: monospace; max-height: 200px; overflow-y: auto; }
        .log-entry { margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
        .log-success { color: #27ae60; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 900px) {
            .content { grid-template-columns: 1fr; }
            header { flex-direction: column; gap: 15px; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–ê–ü–ö–ê –° –ò–ù–§–û–†–ú–ê–¶–ò–ï–ô –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï -->
        <header>
            <h1>üìä –°–ù–¢ "–ó–≤–µ–∑–¥–æ—á–∫–∞" - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
            <div class="user-info" id="userInfo">
                <span id="userName">–ì–æ—Å—Ç—å</span>
                <span id="userRole" class="role-badge">–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                <button id="logoutBtn" class="btn btn-logout" style="display:none;">üö™ –í—ã–π—Ç–∏</button>
            </div>
        </header>

        <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
        <div class="content">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º—ã –∏ –¥–∞–Ω–Ω—ã–µ -->
            <div class="main-content">
                <!-- –ë–õ–û–ö –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
                <section id="authSection" class="form-section">
                    <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" placeholder="–≤–∞—à@email.com">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <button id="loginBtn" class="btn">üëâ –í–æ–π—Ç–∏</button>
                    <button id="registerBtn" class="btn btn-success">üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    
                    <!-- –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞ -->
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                        <strong>–¢–µ—Å—Ç–æ–≤—ã–π –¥–æ—Å—Ç—É–ø:</strong><br>
                        ‚Ä¢ –ê–¥–º–∏–Ω: <code>admin@zvezdochka.test</code> / <code>admin123</code><br>
                        ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>user@zvezdochka.test</code> / <code>user123</code>
                    </div>
                </section>

                <!-- –ë–õ–û–ö –î–õ–Ø –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–• -->
                <div id="authenticatedContent" style="display:none;">
                    <!-- –í–≤–æ–¥ –ø–æ–∫–∞–∑–∞–Ω–∏–π -->
                    <section class="form-section">
                        <h2>‚ö° –ü–æ–∫–∞–∑–∞–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏</h2>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="readingMonth">–ú–µ—Å—è—Ü</label>
                                <input type="month" id="readingMonth" required>
                            </div>
                            <div class="form-group">
                                <label for="meterReading">–ü–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ (–∫–í—Ç¬∑—á)</label>
                                <input type="number" id="meterReading" min="0" step="1" required>
                            </div>
                        </div>
                        <button id="submitReadingBtn" class="btn btn-success">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è</button>
                    </section>

                    <!-- –†–∞—Å—á—ë—Ç –æ–ø–ª–∞—Ç—ã -->
                    <section class="form-section">
                        <h2>üßÆ –†–∞—Å—á—ë—Ç –æ–ø–ª–∞—Ç—ã</h2>
                        <div id="calculationResult" style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≤–≤–µ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.</p>
                        </div>
                    </section>

                    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π -->
                    <section class="form-section">
                        <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π</h2>
                        <div class="table-container">
                            <table id="readingsTable">
                                <thead><tr><th>–ú–µ—Å—è—Ü</th><th>–ü–æ–∫–∞–∑–∞–Ω–∏—è</th><th>–î–∞—Ç–∞ –≤–Ω–µ—Å–µ–Ω–∏—è</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
                    <section id="adminSection" class="form-section" style="display:none;">
                        <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                        
                        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                        <h3>üë• –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (CSV)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="usersFile">CSV —Ñ–∞–π–ª</label>
                                <input type="file" id="usersFile" accept=".csv">
                            </div>
                        </div>
                        <button id="uploadUsersBtn" class="btn">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
                        
                        <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö -->
                        <h3 style="margin-top: 2rem;">üìã –í—Å–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div class="table-container">
                            <table id="allReadingsTable">
                                <thead><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–ú–µ—Å—è—Ü</th><th>–ü–æ–∫–∞–∑–∞–Ω–∏—è</th><th>–î–∞—Ç–∞</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –ª–æ–≥–∏ -->
            <div class="sidebar">
                <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö</h3>
                <div id="tariffsInfo" style="margin-bottom: 2rem;">
                    <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã...</p>
                </div>
                
                <h3>üìã –°–∏—Å—Ç–µ–º–Ω—ã–π –∂—É—Ä–Ω–∞–ª</h3>
                <div id="systemLog"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_9NXa4FwnnrICXnXmrOVqRg_KB5LHkmk';
        let supabase;
        let currentUser = null;
        let currentTariffs = null;

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            setupEventListeners();
            await checkSupabaseConnection();
            await loadTariffs();
        });

        async function initializeApp() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                addLog('‚úÖ –ö–ª–∏–µ–Ω—Ç Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;
                if (session) {
                    currentUser = session.user;
                    await handleSuccessfulAuth();
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }

        // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
        async function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('submitReadingBtn').addEventListener('click', submitReading);
            document.getElementById('uploadUsersBtn').addEventListener('click', uploadUsersBatch);
            document.getElementById('meterReading').addEventListener('input', calculatePayment);
            document.getElementById('readingMonth').addEventListener('change', loadUserReadings);
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                addLog('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, 'error');
                return;
            }
            
            currentUser = data.user;
            addLog(`‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${email}`, 'success');
            await handleSuccessfulAuth();
        }

        async function handleRegister() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                return;
            }
            
            addLog(`‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É ${email}`, 'success');
        }

        async function handleSuccessfulAuth() {
            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            // –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ñ–∏–ª—å, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!profile) {
                const { error } = await supabase.from('profiles').insert([{
                    id: currentUser.id,
                    full_name: currentUser.email.split('@')[0],
                    role: currentUser.email === 'admin@zvezdochka.test' ? 'admin' : 'user'
                }]);
                if (error) addLog(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ${error.message}`, 'error');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('authenticatedContent').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('userName').textContent = profile?.full_name || currentUser.email;
            document.getElementById('userRole').textContent = profile?.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userRole').className = `role-badge ${profile?.role}`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            if (profile?.role === 'admin') {
                document.getElementById('adminSection').style.display = 'block';
                await loadAllReadings();
            }

            await loadUserReadings();
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            location.reload();
        }

        // ==================== –ü–û–ö–ê–ó–ê–ù–ò–Ø –ò –†–ê–°–ß–Å–¢–´ ====================
        async function submitReading() {
            const month = document.getElementById('readingMonth').value;
            const reading = parseInt(document.getElementById('meterReading').value);
            
            if (!month || isNaN(reading)) {
                addLog('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'error');
                return;
            }

            const monthDate = `${month}-01`; // –§–æ—Ä–º–∞—Ç YYYY-MM-DD
            const { error } = await supabase
                .from('electricity_readings')
                .upsert([{ user_id: currentUser.id, month: monthDate, meter_reading: reading }]);

            if (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
                return;
            }

            addLog(`‚úÖ –ü–æ–∫–∞–∑–∞–Ω–∏—è –∑–∞ ${month} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${reading} –∫–í—Ç¬∑—á`, 'success');
            await loadUserReadings();
            calculatePayment();
        }

        async function calculatePayment() {
            const reading = parseInt(document.getElementById('meterReading').value);
            const month = document.getElementById('readingMonth').value;
            
            if (!currentTariffs || isNaN(reading) || !month) return;

            const losses = reading * currentTariffs.losses;
            const under100 = Math.min(reading, 100) * currentTariffs.under_100;
            const over100 = Math.max(reading - 100, 0) * currentTariffs.over_100;
            const total = losses + under100 + over100;

            document.getElementById('calculationResult').innerHTML = `
                <h3>–†–∞—Å—á—ë—Ç –∑–∞ ${month}</h3>
                <p>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ: <strong>${reading} –∫–í—Ç¬∑—á</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>–ü–æ—Ç–µ—Ä–∏ (${currentTariffs.losses} ‚ÇΩ/–∫–í—Ç¬∑—á): <strong>${losses.toFixed(2)} ‚ÇΩ</strong></li>
                    <li>–î–æ 100 –∫–í—Ç¬∑—á (${currentTariffs.under_100} ‚ÇΩ/–∫–í—Ç¬∑—á): <strong>${under100.toFixed(2)} ‚ÇΩ</strong></li>
                    <li>–°–≤—ã—à–µ 100 –∫–í—Ç¬∑—á (${currentTariffs.over_100} ‚ÇΩ/–∫–í—Ç¬∑—á): <strong>${over100.toFixed(2)} ‚ÇΩ</strong></li>
                </ul>
                <h4>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: <span style="color:#e74c3c;">${total.toFixed(2)} ‚ÇΩ</span></h4>
            `;
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====================
        async function loadUserReadings() {
            if (!currentUser) return;
            
            const { data, error } = await supabase
                .from('electricity_readings')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('month', { ascending: false });

            if (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–∏–π: ${error.message}`, 'error');
                return;
            }

            const tbody = document.getElementById('readingsTable').querySelector('tbody');
            tbody.innerHTML = data.map(reading => `
                <tr>
                    <td>${reading.month.substring(0,7)}</td>
                    <td>${reading.meter_reading} –∫–í—Ç¬∑—á</td>
                    <td>${new Date(reading.created_at).toLocaleDateString('ru-RU')}</td>
                </tr>
            `).join('') || '<tr><td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        }

        async function loadAllReadings() {
            const { data, error } = await supabase
                .from('electricity_readings')
                .select(`
                    *,
                    profiles (full_name)
                `)
                .order('month', { ascending: false });

            if (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                return;
            }

            const tbody = document.getElementById('allReadingsTable').querySelector('tbody');
            tbody.innerHTML = data.map(reading => `
                <tr>
                    <td>${reading.profiles?.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                    <td>${reading.month.substring(0,7)}</td>
                    <td>${reading.meter_reading} –∫–í—Ç¬∑—á</td>
                    <td>${new Date(reading.created_at).toLocaleDateString('ru-RU')}</td>
                </tr>
            `).join('') || '<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        }

        async function loadTariffs() {
            const { data, error } = await supabase
                .from('tariffs')
                .select('*')
                .order('valid_from', { ascending: false });

            if (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤: ${error.message}`, 'error');
                return;
            }

            // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–∞—Ä–∏—Ñ—ã
            currentTariffs = {
                losses: parseFloat(data.find(t => t.name === 'losses')?.price_per_kwh || 0.36),
                under_100: parseFloat(data.find(t => t.name === 'under_100')?.price_per_kwh || 6.10),
                over_100: parseFloat(data.find(t => t.name === 'over_100')?.price_per_kwh || 7.30)
            };

            document.getElementById('tariffsInfo').innerHTML = `
                <p><strong>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã:</strong></p>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>–ü–æ—Ç–µ—Ä–∏: <strong>${currentTariffs.losses} ‚ÇΩ/–∫–í—Ç¬∑—á</strong></li>
                    <li>–î–æ 100 –∫–í—Ç¬∑—á: <strong>${currentTariffs.under_100} ‚ÇΩ/–∫–í—Ç¬∑—á</strong></li>
                    <li>–°–≤—ã—à–µ 100 –∫–í—Ç¬∑—á: <strong>${currentTariffs.over_100} ‚ÇΩ/–∫–í—Ç¬∑—á</strong></li>
                </ul>
            `;
        }

        // ==================== –ê–î–ú–ò–ù-–§–£–ù–ö–¶–ò–ò ====================
        async function uploadUsersBatch() {
            const fileInput = document.getElementById('usersFile');
            if (!fileInput.files.length) {
                addLog('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª', 'error');
                return;
            }

            const file = fileInput.files[0];
            const text = await file.text();
            const rows = text.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫

            addLog(`üìä –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É ${rows.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...`, 'info');

            for (const row of rows) {
                if (!row.trim()) continue;
                const [email, password, full_name, role] = row.split(',');
                
                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email.trim(),
                    password: password.trim(),
                });

                if (authError) {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ${email}: ${authError.message}`, 'error');
                    continue;
                }

                // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                if (authData.user) {
                    await supabase.from('profiles').insert([{
                        id: authData.user.id,
                        full_name: full_name.trim(),
                        role: (role || 'user').trim()
                    }]);
                    addLog(`‚úÖ –°–æ–∑–¥–∞–Ω: ${full_name} (${email})`, 'success');
                }
            }

            addLog('üéâ –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
        }

        // ==================== –°–õ–£–ñ–ï–ë–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        async function checkSupabaseConnection() {
            try {
                const response = await fetch(SUPABASE_URL);
                addLog(`‚úÖ Supabase –¥–æ—Å—Ç—É–ø–µ–Ω (—Å—Ç–∞—Ç—É—Å: ${response.status})`, 'success');
                return true;
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase: ${error.message}`, 'error');
                return false;
            }
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('systemLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('ru-RU')}] ${message}`;
            logDiv.prepend(entry);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            if (logDiv.children.length > 10) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
        async function createTestUsers() {
            const testUsers = [
                { email: 'admin@zvezdochka.test', password: 'admin123', role: 'admin' },
                { email: 'user@zvezdochka.test', password: 'user123', role: 'user' }
            ];

            for (const user of testUsers) {
                const { data: existing } = await supabase
                    .from('profiles')
                    .select('id')
                    .eq('id', user.email)
                    .single();

                if (!existing) {
                    const { data: authData } = await supabase.auth.signUp(user);
                    if (authData?.user) {
                        await supabase.from('profiles').insert([{
                            id: authData.user.id,
                            full_name: user.email.split('@')[0],
                            role: user.role
                        }]);
                    }
                }
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
        setTimeout(createTestUsers, 3000);
    </script>
</body>
</html>
