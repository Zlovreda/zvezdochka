<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СНТ "Звездочка" - Сбор показаний</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }
        
        .card.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        h3 {
            color: #555;
            margin: 15px 0 10px 0;
        }
        
        .auth-form, .user-form {
            display: grid;
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 600;
            color: #555;
        }
        
        input, select, button, textarea {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .nav-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.online {
            background-color: #28a745;
        }
        
        .status-indicator.offline {
            background-color: #dc3545;
        }
        
        .tariff-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .tariff-group {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .calculation-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .calculation-line {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            border-top: 2px solid #dee2e6;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .counter-input {
            font-family: monospace;
            font-size: 18px;
            letter-spacing: 2px;
            text-align: center;
        }
        
        .file-upload {
            border: 2px dashed #667eea;
            padding: 40px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            background: #f8f9ff;
        }
        
        .file-upload input {
            display: none;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .month-selector label {
            font-weight: 600;
            color: #333;
        }
        
        .tariff-history {
            margin-top: 30px;
        }
        
        .tariff-history table {
            margin-top: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge.current {
            background: #28a745;
            color: white;
        }
        
        .badge.future {
            background: #17a2b8;
            color: white;
        }
        
        .badge.past {
            background: #6c757d;
            color: white;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .tariff-inputs {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>СНТ "Звездочка"</h1>
            <p>Система сбора показаний и учета членских взносов</p>
            <div id="status" class="alert info">
                <span id="status-indicator" class="status-indicator offline"></span>
                <span id="status-text">Проверка соединения с сервером...</span>
            </div>
        </div>
        
        <!-- Навигационные кнопки (видны только администратору) -->
        <div id="nav-buttons" class="nav-buttons" style="display: none;">
            <button class="nav-btn" onclick="showCard('user-dashboard')" id="btn-dashboard">Личный кабинет</button>
            <button class="nav-btn" onclick="showCard('admin-users')" id="btn-users">Пользователи</button>
            <button class="nav-btn" onclick="showCard('admin-tariffs')" id="btn-tariffs">Тарифы</button>
            <button class="nav-btn" onclick="showCard('admin-fees')" id="btn-fees">Взносы</button>
            <button class="nav-btn" onclick="showCard('admin-readings')" id="btn-readings">Показания</button>
            <button class="nav-btn" onclick="showCard('admin-import')" id="btn-import">Импорт/Экспорт</button>
        </div>
        
        <!-- Карточка авторизации -->
        <div id="auth-card" class="card active">
            <h2>Вход в систему</h2>
            <div id="auth-alert" class="alert" style="display: none;"></div>
            
            <div class="auth-form">
                <div class="form-group">
                    <label for="login">Логин:</label>
                    <input type="text" id="login" placeholder="Введите ваш логин">
                </div>
                
                <div class="form-group">
                    <label for="password">Пароль:</label>
                    <input type="password" id="password" placeholder="Введите ваш пароль">
                </div>
                
                <div class="form-group">
                    <label for="user-type">Тип входа:</label>
                    <select id="user-type">
                        <option value="user">Пользователь</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                
                <button onclick="login()">Войти</button>
                
                <div style="text-align: center; margin-top: 20px; color: #666;">
                    <p>Демо доступы:</p>
                    <p><strong>Админ:</strong> admin / admin123</p>
                    <p><strong>Пользователь:</strong> user1 / user123</p>
                </div>
            </div>
        </div>
        
        <!-- Личный кабинет пользователя -->
        <div id="user-dashboard" class="card">
            <div id="user-info" class="user-info">
                <div>
                    <h3 style="margin: 0; color: white;">Личный кабинет</h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;" id="welcome-user">Добро пожаловать!</p>
                </div>
                <button class="logout-btn" onclick="logout()">Выйти</button>
            </div>
            
            <!-- Селектор месяца для пользователя -->
            <div class="month-selector">
                <div class="form-group" style="flex: 1;">
                    <label for="user-month">Месяц расчета:</label>
                    <select id="user-month" onchange="loadUserData()">
                        <option value="01">Январь</option>
                        <option value="02">Февраль</option>
                        <option value="03">Март</option>
                        <option value="04">Апрель</option>
                        <option value="05">Май</option>
                        <option value="06">Июнь</option>
                        <option value="07">Июль</option>
                        <option value="08">Август</option>
                        <option value="09">Сентябрь</option>
                        <option value="10">Октябрь</option>
                        <option value="11">Ноябрь</option>
                        <option value="12">Декабрь</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="user-year">Год:</label>
                    <input type="number" id="user-year" min="2024" max="2030" value="2026" onchange="loadUserData()">
                </div>
            </div>
            
            <h2>Передать показания счетчика</h2>
            <div id="user-alert" class="alert" style="display: none;"></div>
            
            <div class="tariff-inputs">
                <div class="tariff-group">
                    <h3>Электроэнергия</h3>
                    <div class="form-group">
                        <label for="user-meter-reading">Текущие показания (кВт·ч):</label>
                        <input type="number" id="user-meter-reading" min="0" step="1" placeholder="763" class="counter-input">
                    </div>
                    <div class="form-group">
                        <label for="user-previous-reading">Предыдущие показания:</label>
                        <input type="number" id="user-previous-reading" min="0" step="1" placeholder="0" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>Тарифы на текущий месяц:</label>
                        <div style="background: #e9ecef; padding: 10px; border-radius: 5px; font-size: 0.9em;">
                            <div>Потери: <span id="user-tariff-losses">0.36</span> руб/кВт·ч</div>
                            <div>До 100 кВт·ч: <span id="user-tariff-under100">6.10</span> руб/кВт·ч</div>
                            <div>Свыше 100 кВт·ч: <span id="user-tariff-over100">7.30</span> руб/кВт·ч</div>
                        </div>
                    </div>
                </div>
                
                <div class="tariff-group">
                    <h3>Членские взносы</h3>
                    <div class="form-group">
                        <label>Зарплата:</label>
                        <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <span id="user-fee-salary">500</span> руб
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Содержание:</label>
                        <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <span id="user-fee-maintenance">800</span> руб
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Прочее:</label>
                        <div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <span id="user-fee-other">200</span> руб
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Итого взносов:</label>
                        <div style="background: #e9ecef; padding: 10px; border-radius: 5px; font-weight: bold;">
                            <span id="user-fee-total">1500</span> руб
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="user-calculation" class="calculation-result">
                <h3 style="margin-top: 0;">Расчет к оплате за <span id="current-month-text">Январь 2026</span>:</h3>
                <div class="calculation-line">
                    <span>Электроэнергия (потери):</span>
                    <span id="calc-losses">0 кВт·ч × 0.36 = 0.00 руб</span>
                </div>
                <div class="calculation-line">
                    <span>Электроэнергия (до 100 кВт·ч):</span>
                    <span id="calc-under100">0 кВт·ч × 6.10 = 0.00 руб</span>
                </div>
                <div class="calculation-line">
                    <span>Электроэнергия (свыше 100 кВт·ч):</span>
                    <span id="calc-over100">0 кВт·ч × 7.30 = 0.00 руб</span>
                </div>
                <div class="calculation-line">
                    <span>Членские взносы:</span>
                    <span id="calc-fees">1500.00 руб</span>
                </div>
                <div class="calculation-line total">
                    <span>Итого к оплате:</span>
                    <span id="calc-total">1500.00 руб</span>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button onclick="submitUserReadings()">Передать показания</button>
                <button class="secondary" onclick="loadUserData()" style="margin-left: 10px;">Обновить данные</button>
            </div>
            
            <h2 style="margin-top: 30px;">История показаний</h2>
            <div class="table-container">
                <table id="user-history-table">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Показания</th>
                            <th>Расход</th>
                            <th>Электроэнергия</th>
                            <th>Взносы</th>
                            <th>Итого</th>
                        </tr>
                    </thead>
                    <tbody id="user-history-body">
                        <tr>
                            <td colspan="6" style="text-align: center;">Нет данных</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Админ: Управление пользователями -->
        <div id="admin-users" class="card">
            <h2>Управление пользователями</h2>
            <div id="admin-users-alert" class="alert" style="display: none;"></div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="showAddUserForm()">Добавить пользователя</button>
                <button class="secondary" onclick="loadUsers()">Обновить список</button>
            </div>
            
            <div id="add-user-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Новый пользователь</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="new-login">Логин:</label>
                        <input type="text" id="new-login">
                    </div>
                    <div class="form-group">
                        <label for="new-password">Пароль:</label>
                        <input type="password" id="new-password">
                    </div>
                    <div class="form-group">
                        <label for="new-name">ФИО:</label>
                        <input type="text" id="new-name">
                    </div>
                    <div class="form-group">
                        <label for="new-section">Участок №:</label>
                        <input type="number" id="new-section" min="1">
                    </div>
                    <div class="form-group">
                        <label for="new-phone">Телефон:</label>
                        <input type="tel" id="new-phone">
                    </div>
                    <div class="form-group">
                        <label for="new-email">Email:</label>
                        <input type="email" id="new-email">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="addUser()">Создать пользователя</button>
                    <button class="secondary" onclick="hideAddUserForm()" style="margin-left: 10px;">Отмена</button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Логин</th>
                            <th>ФИО</th>
                            <th>Участок</th>
                            <th>Телефон</th>
                            <th>Email</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center;">Загрузка данных...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Админ: Управление тарифами -->
        <div id="admin-tariffs" class="card">
            <h2>Управление тарифами на электроэнергию</h2>
            <div id="admin-tariffs-alert" class="alert" style="display: none;"></div>
            
            <div class="month-selector">
                <div class="form-group" style="flex: 1;">
                    <label for="tariff-month">Месяц:</label>
                    <select id="tariff-month">
                        <option value="01">Январь</option>
                        <option value="02">Февраль</option>
                        <option value="03">Март</option>
                        <option value="04">Апрель</option>
                        <option value="05">Май</option>
                        <option value="06">Июнь</option>
                        <option value="07">Июль</option>
                        <option value="08">Август</option>
                        <option value="09">Сентябрь</option>
                        <option value="10">Октябрь</option>
                        <option value="11">Ноябрь</option>
                        <option value="12">Декабрь</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="tariff-year">Год:</label>
                    <input type="number" id="tariff-year" min="2024" max="2030" value="2026">
                </div>
                <button onclick="loadTariffs()">Загрузить тарифы</button>
                <button onclick="showAddTariffForm()" style="background: #28a745;">Добавить тариф</button>
            </div>
            
            <!-- Форма добавления/редактирования тарифа -->
            <div id="add-tariff-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 id="tariff-form-title">Новый тариф</h3>
                <div class="form-grid">
                    <div class="form-section">
                        <h4>Период действия</h4>
                        <div class="form-group">
                            <label for="edit-tariff-month">Месяц:</label>
                            <select id="edit-tariff-month">
                                <option value="01">Январь</option>
                                <option value="02">Февраль</option>
                                <option value="03">Март</option>
                                <option value="04">Апрель</option>
                                <option value="05">Май</option>
                                <option value="06">Июнь</option>
                                <option value="07">Июль</option>
                                <option value="08">Август</option>
                                <option value="09">Сентябрь</option>
                                <option value="10">Октябрь</option>
                                <option value="11">Ноябрь</option>
                                <option value="12">Декабрь</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-tariff-year">Год:</label>
                            <input type="number" id="edit-tariff-year" min="2024" max="2030" value="2026">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Тарифы на электроэнергию (руб/кВт·ч)</h4>
                        <div class="form-group">
                            <label for="edit-tariff-losses">Потери:</label>
                            <input type="number" id="edit-tariff-losses" step="0.01" min="0" value="0.36">
                        </div>
                        <div class="form-group">
                            <label for="edit-tariff-under100">До 100 кВт·ч:</label>
                            <input type="number" id="edit-tariff-under100" step="0.01" min="0" value="6.10">
                        </div>
                        <div class="form-group">
                            <label for="edit-tariff-over100">Свыше 100 кВт·ч:</label>
                            <input type="number" id="edit-tariff-over100" step="0.01" min="0" value="7.30">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button onclick="saveTariff()" id="save-tariff-btn">Сохранить тариф</button>
                    <button class="secondary" onclick="hideAddTariffForm()" style="margin-left: 10px;">Отмена</button>
                    <button class="danger" onclick="deleteTariff()" id="delete-tariff-btn" style="margin-left: 10px; display: none;">Удалить тариф</button>
                </div>
            </div>
            
            <!-- Текущие тарифы -->
            <div id="current-tariff-display" style="background: #e9f7ef; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #28a745;">
                <h3>Текущие тарифы на <span id="current-tariff-month">Январь 2026</span></h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #dc3545; margin: 0 0 10px 0;">Потери</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                            <span id="current-tariff-losses">0.36</span> руб/кВт·ч
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #fd7e14; margin: 0 0 10px 0;">До 100 кВт·ч</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                            <span id="current-tariff-under100">6.10</span> руб/кВт·ч
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #28a745; margin: 0 0 10px 0;">Свыше 100 кВт·ч</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                            <span id="current-tariff-over100">7.30</span> руб/кВт·ч
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- История тарифов -->
            <div class="tariff-history">
                <h3>История тарифов</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Период</th>
                                <th>Потери</th>
                                <th>До 100 кВт·ч</th>
                                <th>Свыше 100 кВт·ч</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="tariffs-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center;">Загрузка данных...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Админ: Управление членскими взносами -->
        <div id="admin-fees" class="card">
            <h2>Управление членскими взносами</h2>
            <div id="admin-fees-alert" class="alert" style="display: none;"></div>
            
            <div class="month-selector">
                <div class="form-group" style="flex: 1;">
                    <label for="fees-month">Месяц:</label>
                    <select id="fees-month">
                        <option value="01">Январь</option>
                        <option value="02">Февраль</option>
                        <option value="03">Март</option>
                        <option value="04">Апрель</option>
                        <option value="05">Май</option>
                        <option value="06">Июнь</option>
                        <option value="07">Июль</option>
                        <option value="08">Август</option>
                        <option value="09">Сентябрь</option>
                        <option value="10">Октябрь</option>
                        <option value="11">Ноябрь</option>
                        <option value="12">Декабрь</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="fees-year">Год:</label>
                    <input type="number" id="fees-year" min="2024" max="2030" value="2026">
                </div>
                <button onclick="loadFees()">Загрузить взносы</button>
                <button onclick="showAddFeeForm()" style="background: #28a745;">Добавить взносы</button>
            </div>
            
            <!-- Форма добавления/редактирования взносов -->
            <div id="add-fee-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 id="fee-form-title">Новые членские взносы</h3>
                <div class="form-grid">
                    <div class="form-section">
                        <h4>Период действия</h4>
                        <div class="form-group">
                            <label for="edit-fee-month">Месяц:</label>
                            <select id="edit-fee-month">
                                <option value="01">Январь</option>
                                <option value="02">Февраль</option>
                                <option value="03">Март</option>
                                <option value="04">Апрель</option>
                                <option value="05">Май</option>
                                <option value="06">Июнь</option>
                                <option value="07">Июль</option>
                                <option value="08">Август</option>
                                <option value="09">Сентябрь</option>
                                <option value="10">Октябрь</option>
                                <option value="11">Ноябрь</option>
                                <option value="12">Декабрь</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-fee-year">Год:</label>
                            <input type="number" id="edit-fee-year" min="2024" max="2030" value="2026">
                        </div>
                        <div class="form-group">
                            <label for="edit-fee-description">Описание:</label>
                            <input type="text" id="edit-fee-description" placeholder="Например: Взносы на содержание дорог">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Суммы взносов (руб)</h4>
                        <div class="form-group">
                            <label for="edit-fee-salary">Зарплата:</label>
                            <input type="number" id="edit-fee-salary" step="0.01" min="0" value="500">
                        </div>
                        <div class="form-group">
                            <label for="edit-fee-maintenance">Содержание:</label>
                            <input type="number" id="edit-fee-maintenance" step="0.01" min="0" value="800">
                        </div>
                        <div class="form-group">
                            <label for="edit-fee-other">Прочее:</label>
                            <input type="number" id="edit-fee-other" step="0.01" min="0" value="200">
                        </div>
                        <div class="form-group">
                            <label>Итого:</label>
                            <div style="background: #e9ecef; padding: 10px; border-radius: 5px; font-weight: bold;">
                                <span id="edit-fee-total">1500.00</span> руб
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button onclick="saveFee()" id="save-fee-btn">Сохранить взносы</button>
                    <button class="secondary" onclick="hideAddFeeForm()" style="margin-left: 10px;">Отмена</button>
                    <button class="danger" onclick="deleteFee()" id="delete-fee-btn" style="margin-left: 10px; display: none;">Удалить взносы</button>
                </div>
            </div>
            
            <!-- Текущие взносы -->
            <div id="current-fee-display" style="background: #e9f7ef; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #28a745;">
                <h3>Текущие членские взносы на <span id="current-fee-month">Январь 2026</span></h3>
                <div id="current-fee-description" style="margin-bottom: 15px; color: #666; font-style: italic;">
                    Взносы на содержание территории
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #007bff; margin: 0 0 10px 0;">Зарплата</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                            <span id="current-fee-salary">500</span> руб
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #6f42c1; margin: 0 0 10px 0;">Содержание</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                            <span id="current-fee-maintenance">800</span> руб
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #20c997; margin: 0 0 10px 0;">Прочее</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                            <span id="current-fee-other">200</span> руб
                        </div>
                    </div>
                    <div style="background: #667eea; padding: 15px; border-radius: 8px; color: white;">
                        <h4 style="margin: 0 0 10px 0; color: white;">Итого</h4>
                        <div style="font-size: 1.5rem; font-weight: bold;">
                            <span id="current-fee-total">1500</span> руб
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- История взносов -->
            <div class="tariff-history">
                <h3>История членских взносов</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Период</th>
                                <th>Описание</th>
                                <th>Зарплата</th>
                                <th>Содержание</th>
                                <th>Прочее</th>
                                <th>Итого</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="fees-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center;">Загрузка данных...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Админ: Показания счетчиков -->
        <div id="admin-readings" class="card">
            <h2>Управление показаниями счетчиков</h2>
            <div id="admin-readings-alert" class="alert" style="display: none;"></div>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="filter-user">Фильтр по пользователю:</label>
                        <select id="filter-user" onchange="loadReadings()">
                            <option value="">Все пользователи</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="filter-month">Фильтр по месяцу:</label>
                        <select id="filter-month" onchange="loadReadings()">
                            <option value="">Все месяцы</option>
                        </select>
                    </div>
                    <div style="align-self: flex-end;">
                        <button class="secondary" onclick="loadReadings()">Обновить</button>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Пользователь</th>
                            <th>Показания</th>
                            <th>Расход</th>
                            <th>Электроэнергия</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="readings-table-body">
                        <tr>
                            <td colspan="6" style="text-align: center;">Загрузка данных...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Админ: Импорт/Экспорт -->
        <div id="admin-import" class="card">
            <h2>Импорт и экспорт данных</h2>
            <div id="admin-import-alert" class="alert" style="display: none;"></div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 20px;">
                <div>
                    <h3>Импорт пользователей (CSV)</h3>
                    <p>Загрузите CSV файл с данными пользователей.</p>
                    
                    <div class="file-upload" onclick="document.getElementById('csv-file').click()">
                        <input type="file" id="csv-file" accept=".csv" onchange="handleCSVUpload(event)">
                        <p>Перетащите CSV файл сюда или нажмите для выбора</p>
                        <p style="font-size: 0.9em; color: #666;">Формат: логин, пароль, ФИО, участок, телефон, email</p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="downloadTemplate()">Скачать шаблон CSV</button>
                    </div>
                </div>
                
                <div>
                    <h3>Экспорт данных</h3>
                    <p>Выберите данные для экспорта в CSV формате:</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                        <button onclick="exportData('users')">Экспорт пользователей</button>
                        <button onclick="exportData('tariffs')">Экспорт тарифов</button>
                        <button onclick="exportData('fees')">Экспорт взносов</button>
                        <button onclick="exportData('readings')">Экспорт показаний</button>
                        <button onclick="exportData('all')">Экспорт всех данных</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Быстрые действия</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                    <button onclick="generateMonthlyReadings()" class="secondary">Сгенерировать показания за месяц</button>
                    <button onclick="calculateAllPayments()" class="secondary">Рассчитать все платежи</button>
                    <button onclick="sendMonthlyReminders()" class="secondary">Отправить напоминания</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_9NXa4FwnnrICXnXmrOVqRg_KB5LHkmk';
        
        // Инициализация Supabase клиента
        const supabase = window.supabase ? 
            window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : 
            { 
                from: () => ({ 
                    select: () => Promise.resolve({ data: null, error: null }),
                    insert: () => Promise.resolve({ data: null, error: null }),
                    update: () => ({ eq: () => Promise.resolve({ data: null, error: null }) }),
                    delete: () => ({ eq: () => Promise.resolve({ data: null, error: null }) })
                }),
                auth: {
                    signIn: () => Promise.resolve({ user: null, error: null }),
                    signOut: () => Promise.resolve({ error: null }),
                    user: () => ({ id: 'demo', user_metadata: { name: 'Демо пользователь' } })
                }
            };
        
        // Текущий пользователь
        let currentUser = null;
        let currentUserType = null;
        
        // Текущие тарифы и взносы для редактирования
        let currentEditingTariffId = null;
        let currentEditingFeeId = null;
        
        // Месяцы для отображения
        const MONTHS = {
            '01': 'Январь', '02': 'Февраль', '03': 'Март', '04': 'Апрель',
            '05': 'Май', '06': 'Июнь', '07': 'Июль', '08': 'Август',
            '09': 'Сентябрь', '10': 'Октябрь', '11': 'Ноябрь', '12': 'Декабрь'
        };
        
        // Проверка доступности Supabase
        async function checkSupabaseConnection() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            try {
                statusText.textContent = 'Проверка соединения с сервером...';
                statusIndicator.className = 'status-indicator';
                
                const { data, error } = await supabase.from('users').select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.message.includes('JWT')) {
                        statusIndicator.className = 'status-indicator online';
                        statusText.textContent = 'Сервер доступен (ограниченный режим)';
                    } else {
                        throw error;
                    }
                } else {
                    statusIndicator.className = 'status-indicator online';
                    statusText.textContent = 'Сервер доступен';
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Сервер недоступен. Работа в демо-режиме.';
                console.log('Supabase недоступен, используется демо-режим:', error.message);
            }
        }
        
        // Отображение карточки
        function showCard(cardId) {
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('active');
            });
            
            document.getElementById(cardId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const btnMap = {
                'user-dashboard': 'btn-dashboard',
                'admin-users': 'btn-users',
                'admin-tariffs': 'btn-tariffs',
                'admin-fees': 'btn-fees',
                'admin-readings': 'btn-readings',
                'admin-import': 'btn-import'
            };
            
            if (btnMap[cardId]) {
                document.getElementById(btnMap[cardId]).classList.add('active');
            }
            
            // Загрузить данные для карточки
            if (cardId === 'user-dashboard') {
                loadUserData();
            } else if (cardId === 'admin-users') {
                loadUsers();
            } else if (cardId === 'admin-tariffs') {
                loadTariffs();
            } else if (cardId === 'admin-fees') {
                loadFees();
            } else if (cardId === 'admin-readings') {
                loadReadings();
                populateUserFilter();
            }
        }
        
        // Авторизация
        async function login() {
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('user-type').value;
            const alert = document.getElementById('auth-alert');
            
            if (!login || !password) {
                alert.textContent = 'Пожалуйста, заполните все поля';
                alert.className = 'alert error';
                alert.style.display = 'block';
                return;
            }
            
            // Демо-авторизация
            if (userType === 'admin' && login === 'admin' && password === 'admin123') {
                currentUser = { 
                    id: 'admin', 
                    login: 'admin', 
                    name: 'Администратор', 
                    section: 0, 
                    phone: '+7 (999) 000-00-00', 
                    email: 'admin@zvezdochka.ru',
                    is_admin: true 
                };
                currentUserType = 'admin';
                alert.textContent = 'Успешный вход как администратор';
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                document.getElementById('nav-buttons').style.display = 'flex';
                showCard('admin-users');
                document.getElementById('auth-card').classList.remove('active');
            } else if (userType === 'user' && login === 'user1' && password === 'user123') {
                currentUser = { 
                    id: 'user1', 
                    login: 'user1', 
                    name: 'Иванов Иван Иванович', 
                    section: 15, 
                    phone: '+7 (999) 123-45-67', 
                    email: 'user1@example.com',
                    is_admin: false 
                };
                currentUserType = 'user';
                alert.textContent = 'Успешный вход в личный кабинет';
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                document.getElementById('welcome-user').textContent = `Добро пожаловать, ${currentUser.name}! Участок №${currentUser.section}`;
                showCard('user-dashboard');
                document.getElementById('auth-card').classList.remove('active');
            } else {
                const mockUsers = [
                    { id: 'user1', login: 'user1', password: 'user123', name: 'Иванов Иван Иванович', section: 15, phone: '+7 (999) 123-45-67', email: 'user1@example.com', is_admin: false },
                    { id: 'user2', login: 'user2', password: 'user123', name: 'Петров Петр Петрович', section: 23, phone: '+7 (999) 234-56-78', email: 'user2@example.com', is_admin: false },
                    { id: 'admin', login: 'admin', password: 'admin123', name: 'Администратор', section: 0, phone: '+7 (999) 000-00-00', email: 'admin@zvezdochka.ru', is_admin: true }
                ];
                
                const user = mockUsers.find(u => u.login === login && u.password === password);
                
                if (user) {
                    currentUser = user;
                    currentUserType = user.is_admin ? 'admin' : 'user';
                    alert.textContent = `Успешный вход${user.is_admin ? ' как администратор' : ''}`;
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    
                    if (user.is_admin) {
                        document.getElementById('nav-buttons').style.display = 'flex';
                        showCard('admin-users');
                    } else {
                        document.getElementById('welcome-user').textContent = `Добро пожаловать, ${user.name}! Участок №${user.section}`;
                        showCard('user-dashboard');
                    }
                    
                    document.getElementById('auth-card').classList.remove('active');
                } else {
                    alert.textContent = 'Неверный логин или пароль';
                    alert.className = 'alert error';
                    alert.style.display = 'block';
                }
            }
        }
        
        // Выход из системы
        function logout() {
            currentUser = null;
            currentUserType = null;
            document.getElementById('nav-buttons').style.display = 'none';
            document.getElementById('login').value = '';
            document.getElementById('password').value = '';
            showCard('auth-card');
        }
        
        // Расчет стоимости электроэнергии по трехтарифной системе
        function calculateElectricityCost(consumption, tariffs) {
            const lossesCost = consumption * tariffs.loss_tariff;
            
            let under100Cost = 0;
            let over100Cost = 0;
            
            if (consumption <= 100) {
                under100Cost = consumption * tariffs.under100_tariff;
            } else {
                under100Cost = 100 * tariffs.under100_tariff;
                over100Cost = (consumption - 100) * tariffs.over100_tariff;
            }
            
            const totalCost = lossesCost + under100Cost + over100Cost;
            
            return {
                losses: { kwh: consumption, rate: tariffs.loss_tariff, cost: lossesCost },
                under100: { kwh: Math.min(consumption, 100), rate: tariffs.under100_tariff, cost: under100Cost },
                over100: { kwh: Math.max(consumption - 100, 0), rate: tariffs.over100_tariff, cost: over100Cost },
                total: totalCost
            };
        }
        
        // Обновление расчета в реальном времени
        function updateCalculation() {
            const reading = parseFloat(document.getElementById('user-meter-reading').value) || 0;
            const previousReading = parseFloat(document.getElementById('user-previous-reading').value) || 0;
            const consumption = Math.max(0, reading - previousReading);
            
            // Получаем текущие тарифы
            const lossesTariff = parseFloat(document.getElementById('user-tariff-losses').textContent) || 0.36;
            const under100Tariff = parseFloat(document.getElementById('user-tariff-under100').textContent) || 6.10;
            const over100Tariff = parseFloat(document.getElementById('user-tariff-over100').textContent) || 7.30;
            
            const tariffs = {
                loss_tariff: lossesTariff,
                under100_tariff: under100Tariff,
                over100_tariff: over100Tariff
            };
            
            const salary = parseFloat(document.getElementById('user-fee-salary').textContent) || 0;
            const maintenance = parseFloat(document.getElementById('user-fee-maintenance').textContent) || 0;
            const other = parseFloat(document.getElementById('user-fee-other').textContent) || 0;
            const feesTotal = salary + maintenance + other;
            
            const electricity = calculateElectricityCost(consumption, tariffs);
            
            // Обновление отображения расчета
            document.getElementById('calc-losses').textContent = 
                `${electricity.losses.kwh.toFixed(1)} кВт·ч × ${tariffs.loss_tariff.toFixed(2)} = ${electricity.losses.cost.toFixed(2)} руб`;
            
            document.getElementById('calc-under100').textContent = 
                `${electricity.under100.kwh.toFixed(1)} кВт·ч × ${tariffs.under100_tariff.toFixed(2)} = ${electricity.under100.cost.toFixed(2)} руб`;
            
            document.getElementById('calc-over100').textContent = 
                `${electricity.over100.kwh.toFixed(1)} кВт·ч × ${tariffs.over100_tariff.toFixed(2)} = ${electricity.over100.cost.toFixed(2)} руб`;
            
            document.getElementById('calc-fees').textContent = `${feesTotal.toFixed(2)} руб`;
            document.getElementById('calc-total').textContent = `${(electricity.total + feesTotal).toFixed(2)} руб`;
            
            // Обновляем текст текущего месяца
            const month = document.getElementById('user-month').value;
            const year = document.getElementById('user-year').value;
            document.getElementById('current-month-text').textContent = `${MONTHS[month]} ${year}`;
        }
        
        // Загрузка данных пользователя
        async function loadUserData() {
            if (!currentUser || currentUserType !== 'user') return;
            
            const alert = document.getElementById('user-alert');
            const month = document.getElementById('user-month').value;
            const year = document.getElementById('user-year').value;
            
            try {
                // Загрузка тарифов на выбранный месяц
                const mockTariffs = [
                    { month: '01', year: 2026, loss_tariff: 0.36, under100_tariff: 6.10, over100_tariff: 7.30 },
                    { month: '02', year: 2026, loss_tariff: 0.38, under100_tariff: 6.20, over100_tariff: 7.40 },
                    { month: '03', year: 2026, loss_tariff: 0.35, under100_tariff: 6.05, over100_tariff: 7.25 }
                ];
                
                const currentTariff = mockTariffs.find(t => t.month === month && t.year == year) || mockTariffs[0];
                
                // Обновляем отображение тарифов
                document.getElementById('user-tariff-losses').textContent = currentTariff.loss_tariff.toFixed(2);
                document.getElementById('user-tariff-under100').textContent = currentTariff.under100_tariff.toFixed(2);
                document.getElementById('user-tariff-over100').textContent = currentTariff.over100_tariff.toFixed(2);
                
                // Загрузка взносов на выбранный месяц
                const mockFees = [
                    { month: '01', year: 2026, salary: 500, maintenance: 800, other: 200, description: 'Взносы на содержание территории' },
                    { month: '02', year: 2026, salary: 550, maintenance: 850, other: 250, description: 'Взносы на ремонт дорог' },
                    { month: '03', year: 2026, salary: 520, maintenance: 820, other: 220, description: 'Взносы на оплату охраны' }
                ];
                
                const currentFee = mockFees.find(f => f.month === month && f.year == year) || mockFees[0];
                
                // Обновляем отображение взносов
                document.getElementById('user-fee-salary').textContent = currentFee.salary;
                document.getElementById('user-fee-maintenance').textContent = currentFee.maintenance;
                document.getElementById('user-fee-other').textContent = currentFee.other;
                document.getElementById('user-fee-total').textContent = (currentFee.salary + currentFee.maintenance + currentFee.other);
                
                // Загрузка истории показаний
                const mockReadings = [
                    { date: '2026-01-15', month: '01', year: 2026, reading: 700, previous_reading: 650, consumption: 50, electricity_cost: 305.50, fees: 1500, total: 1805.50 },
                    { date: '2025-12-20', month: '12', year: 2025, reading: 650, previous_reading: 580, consumption: 70, electricity_cost: 427.70, fees: 1500, total: 1927.70 },
                    { date: '2025-11-18', month: '11', year: 2025, reading: 580, previous_reading: 510, consumption: 70, electricity_cost: 427.70, fees: 1500, total: 1927.70 }
                ];
                
                // Фильтруем по выбранному месяцу
                const filteredReadings = mockReadings.filter(r => r.month === month && r.year == year);
                
                if (filteredReadings.length > 0) {
                    const latest = filteredReadings[0];
                    document.getElementById('user-meter-reading').value = '';
                    document.getElementById('user-previous-reading').value = latest.reading;
                    
                    // Обновление истории
                    const tbody = document.getElementById('user-history-body');
                    tbody.innerHTML = '';
                    
                    filteredReadings.forEach(r => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${r.date}</td>
                            <td>${r.reading} кВт·ч</td>
                            <td>${r.consumption} кВт·ч</td>
                            <td>${r.electricity_cost.toFixed(2)} руб</td>
                            <td>${r.fees.toFixed(2)} руб</td>
                            <td>${r.total.toFixed(2)} руб</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    alert.textContent = `Данные за ${MONTHS[month]} ${year} загружены`;
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    setTimeout(() => { alert.style.display = 'none'; }, 3000);
                } else {
                    document.getElementById('user-previous-reading').value = '0';
                    const tbody = document.getElementById('user-history-body');
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Нет данных за выбранный период</td></tr>';
                    
                    alert.textContent = `Нет данных за ${MONTHS[month]} ${year}`;
                    alert.className = 'alert info';
                    alert.style.display = 'block';
                }
                
                // Обновляем расчет
                updateCalculation();
                
            } catch (error) {
                alert.textContent = 'Ошибка загрузки данных: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Отправка показаний пользователем
        async function submitUserReadings() {
            if (!currentUser || currentUserType !== 'user') return;
            
            const reading = parseFloat(document.getElementById('user-meter-reading').value);
            const previousReading = parseFloat(document.getElementById('user-previous-reading').value) || 0;
            const alert = document.getElementById('user-alert');
            const month = document.getElementById('user-month').value;
            const year = document.getElementById('user-year').value;
            
            if (!reading || reading < previousReading) {
                alert.textContent = 'Некорректные показания счетчика';
                alert.className = 'alert error';
                alert.style.display = 'block';
                return;
            }
            
            // Получаем текущие тарифы и взносы
            const lossesTariff = parseFloat(document.getElementById('user-tariff-losses').textContent) || 0.36;
            const under100Tariff = parseFloat(document.getElementById('user-tariff-under100').textContent) || 6.10;
            const over100Tariff = parseFloat(document.getElementById('user-tariff-over100').textContent) || 7.30;
            
            const tariffs = {
                loss_tariff: lossesTariff,
                under100_tariff: under100Tariff,
                over100_tariff: over100Tariff
            };
            
            const salary = parseFloat(document.getElementById('user-fee-salary').textContent) || 0;
            const maintenance = parseFloat(document.getElementById('user-fee-maintenance').textContent) || 0;
            const other = parseFloat(document.getElementById('user-fee-other').textContent) || 0;
            
            const consumption = reading - previousReading;
            const electricity = calculateElectricityCost(consumption, tariffs);
            const feesTotal = salary + maintenance + other;
            const total = electricity.total + feesTotal;
            
            try {
                alert.textContent = `Показания за ${MONTHS[month]} ${year} успешно переданы! Сумма к оплате: ${total.toFixed(2)} руб`;
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                // Обновляем предыдущие показания
                document.getElementById('user-previous-reading').value = reading;
                document.getElementById('user-meter-reading').value = '';
                
                // Добавляем в историю
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                
                const tbody = document.getElementById('user-history-body');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${reading} кВт·ч</td>
                    <td>${consumption} кВт·ч</td>
                    <td>${electricity.total.toFixed(2)} руб</td>
                    <td>${feesTotal.toFixed(2)} руб</td>
                    <td>${total.toFixed(2)} руб</td>
                `;
                tbody.insertBefore(newRow, tbody.firstChild);
                
                // Если таблица была пуста, удаляем сообщение "нет данных"
                if (tbody.children.length > 1 && tbody.children[1].querySelector('td[colspan]')) {
                    tbody.removeChild(tbody.children[1]);
                }
                
                // Обновляем расчет
                updateCalculation();
                
            } catch (error) {
                alert.textContent = 'Ошибка при передаче показаний: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Админ: Загрузка пользователей
        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            const alert = document.getElementById('admin-users-alert');
            
            try {
                const mockUsers = [
                    { id: 1, login: 'user1', name: 'Иванов Иван Иванович', section: 15, phone: '+7 (999) 123-45-67', email: 'user1@example.com', created_at: '2025-01-15' },
                    { id: 2, login: 'user2', name: 'Петров Петр Петрович', section: 23, phone: '+7 (999) 234-56-78', email: 'user2@example.com', created_at: '2025-01-20' },
                    { id: 3, login: 'user3', name: 'Сидорова Анна Васильевна', section: 7, phone: '+7 (999) 345-67-89', email: 'user3@example.com', created_at: '2025-02-05' },
                    { id: 4, login: 'user4', name: 'Кузнецов Алексей Николаевич', section: 42, phone: '+7 (999) 456-78-90', email: 'user4@example.com', created_at: '2025-02-10' },
                    { id: 5, login: 'admin', name: 'Администратор', section: 0, phone: '+7 (999) 000-00-00', email: 'admin@zvezdochka.ru', created_at: '2025-01-01', is_admin: true }
                ];
                
                tbody.innerHTML = '';
                
                mockUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.login} ${user.is_admin ? '<span class="badge" style="background: #dc3545; color: white;">админ</span>' : ''}</td>
                        <td>${user.name}</td>
                        <td>${user.section || '—'}</td>
                        <td>${user.phone || '—'}</td>
                        <td>${user.email || '—'}</td>
                        <td>
                            <button onclick="editUser(${user.id})" style="padding: 5px 10px; font-size: 14px;">Изменить</button>
                            ${!user.is_admin ? `<button onclick="deleteUser(${user.id})" style="padding: 5px 10px; font-size: 14px; background: #dc3545; margin-left: 5px;">Удалить</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                if (alert) {
                    alert.textContent = `Загружено ${mockUsers.length} пользователей`;
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    setTimeout(() => { alert.style.display = 'none'; }, 3000);
                }
                
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #dc3545;">Ошибка загрузки: ${error.message}</td></tr>`;
                
                if (alert) {
                    alert.textContent = 'Ошибка загрузки пользователей: ' + error.message;
                    alert.className = 'alert error';
                    alert.style.display = 'block';
                }
            }
        }
        
        // Показать форму добавления пользователя
        function showAddUserForm() {
            document.getElementById('add-user-form').style.display = 'block';
        }
        
        function hideAddUserForm() {
            document.getElementById('add-user-form').style.display = 'none';
            document.getElementById('new-login').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-name').value = '';
            document.getElementById('new-section').value = '';
            document.getElementById('new-phone').value = '';
            document.getElementById('new-email').value = '';
        }
        
        // Добавление пользователя
        async function addUser() {
            const login = document.getElementById('new-login').value;
            const password = document.getElementById('new-password').value;
            const name = document.getElementById('new-name').value;
            const section = document.getElementById('new-section').value;
            const phone = document.getElementById('new-phone').value;
            const email = document.getElementById('new-email').value;
            const alert = document.getElementById('admin-users-alert');
            
            if (!login || !password || !name) {
                alert.textContent = 'Заполните обязательные поля: логин, пароль и ФИО';
                alert.className = 'alert error';
                alert.style.display = 'block';
                return;
            }
            
            try {
                alert.textContent = `Пользователь ${name} успешно добавлен`;
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                hideAddUserForm();
                loadUsers();
                
            } catch (error) {
                alert.textContent = 'Ошибка при добавлении пользователя: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Админ: Загрузка тарифов
        async function loadTariffs() {
            const tbody = document.getElementById('tariffs-table-body');
            const alert = document.getElementById('admin-tariffs-alert');
            const month = document.getElementById('tariff-month').value;
            const year = document.getElementById('tariff-year').value;
            
            try {
                const mockTariffs = [
                    { id: 1, month: '01', year: 2026, loss_tariff: 0.36, under100_tariff: 6.10, over100_tariff: 7.30, is_current: true },
                    { id: 2, month: '02', year: 2026, loss_tariff: 0.38, under100_tariff: 6.20, over100_tariff: 7.40, is_current: false },
                    { id: 3, month: '03', year: 2026, loss_tariff: 0.35, under100_tariff: 6.05, over100_tariff: 7.25, is_current: false },
                    { id: 4, month: '12', year: 2025, loss_tariff: 0.34, under100_tariff: 6.00, over100_tariff: 7.20, is_current: false }
                ];
                
                // Фильтруем по выбранному месяцу и году
                let filteredTariffs = mockTariffs;
                if (month && year) {
                    filteredTariffs = mockTariffs.filter(t => t.month === month && t.year == year);
                }
                
                tbody.innerHTML = '';
                
                if (filteredTariffs.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Нет данных для отображения</td></tr>`;
                } else {
                    // Находим текущий тариф (для текущего месяца)
                    const now = new Date();
                    const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
                    const currentYear = now.getFullYear();
                    
                    filteredTariffs.forEach(tariff => {
                        const isCurrent = tariff.month === currentMonth && tariff.year == currentYear;
                        const isPast = tariff.year < currentYear || (tariff.year == currentYear && tariff.month < currentMonth);
                        const isFuture = tariff.year > currentYear || (tariff.year == currentYear && tariff.month > currentMonth);
                        
                        let statusBadge = '';
                        if (isCurrent) {
                            statusBadge = '<span class="badge current">Текущий</span>';
                        } else if (isFuture) {
                            statusBadge = '<span class="badge future">Будущий</span>';
                        } else {
                            statusBadge = '<span class="badge past">Прошлый</span>';
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${MONTHS[tariff.month]} ${tariff.year}</td>
                            <td>${tariff.loss_tariff.toFixed(2)} руб/кВт·ч</td>
                            <td>${tariff.under100_tariff.toFixed(2)} руб/кВт·ч</td>
                            <td>${tariff.over100_tariff.toFixed(2)} руб/кВт·ч</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button onclick="editTariff(${tariff.id})" style="padding: 5px 10px; font-size: 14px;">Изменить</button>
                                <button onclick="deleteTariffPrompt(${tariff.id})" style="padding: 5px 10px; font-size: 14px; background: #dc3545; margin-left: 5px;">Удалить</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Обновляем отображение текущего тарифа
                    const currentTariff = mockTariffs.find(t => t.is_current) || mockTariffs[0];
                    document.getElementById('current-tariff-month').textContent = `${MONTHS[currentTariff.month]} ${currentTariff.year}`;
                    document.getElementById('current-tariff-losses').textContent = currentTariff.loss_tariff.toFixed(2);
                    document.getElementById('current-tariff-under100').textContent = currentTariff.under100_tariff.toFixed(2);
                    document.getElementById('current-tariff-over100').textContent = currentTariff.over100_tariff.toFixed(2);
                }
                
                if (alert) {
                    alert.textContent = `Загружено ${filteredTariffs.length} тарифов`;
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    setTimeout(() => { alert.style.display = 'none'; }, 3000);
                }
                
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #dc3545;">Ошибка загрузки: ${error.message}</td></tr>`;
                
                if (alert) {
                    alert.textContent = 'Ошибка загрузки тарифов: ' + error.message;
                    alert.className = 'alert error';
                    alert.style.display = 'block';
                }
            }
        }
        
        // Показать форму добавления/редактирования тарифа
        function showAddTariffForm() {
            document.getElementById('add-tariff-form').style.display = 'block';
            document.getElementById('tariff-form-title').textContent = 'Новый тариф';
            document.getElementById('save-tariff-btn').textContent = 'Сохранить тариф';
            document.getElementById('delete-tariff-btn').style.display = 'none';
            
            // Сбрасываем значения
            const now = new Date();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            const currentYear = now.getFullYear();
            
            document.getElementById('edit-tariff-month').value = currentMonth;
            document.getElementById('edit-tariff-year').value = currentYear;
            document.getElementById('edit-tariff-losses').value = '0.36';
            document.getElementById('edit-tariff-under100').value = '6.10';
            document.getElementById('edit-tariff-over100').value = '7.30';
            
            currentEditingTariffId = null;
        }
        
        function hideAddTariffForm() {
            document.getElementById('add-tariff-form').style.display = 'none';
            currentEditingTariffId = null;
        }
        
        // Редактирование тарифа
        function editTariff(tariffId) {
            const mockTariffs = [
                { id: 1, month: '01', year: 2026, loss_tariff: 0.36, under100_tariff: 6.10, over100_tariff: 7.30 },
                { id: 2, month: '02', year: 2026, loss_tariff: 0.38, under100_tariff: 6.20, over100_tariff: 7.40 },
                { id: 3, month: '03', year: 2026, loss_tariff: 0.35, under100_tariff: 6.05, over100_tariff: 7.25 }
            ];
            
            const tariff = mockTariffs.find(t => t.id === tariffId);
            if (!tariff) return;
            
            document.getElementById('add-tariff-form').style.display = 'block';
            document.getElementById('tariff-form-title').textContent = 'Редактирование тарифа';
            document.getElementById('save-tariff-btn').textContent = 'Обновить тариф';
            document.getElementById('delete-tariff-btn').style.display = 'inline-block';
            
            document.getElementById('edit-tariff-month').value = tariff.month;
            document.getElementById('edit-tariff-year').value = tariff.year;
            document.getElementById('edit-tariff-losses').value = tariff.loss_tariff;
            document.getElementById('edit-tariff-under100').value = tariff.under100_tariff;
            document.getElementById('edit-tariff-over100').value = tariff.over100_tariff;
            
            currentEditingTariffId = tariffId;
        }
        
        // Сохранение тарифа
        async function saveTariff() {
            const month = document.getElementById('edit-tariff-month').value;
            const year = document.getElementById('edit-tariff-year').value;
            const lossTariff = parseFloat(document.getElementById('edit-tariff-losses').value);
            const under100Tariff = parseFloat(document.getElementById('edit-tariff-under100').value);
            const over100Tariff = parseFloat(document.getElementById('edit-tariff-over100').value);
            const alert = document.getElementById('admin-tariffs-alert');
            
            if (!month || !year || isNaN(lossTariff) || isNaN(under100Tariff) || isNaN(over100Tariff)) {
                alert.textContent = 'Заполните все поля корректно';
                alert.className = 'alert error';
                alert.style.display = 'block';
                return;
            }
            
            try {
                if (currentEditingTariffId) {
                    alert.textContent = `Тариф на ${MONTHS[month]} ${year} обновлен`;
                } else {
                    alert.textContent = `Новый тариф на ${MONTHS[month]} ${year} добавлен`;
                }
                
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                hideAddTariffForm();
                loadTariffs();
                
            } catch (error) {
                alert.textContent = 'Ошибка при сохранении тарифа: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Удаление тарифа (подтверждение)
        function deleteTariffPrompt(tariffId) {
            if (confirm('Вы уверены, что хотите удалить этот тариф?')) {
                deleteTariff(tariffId);
            }
        }
        
        // Удаление тарифа
        async function deleteTariff() {
            if (!currentEditingTariffId) return;
            
            const alert = document.getElementById('admin-tariffs-alert');
            
            try {
                alert.textContent = 'Тариф успешно удален';
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                hideAddTariffForm();
                loadTariffs();
                
            } catch (error) {
                alert.textContent = 'Ошибка при удалении тарифа: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Админ: Загрузка членских взносов
        async function loadFees() {
            const tbody = document.getElementById('fees-table-body');
            const alert = document.getElementById('admin-fees-alert');
            const month = document.getElementById('fees-month').value;
            const year = document.getElementById('fees-year').value;
            
            try {
                const mockFees = [
                    { id: 1, month: '01', year: 2026, salary: 500, maintenance: 800, other: 200, description: 'Взносы на содержание территории', is_current: true },
                    { id: 2, month: '02', year: 2026, salary: 550, maintenance: 850, other: 250, description: 'Взносы на ремонт дорог', is_current: false },
                    { id: 3, month: '03', year: 2026, salary: 520, maintenance: 820, other: 220, description: 'Взносы на оплату охраны', is_current: false },
                    { id: 4, month: '12', year: 2025, salary: 480, maintenance: 780, other: 180, description: 'Взносы на подготовку к зиме', is_current: false }
                ];
                
                // Фильтруем по выбранному месяцу и году
                let filteredFees = mockFees;
                if (month && year) {
                    filteredFees = mockFees.filter(f => f.month === month && f.year == year);
                }
                
                tbody.innerHTML = '';
                
                if (filteredFees.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center;">Нет данных для отображения</td></tr>`;
                } else {
                    // Находим текущий месяц
                    const now = new Date();
                    const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
                    const currentYear = now.getFullYear();
                    
                    filteredFees.forEach(fee => {
                        const total = fee.salary + fee.maintenance + fee.other;
                        const isCurrent = fee.month === currentMonth && fee.year == currentYear;
                        const isPast = fee.year < currentYear || (fee.year == currentYear && fee.month < currentMonth);
                        const isFuture = fee.year > currentYear || (fee.year == currentYear && fee.month > currentMonth);
                        
                        let statusBadge = '';
                        if (isCurrent) {
                            statusBadge = '<span class="badge current">Текущий</span>';
                        } else if (isFuture) {
                            statusBadge = '<span class="badge future">Будущий</span>';
                        } else {
                            statusBadge = '<span class="badge past">Прошлый</span>';
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${MONTHS[fee.month]} ${fee.year}</td>
                            <td>${fee.description}</td>
                            <td>${fee.salary.toFixed(2)} руб</td>
                            <td>${fee.maintenance.toFixed(2)} руб</td>
                            <td>${fee.other.toFixed(2)} руб</td>
                            <td>${total.toFixed(2)} руб</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button onclick="editFee(${fee.id})" style="padding: 5px 10px; font-size: 14px;">Изменить</button>
                                <button onclick="deleteFeePrompt(${fee.id})" style="padding: 5px 10px; font-size: 14px; background: #dc3545; margin-left: 5px;">Удалить</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Обновляем отображение текущих взносов
                    const currentFee = mockFees.find(f => f.is_current) || mockFees[0];
                    document.getElementById('current-fee-month').textContent = `${MONTHS[currentFee.month]} ${currentFee.year}`;
                    document.getElementById('current-fee-description').textContent = currentFee.description;
                    document.getElementById('current-fee-salary').textContent = currentFee.salary;
                    document.getElementById('current-fee-maintenance').textContent = currentFee.maintenance;
                    document.getElementById('current-fee-other').textContent = currentFee.other;
                    document.getElementById('current-fee-total').textContent = (currentFee.salary + currentFee.maintenance + currentFee.other);
                }
                
                if (alert) {
                    alert.textContent = `Загружено ${filteredFees.length} записей о взносах`;
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    setTimeout(() => { alert.style.display = 'none'; }, 3000);
                }
                
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #dc3545;">Ошибка загрузки: ${error.message}</td></tr>`;
                
                if (alert) {
                    alert.textContent = 'Ошибка загрузки взносов: ' + error.message;
                    alert.className = 'alert error';
                    alert.style.display = 'block';
                }
            }
        }
        
        // Показать форму добавления/редактирования взносов
        function showAddFeeForm() {
            document.getElementById('add-fee-form').style.display = 'block';
            document.getElementById('fee-form-title').textContent = 'Новые членские взносы';
            document.getElementById('save-fee-btn').textContent = 'Сохранить взносы';
            document.getElementById('delete-fee-btn').style.display = 'none';
            
            // Сбрасываем значения
            const now = new Date();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            const currentYear = now.getFullYear();
            
            document.getElementById('edit-fee-month').value = currentMonth;
            document.getElementById('edit-fee-year').value = currentYear;
            document.getElementById('edit-fee-description').value = 'Взносы на содержание территории';
            document.getElementById('edit-fee-salary').value = '500';
            document.getElementById('edit-fee-maintenance').value = '800';
            document.getElementById('edit-fee-other').value = '200';
            updateFeeTotal();
            
            currentEditingFeeId = null;
        }
        
        function hideAddFeeForm() {
            document.getElementById('add-fee-form').style.display = 'none';
            currentEditingFeeId = null;
        }
        
        // Обновление итоговой суммы взносов
        function updateFeeTotal() {
            const salary = parseFloat(document.getElementById('edit-fee-salary').value) || 0;
            const maintenance = parseFloat(document.getElementById('edit-fee-maintenance').value) || 0;
            const other = parseFloat(document.getElementById('edit-fee-other').value) || 0;
            const total = salary + maintenance + other;
            document.getElementById('edit-fee-total').textContent = total.toFixed(2);
        }
        
        // Редактирование взносов
        function editFee(feeId) {
            const mockFees = [
                { id: 1, month: '01', year: 2026, salary: 500, maintenance: 800, other: 200, description: 'Взносы на содержание территории' },
                { id: 2, month: '02', year: 2026, salary: 550, maintenance: 850, other: 250, description: 'Взносы на ремонт дорог' },
                { id: 3, month: '03', year: 2026, salary: 520, maintenance: 820, other: 220, description: 'Взносы на оплату охраны' }
            ];
            
            const fee = mockFees.find(f => f.id === feeId);
            if (!fee) return;
            
            document.getElementById('add-fee-form').style.display = 'block';
            document.getElementById('fee-form-title').textContent = 'Редактирование взносов';
            document.getElementById('save-fee-btn').textContent = 'Обновить взносы';
            document.getElementById('delete-fee-btn').style.display = 'inline-block';
            
            document.getElementById('edit-fee-month').value = fee.month;
            document.getElementById('edit-fee-year').value = fee.year;
            document.getElementById('edit-fee-description').value = fee.description;
            document.getElementById('edit-fee-salary').value = fee.salary;
            document.getElementById('edit-fee-maintenance').value = fee.maintenance;
            document.getElementById('edit-fee-other').value = fee.other;
            updateFeeTotal();
            
            currentEditingFeeId = feeId;
        }
        
        // Сохранение взносов
        async function saveFee() {
            const month = document.getElementById('edit-fee-month').value;
            const year = document.getElementById('edit-fee-year').value;
            const description = document.getElementById('edit-fee-description').value;
            const salary = parseFloat(document.getElementById('edit-fee-salary').value);
            const maintenance = parseFloat(document.getElementById('edit-fee-maintenance').value);
            const other = parseFloat(document.getElementById('edit-fee-other').value);
            const alert = document.getElementById('admin-fees-alert');
            
            if (!month || !year || !description || isNaN(salary) || isNaN(maintenance) || isNaN(other)) {
                alert.textContent = 'Заполните все поля корректно';
                alert.className = 'alert error';
                alert.style.display = 'block';
                return;
            }
            
            try {
                if (currentEditingFeeId) {
                    alert.textContent = `Взносы на ${MONTHS[month]} ${year} обновлены`;
                } else {
                    alert.textContent = `Новые взносы на ${MONTHS[month]} ${year} добавлены`;
                }
                
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                hideAddFeeForm();
                loadFees();
                
            } catch (error) {
                alert.textContent = 'Ошибка при сохранении взносов: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Удаление взносов (подтверждение)
        function deleteFeePrompt(feeId) {
            if (confirm('Вы уверены, что хотите удалить эти взносы?')) {
                deleteFee(feeId);
            }
        }
        
        // Удаление взносов
        async function deleteFee() {
            if (!currentEditingFeeId) return;
            
            const alert = document.getElementById('admin-fees-alert');
            
            try {
                alert.textContent = 'Взносы успешно удалены';
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                hideAddFeeForm();
                loadFees();
                
            } catch (error) {
                alert.textContent = 'Ошибка при удалении взносов: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Админ: Загрузка показаний
        async function loadReadings() {
            const tbody = document.getElementById('readings-table-body');
            const alert = document.getElementById('admin-readings-alert');
            const userFilter = document.getElementById('filter-user').value;
            const monthFilter = document.getElementById('filter-month').value;
            
            try {
                const mockReadings = [
                    { id: 1, user_id: 1, user_name: 'Иванов И.И.', date: '2026-01-15', reading: 700, previous_reading: 650, consumption: 50, electricity_cost: 305.50, month: '01', year: 2026 },
                    { id: 2, user_id: 2, user_name: 'Петров П.П.', date: '2026-01-14', reading: 850, previous_reading: 780, consumption: 70, electricity_cost: 427.70, month: '01', year: 2026 },
                    { id: 3, user_id: 3, user_name: 'Сидорова А.В.', date: '2026-01-13', reading: 920, previous_reading: 850, consumption: 70, electricity_cost: 427.70, month: '01', year: 2026 },
                    { id: 4, user_id: 1, user_name: 'Иванов И.И.', date: '2025-12-20', reading: 650, previous_reading: 580, consumption: 70, electricity_cost: 427.70, month: '12', year: 2025 },
                    { id: 5, user_id: 4, user_name: 'Кузнецов А.Н.', date: '2025-12-18', reading: 1100, previous_reading: 1020, consumption: 80, electricity_cost: 488.80, month: '12', year: 2025 }
                ];
                
                let filteredReadings = mockReadings;
                if (userFilter) {
                    filteredReadings = filteredReadings.filter(r => r.user_id == userFilter);
                }
                if (monthFilter) {
                    filteredReadings = filteredReadings.filter(r => r.month === monthFilter);
                }
                
                tbody.innerHTML = '';
                
                if (filteredReadings.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Нет данных для отображения</td></tr>`;
                } else {
                    filteredReadings.forEach(reading => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${reading.date}</td>
                            <td>${reading.user_name}</td>
                            <td>${reading.reading} кВт·ч</td>
                            <td>${reading.consumption} кВт·ч</td>
                            <td>${reading.electricity_cost.toFixed(2)} руб</td>
                            <td>
                                <button onclick="editReading(${reading.id})" style="padding: 5px 10px; font-size: 14px;">Изменить</button>
                                <button onclick="deleteReadingPrompt(${reading.id})" style="padding: 5px 10px; font-size: 14px; background: #dc3545; margin-left: 5px;">Удалить</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                if (alert) {
                    alert.textContent = `Загружено ${filteredReadings.length} показаний`;
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    setTimeout(() => { alert.style.display = 'none'; }, 3000);
                }
                
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #dc3545;">Ошибка загрузки: ${error.message}</td></tr>`;
                
                if (alert) {
                    alert.textContent = 'Ошибка загрузки показаний: ' + error.message;
                    alert.className = 'alert error';
                    alert.style.display = 'block';
                }
            }
        }
        
        // Заполнение фильтра пользователей
        function populateUserFilter() {
            const select = document.getElementById('filter-user');
            const monthSelect = document.getElementById('filter-month');
            
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            const mockUsers = [
                { id: 1, name: 'Иванов И.И.' },
                { id: 2, name: 'Петров П.П.' },
                { id: 3, name: 'Сидорова А.В.' },
                { id: 4, name: 'Кузнецов А.Н.' }
            ];
            
            mockUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                select.appendChild(option);
            });
            
            const months = [
                { value: '01', name: 'Январь' },
                { value: '02', name: 'Февраль' },
                { value: '03', name: 'Март' },
                { value: '04', name: 'Апрель' },
                { value: '05', name: 'Май' },
                { value: '06', name: 'Июнь' },
                { value: '07', name: 'Июль' },
                { value: '08', name: 'Август' },
                { value: '09', name: 'Сентябрь' },
                { value: '10', name: 'Октябрь' },
                { value: '11', name: 'Ноябрь' },
                { value: '12', name: 'Декабрь' }
            ];
            
            while (monthSelect.options.length > 1) {
                monthSelect.remove(1);
            }
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                monthSelect.appendChild(option);
            });
        }
        
        // Удаление показания (подтверждение)
        function deleteReadingPrompt(readingId) {
            if (confirm('Вы уверены, что хотите удалить это показание?')) {
                deleteReading(readingId);
            }
        }
        
        // Удаление показания
        async function deleteReading(readingId) {
            const alert = document.getElementById('admin-readings-alert');
            
            try {
                alert.textContent = 'Показание успешно удалено';
                alert.className = 'alert success';
                alert.style.display = 'block';
                
                loadReadings();
                
            } catch (error) {
                alert.textContent = 'Ошибка при удалении показания: ' + error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            }
        }
        
        // Обработка загрузки CSV файла
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            const alert = document.getElementById('admin-import-alert');
            
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    let importedCount = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = line.split(',');
                        if (parts.length >= 6) {
                            importedCount++;
                        }
                    }
                    
                    alert.textContent = `Успешно импортировано ${importedCount} пользователей из CSV`;
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    
                    loadUsers();
                    
                } catch (error) {
                    alert.textContent = 'Ошибка при обработке CSV файла: ' + error.message;
                    alert.className = 'alert error';
                    alert.style.display = 'block';
                }
            };
            
            reader.onerror = function() {
                alert.textContent = 'Ошибка чтения файла';
                alert.className = 'alert error';
                alert.style.display = 'block';
            };
            
            reader.readAsText(file);
        }
        
        // Скачивание шаблона CSV
        function downloadTemplate() {
            const csvContent = "login,password,name,section,phone,email\nuser1,password123,Иванов Иван Иванович,15,+79991234567,user1@example.com\nuser2,password456,Петров Петр Петрович,23,+79992345678,user2@example.com";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users-template.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Экспорт данных
        function exportData(type) {
            let csvContent = '';
            let filename = '';
            
            if (type === 'users') {
                csvContent = "id,login,name,section,phone,email,is_admin\n1,user1,Иванов Иван Иванович,15,+79991234567,user1@example.com,false\n2,admin,Администратор,0,+79990000000,admin@zvezdochka.ru,true";
                filename = 'users-export.csv';
            } else if (type === 'tariffs') {
                csvContent = "id,month,year,loss_tariff,under100_tariff,over100_tariff\n1,01,2026,0.36,6.10,7.30\n2,02,2026,0.38,6.20,7.40";
                filename = 'tariffs-export.csv';
            } else if (type === 'fees') {
                csvContent = "id,month,year,salary,maintenance,other,description\n1,01,2026,500,800,200,Взносы на содержание территории\n2,02,2026,550,850,250,Взносы на ремонт дорог";
                filename = 'fees-export.csv';
            } else if (type === 'readings') {
                csvContent = "id,user_id,date,reading,previous_reading,consumption,electricity_cost,month,year\n1,1,2026-01-15,700,650,50,305.50,01,2026\n2,2,2026-01-14,850,780,70,427.70,01,2026";
                filename = 'readings-export.csv';
            } else if (type === 'all') {
                csvContent = "Тип,Данные\nПользователи,2 записи\nТарифы,2 записи\nВзносы,2 записи\nПоказания,2 записи";
                filename = 'all-data-export.csv';
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            const alert = document.getElementById('admin-import-alert');
            alert.textContent = `Данные экспортированы в файл ${filename}`;
            alert.className = 'alert success';
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }
        
        // Быстрые действия администратора
        function generateMonthlyReadings() {
            const alert = document.getElementById('admin-import-alert');
            alert.textContent = 'Генерация показаний за текущий месяц выполнена';
            alert.className = 'alert success';
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }
        
        function calculateAllPayments() {
            const alert = document.getElementById('admin-import-alert');
            alert.textContent = 'Расчет всех платежей выполнен';
            alert.className = 'alert success';
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }
        
        function sendMonthlyReminders() {
            const alert = document.getElementById('admin-import-alert');
            alert.textContent = 'Напоминания о подаче показаний отправлены';
            alert.className = 'alert success';
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }
        
        // Демо-функции для кнопок редактирования/удаления
        function editUser(id) {
            alert(`Редактирование пользователя ID: ${id}\n(В реальном приложении здесь будет форма редактирования)`);
        }
        
        function deleteUser(id) {
            if (confirm(`Вы уверены, что хотите удалить пользователя ID: ${id}?`)) {
                const alert = document.getElementById('admin-users-alert');
                alert.textContent = `Пользователь ID: ${id} удален`;
                alert.className = 'alert success';
                alert.style.display = 'block';
                setTimeout(() => { 
                    alert.style.display = 'none'; 
                    loadUsers(); 
                }, 2000);
            }
        }
        
        function editReading(id) {
            alert(`Редактирование показания ID: ${id}\n(В реальном приложении здесь будет форма редактирования)`);
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkSupabaseConnection();
            
            document.getElementById('user-meter-reading').addEventListener('input', updateCalculation);
            
            // Обновление итоговой суммы при изменении взносов в форме админа
            document.getElementById('edit-fee-salary').addEventListener('input', updateFeeTotal);
            document.getElementById('edit-fee-maintenance').addEventListener('input', updateFeeTotal);
            document.getElementById('edit-fee-other').addEventListener('input', updateFeeTotal);
            
            updateCalculation();
            
            // Устанавливаем текущий месяц для пользователя
            const now = new Date();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            const currentYear = now.getFullYear();
            
            document.getElementById('user-month').value = currentMonth;
            document.getElementById('user-year').value = currentYear;
            
            document.getElementById('tariff-month').value = currentMonth;
            document.getElementById('tariff-year').value = currentYear;
            
            document.getElementById('fees-month').value = currentMonth;
            document.getElementById('fees-year').value = currentYear;
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
