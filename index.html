<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ù–¢ "–ó–≤–µ–∑–¥–æ—á–∫–∞" - –£—á–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∏–π</title>
    <link href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            color: #718096;
            font-size: 1.1rem;
        }
        
        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .system-alert {
            display: none;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .system-alert.success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #38a169;
        }
        
        .system-alert.error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #e53e3e;
        }
        
        .system-alert.warning {
            background: #feebc8;
            color: #744210;
            border: 2px solid #d69e2e;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .card h2 {
            color: #2d3748;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            border-bottom: 3px solid #4299e1;
            padding-bottom: 0.5rem;
        }
        
        /* –§–æ—Ä–º—ã */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 500;
            font-size: 1rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: #f8fafc;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4299e1;
            background: white;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            display: inline-block;
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(49, 130, 206, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(56, 161, 105, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-2px);
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .nav-tab {
            flex: 1;
            padding: 1.2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            background: #f8fafc;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab:hover {
            background: #edf2f7;
            color: #2d3748;
        }
        
        .nav-tab.active {
            background: white;
            color: #4299e1;
            border-bottom: 3px solid #4299e1;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .table-responsive {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .data-table th {
            background: #4299e1;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        
        .data-table tr:hover {
            background: #f8fafc;
        }
        
        /* –°—Ç–∞—Ç—É—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .status-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-warning {
            background: #feebc8;
            color: #744210;
        }
        
        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        /* –°–µ—Ç–∫–∞ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                padding: 1rem;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .nav-tab.active {
                border-bottom: 3px solid #4299e1;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="systemAlert" class="system-alert"></div>
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="header">
            <h1>–°–ù–¢ "–ó–≤–µ–∑–¥–æ—á–∫–∞" üåü</h1>
            <p class="subtitle">–£—á–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –∏ —á–ª–µ–Ω—Å–∫–∏—Ö –≤–∑–Ω–æ—Å–æ–≤</p>
            <div id="userInfo" style="margin-top: 1rem;"></div>
        </header>
        
        <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <nav class="nav-tabs">
            <button class="nav-tab" data-tab="login">–í—Ö–æ–¥</button>
            <button class="nav-tab" data-tab="userDashboard">–ú–æ–π –∫–∞–±–∏–Ω–µ—Ç</button>
            <button class="nav-tab" data-tab="submitReadings">–ü–æ–¥–∞—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è</button>
            <button class="nav-tab" data-tab="payments">–ú–æ–∏ –ø–ª–∞—Ç–µ–∂–∏</button>
            <button class="nav-tab" data-tab="adminPanel" style="display: none;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
            <button class="nav-tab" id="logoutBtn" style="display: none;">–í—ã–π—Ç–∏</button>
        </nav>
        
        <!-- –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div id="login" class="tab-content active">
            <div class="card">
                <h2>–í—Ö–æ–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">–í–æ–π—Ç–∏</button>
                </form>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="showRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="registerForm" style="display: none;">
                <div class="card">
                    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    <form id="signupForm">
                        <div class="form-group">
                            <label for="regEmail">Email</label>
                            <input type="email" id="regEmail" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="regPassword">–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                            <input type="password" id="regPassword" class="form-control" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="fullName">–§–ò–û</label>
                            <input type="text" id="fullName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="landArea">–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞ (—Å–æ—Ç–æ–∫)</label>
                            <input type="number" id="landArea" class="form-control" value="6" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="plotCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∫–æ–≤</label>
                            <input type="number" id="plotCount" class="form-control" value="1" required>
                        </div>
                        <button type="submit" class="btn btn-success" style="width: 100%;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </form>
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="showLogin">–í–æ–π—Ç–∏</a></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç -->
        <div id="userDashboard" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üìä –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</h2>
                    <div id="userData"></div>
                </div>
                
                <div class="card">
                    <h2>‚ö° –ú–æ–∏ —Å—á–µ—Ç—á–∏–∫–∏</h2>
                    <div id="userMeters"></div>
                    <button class="btn btn-secondary" onclick="showAddMeterForm()" style="margin-top: 1rem;">–î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫</button>
                </div>
                
                <div class="card">
                    <h2>üí∞ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å—á–µ—Ç</h2>
                    <div id="lastCalculation"></div>
                </div>
            </div>
        </div>
        
        <!-- –ü–æ–¥–∞—á–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π -->
        <div id="submitReadings" class="tab-content">
            <div class="card">
                <h2>üìù –ü–æ–¥–∞—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤</h2>
                <div id="metersForReading"></div>
                <form id="readingForm" style="display: none;">
                    <div class="form-group">
                        <label for="selectedMonth">–ú–µ—Å—è—Ü</label>
                        <input type="month" id="selectedMonth" class="form-control" required>
                    </div>
                    <div id="readingsInputs"></div>
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è</button>
                </form>
            </div>
        </div>
        
        <!-- –ú–æ–∏ –ø–ª–∞—Ç–µ–∂–∏ -->
        <div id="payments" class="tab-content">
            <div class="card">
                <h2>üí≥ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h2>
                <div id="paymentsHistory"></div>
            </div>
        </div>
        
        <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
        <div id="adminPanel" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                    <div id="allUsersList"></div>
                </div>
                
                <div class="card">
                    <h2>üìä –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã</h2>
                    <form id="setTariffsForm">
                        <div class="form-group">
                            <label for="tariffMonth">–ú–µ—Å—è—Ü</label>
                            <input type="month" id="tariffMonth" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="lossRate">–¢–∞—Ä–∏—Ñ –Ω–∞ –ø–æ—Ç–µ—Ä–∏ (‚ÇΩ/–∫–í—Ç¬∑—á)</label>
                            <input type="number" step="0.01" id="lossRate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="rateUnder100">–î–æ 100 –∫–í—Ç¬∑—á (‚ÇΩ/–∫–í—Ç¬∑—á)</label>
                            <input type="number" step="0.01" id="rateUnder100" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="rateOver100">–°–≤—ã—à–µ 100 –∫–í—Ç¬∑—á (‚ÇΩ/–∫–í—Ç¬∑—á)</label>
                            <input type="number" step="0.01" id="rateOver100" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üì¶ –ü–∞–∫–µ—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                    <div class="form-group">
                        <label for="batchFile">–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV —Ñ–∞–π–ª</label>
                        <input type="file" id="batchFile" class="form-control" accept=".csv">
                    </div>
                    <button class="btn btn-secondary" onclick="processBatchFile()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
                    <button class="btn btn-primary" onclick="exportAllData()" style="margin-top: 1rem;">–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="addMeterModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 90%;">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫</h2>
            <form id="addMeterForm">
                <div class="form-group">
                    <label for="meterName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞</label>
                    <input type="text" id="meterName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="serialNumber">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                    <input type="text" id="serialNumber" class="form-control">
                </div>
                <div class="btn-group" style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddMeterModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase[citation:1]
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ2JkYnVpcXpkbXdpbml5eHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Supabase[citation:1][citation:3]
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let userRole = 'user';
        
        // ==================== –°–ò–°–¢–ï–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('systemAlert');
            alert.textContent = message;
            alert.className = `system-alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        function switchTab(tabId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabId).classList.add('active');
            
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }
        
        // ==================== –ü–†–û–í–ï–†–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ====================
        
        async function checkSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                
                if (error) {
                    showAlert(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase: ${error.message}`, 'error');
                    return false;
                }
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API
                const testResponse = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (testResponse.ok) {
                    showAlert('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                    return true;
                } else {
                    showAlert('‚ö†Ô∏è Supabase API –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ REST endpoint –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É', 'warning');
                    return false;
                }
            } catch (error) {
                showAlert(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Supabase: ${error.message}`, 'error');
                return false;
            }
        }
        
        // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
        
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, 'error');
                return;
            }
            
            currentUser = data.user;
            await loadUserData();
            showAlert('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelector('[data-tab="adminPanel"]').style.display = userRole === 'admin' ? 'inline-block' : 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            
            switchTab('userDashboard');
        }
        
        async function handleSignup(event) {
            event.preventDefault();
            
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const fullName = document.getElementById('fullName').value;
            const landArea = parseFloat(document.getElementById('landArea').value);
            const plotCount = parseInt(document.getElementById('plotCount').value);
            
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è[citation:3][citation:8]
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: fullName
                    }
                }
            });
            
            if (authError) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${authError.message}`, 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ profiles
            const { error: profileError } = await supabase.from('profiles').insert({
                id: authData.user.id,
                full_name: fullName,
                land_area: landArea,
                plot_count: plotCount,
                role: 'user'
            });
            
            if (profileError) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ${profileError.message}`, 'error');
                return;
            }
            
            showAlert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.', 'success');
            document.getElementById('showLogin').click();
        }
        
        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            userRole = 'user';
            
            // –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            document.querySelector('[data-tab="adminPanel"]').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').innerHTML = '';
            
            switchTab('login');
            showAlert('‚úÖ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                return;
            }
            
            userRole = profile.role || 'user';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            document.getElementById('userInfo').innerHTML = `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 10px; display: inline-block;">
                    <strong>üë§ ${profile.full_name || currentUser.email}</strong>
                    <span class="status-badge ${userRole === 'admin' ? 'status-success' : 'status-warning'}" 
                          style="margin-left: 1rem;">
                        ${userRole === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                    </span>
                </div>
            `;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
            await loadDashboardData();
            await loadUserMeters();
            await loadPaymentsHistory();
        }
        
        // ==================== –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ====================
        
        async function loadDashboardData() {
            if (!currentUser) return;
            
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const monthStr = lastMonth.toISOString().slice(0, 7);
            
            // –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
            const { data: lastReading } = await supabase
                .from('meter_readings')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('month', { ascending: false })
                .limit(1)
                .single();
            
            const { data: lastFee } = await supabase
                .from('membership_fees')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('month', { ascending: false })
                .limit(1)
                .single();
            
            document.getElementById('userData').innerHTML = `
                <p><strong>–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞:</strong> ${profile.land_area} —Å–æ—Ç–æ–∫</p>
                <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∫–æ–≤:</strong> ${profile.plot_count}</p>
                <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${new Date(profile.created_at).toLocaleDateString('ru-RU')}</p>
            `;
            
            let calculationHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—á–µ—Ç–∞—Ö</p>';
            if (lastReading || lastFee) {
                calculationHTML = `
                    <div style="background: #f0fff4; padding: 1rem; border-radius: 10px;">
                        <p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å—á–µ—Ç:</strong></p>
                        ${lastReading ? `<p>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: ${lastReading.amount || 0} ‚ÇΩ</p>` : ''}
                        ${lastFee ? `<p>–ß–ª–µ–Ω—Å–∫–∏–µ –≤–∑–Ω–æ—Å—ã: ${lastFee.total_amount || 0} ‚ÇΩ</p>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('lastCalculation').innerHTML = calculationHTML;
        }
        
        async function loadUserMeters() {
            if (!currentUser) return;
            
            const { data: meters, error } = await supabase
                .from('meters')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: true });
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤:', error);
                return;
            }
            
            let metersHTML = '';
            if (meters && meters.length > 0) {
                meters.forEach(meter => {
                    metersHTML += `
                        <div style="background: #f8fafc; padding: 1rem; margin-bottom: 1rem; border-radius: 10px;">
                            <p><strong>${meter.name}</strong></p>
                            <p>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${meter.serial_number || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <span class="status-badge ${meter.is_active ? 'status-success' : 'status-error'}">
                                ${meter.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                            </span>
                        </div>
                    `;
                });
            } else {
                metersHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤</p>';
            }
            
            document.getElementById('userMeters').innerHTML = metersHTML;
            await loadMetersForReading();
        }
        
        function showAddMeterForm() {
            document.getElementById('addMeterModal').style.display = 'flex';
        }
        
        function closeAddMeterModal() {
            document.getElementById('addMeterModal').style.display = 'none';
        }
        
        async function handleAddMeter(event) {
            event.preventDefault();
            
            const name = document.getElementById('meterName').value;
            const serialNumber = document.getElementById('serialNumber').value;
            
            const { error } = await supabase.from('meters').insert({
                user_id: currentUser.id,
                name: name,
                serial_number: serialNumber || null,
                is_active: true
            });
            
            if (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞: ${error.message}`, 'error');
                return;
            }
            
            showAlert('‚úÖ –°—á–µ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            closeAddMeterModal();
            await loadUserMeters();
            document.getElementById('addMeterForm').reset();
        }
        
        // ==================== –ü–û–ö–ê–ó–ê–ù–ò–Ø –°–ß–ï–¢–ß–ò–ö–û–í ====================
        
        async function loadMetersForReading() {
            if (!currentUser) return;
            
            const { data: meters } = await supabase
                .from('meters')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);
            
            if (!meters || meters.length === 0) {
                document.getElementById('metersForReading').innerHTML = 
                    '<p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è –ø–æ–¥–∞—á–∏ –ø–æ–∫–∞–∑–∞–Ω–∏–π</p>';
                document.getElementById('readingForm').style.display = 'none';
                return;
            }
            
            let metersHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≤–≤–µ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è:</p>';
            
            let inputsHTML = '';
            meters.forEach(meter => {
                inputsHTML += `
                    <div class="form-group">
                        <label for="meter_${meter.id}">${meter.name} (${meter.serial_number || '–±–µ–∑ –Ω–æ–º–µ—Ä–∞'})</label>
                        <input type="number" step="0.001" id="meter_${meter.id}" 
                               class="form-control" placeholder="–¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è" required>
                    </div>
                `;
            });
            
            document.getElementById('metersForReading').innerHTML = metersHTML;
            document.getElementById('readingsInputs').innerHTML = inputsHTML;
            document.getElementById('readingForm').style.display = 'block';
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            document.getElementById('selectedMonth').value = currentMonth;
        }
        
        async function calculateElectricityCost(consumption, tariffMonth) {
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü[citation:1]
            const { data: tariff } = await supabase
                .from('electricity_tariffs')
                .select('*')
                .eq('month', tariffMonth + '-01')
                .single();
            
            if (!tariff) {
                throw new Error('–¢–∞—Ä–∏—Ñ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            let totalCost = 0;
            
            // 1. –†–∞—Å—á–µ—Ç –ø–æ—Ç–µ—Ä—å
            totalCost += consumption * tariff.loss_rate;
            
            // 2. –†–∞—Å—á–µ—Ç –ø–æ —Å—Ç—É–ø–µ–Ω—á–∞—Ç–æ–º—É —Ç–∞—Ä–∏—Ñ—É
            if (consumption <= 100) {
                totalCost += consumption * tariff.rate_under_100;
            } else {
                totalCost += 100 * tariff.rate_under_100;
                totalCost += (consumption - 100) * tariff.rate_over_100;
            }
            
            return Math.round(totalCost * 100) / 100;
        }
        
        async function handleSubmitReadings(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showAlert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                return;
            }
            
            const month = document.getElementById('selectedMonth').value + '-01';
            const meters = document.querySelectorAll('[id^="meter_"]');
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π
            const { data: previousReadings } = await supabase
                .from('meter_readings')
                .select('meter_id, reading')
                .eq('user_id', currentUser.id)
                .lt('month', month)
                .order('month', { ascending: false });
            
            const readingsMap = {};
            previousReadings?.forEach(r => {
                if (!readingsMap[r.meter_id]) {
                    readingsMap[r.meter_id] = r.reading;
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
            for (const input of meters) {
                const meterId = input.id.replace('meter_', '');
                const currentReading = parseFloat(input.value);
                
                if (isNaN(currentReading) || currentReading < 0) {
                    showAlert(`‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ ${meterId}`, 'error');
                    continue;
                }
                
                const previousReading = readingsMap[meterId] || 0;
                const consumption = currentReading - previousReading;
                
                if (consumption < 0) {
                    showAlert(`‚ùå –ü–æ–∫–∞–∑–∞–Ω–∏—è –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö (${previousReading})`, 'error');
                    continue;
                }
                
                // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                const amount = await calculateElectricityCost(consumption, month.slice(0, 7));
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π[citation:1]
                const { error } = await supabase.from('meter_readings').upsert({
                    meter_id: meterId,
                    month: month,
                    reading: currentReading,
                    previous_reading: previousReading,
                    consumption: consumption,
                    amount: amount,
                    user_id: currentUser.id
                });
                
                if (error) {
                    showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π: ${error.message}`, 'error');
                }
            }
            
            showAlert('‚úÖ –ü–æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã', 'success');
            document.getElementById('readingForm').reset();
            await loadDashboardData();
        }
        
        // ==================== –ü–õ–ê–¢–ï–ñ–ò –ò –í–ó–ù–û–°–´ ====================
        
        async function calculateMembershipFee(userId, month) {
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();
            
            const { data: tariff } = await supabase
                .from('membership_tariffs')
                .select('*')
                .eq('month', month + '-01')
                .single();
            
            if (!tariff) {
                throw new Error('–¢–∞—Ä–∏—Ñ –Ω–∞ —á–ª–µ–Ω—Å–∫–∏–µ –≤–∑–Ω–æ—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            let total = 0;
            
            // 1. –í–∑–Ω–æ—Å —Å –∑–∞—Ä–ø–ª–∞—Ç—ã (–∑–∞ —É—á–∞—Å—Ç–æ–∫)
            total += profile.plot_count * tariff.salary_per_plot;
            
            // 2. –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (–∑–∞ —Å–æ—Ç–∫—É)
            total += profile.land_area * tariff.maintenance_per_land_unit;
            
            // 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∑–Ω–æ—Å—ã
            total += tariff.additional_rate1 + tariff.additional_rate2 + tariff.additional_rate3;
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞
            const { error } = await supabase.from('membership_fees').upsert({
                user_id: userId,
                month: month + '-01',
                salary_fee: profile.plot_count * tariff.salary_per_plot,
                maintenance_fee: profile.land_area * tariff.maintenance_per_land_unit,
                additional_fee1: tariff.additional_rate1,
                additional_fee2: tariff.additional_rate2,
                additional_fee3: tariff.additional_rate3,
                total_amount: total
            });
            
            if (error) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∑–Ω–æ—Å–æ–≤: ${error.message}`);
            }
            
            return total;
        }
        
        async function loadPaymentsHistory() {
            if (!currentUser) return;
            
            const { data: readings } = await supabase
                .from('meter_readings')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('month', { ascending: false })
                .limit(12);
            
            const { data: fees } = await supabase
                .from('membership_fees')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('month', { ascending: false })
                .limit(12);
            
            let historyHTML = '';
            
            if ((!readings || readings.length === 0) && (!fees || fees.length === 0)) {
                historyHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–ª–∞—Ç–µ–∂–∞—Ö</p>';
            } else {
                historyHTML += '<div class="table-responsive"><table class="data-table">';
                historyHTML += '<thead><tr><th>–ú–µ—Å—è—Ü</th><th>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</th><th>–í–∑–Ω–æ—Å—ã</th><th>–í—Å–µ–≥–æ</th></tr></thead><tbody>';
                
                const allPayments = {};
                
                // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                readings?.forEach(r => {
                    const month = r.month.slice(0, 7);
                    if (!allPayments[month]) {
                        allPayments[month] = { electricity: 0, fees: 0 };
                    }
                    allPayments[month].electricity += r.amount || 0;
                });
                
                fees?.forEach(f => {
                    const month = f.month.slice(0, 7);
                    if (!allPayments[month]) {
                        allPayments[month] = { electricity: 0, fees: 0 };
                    }
                    allPayments[month].fees += f.total_amount || 0;
                });
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –º–µ—Å—è—Ü–µ–≤
                const sortedMonths = Object.keys(allPayments).sort().reverse();
                
                sortedMonths.forEach(month => {
                    const payment = allPayments[month];
                    const total = payment.electricity + payment.fees;
                    
                    historyHTML += `
                        <tr>
                            <td>${month}</td>
                            <td>${payment.electricity.toFixed(2)} ‚ÇΩ</td>
                            <td>${payment.fees.toFixed(2)} ‚ÇΩ</td>
                            <td><strong>${total.toFixed(2)} ‚ÇΩ</strong></td>
                        </tr>
                    `;
                });
                
                historyHTML += '</tbody></table></div>';
            }
            
            document.getElementById('paymentsHistory').innerHTML = historyHTML;
        }
        
        // ==================== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ ====================
        
        async function loadAllUsers() {
            if (userRole !== 'admin') return;
            
            const { data: users, error } = await supabase
                .from('profiles')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                return;
            }
            
            let usersHTML = '<div class="table-responsive"><table class="data-table">';
            usersHTML += '<thead><tr><th>–§–ò–û</th><th>Email</th><th>–£—á–∞—Å—Ç–∫–∏</th><th>–°–æ—Ç–æ–∫</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            users.forEach(user => {
                usersHTML += `
                    <tr>
                        <td>${user.full_name || '-'}</td>
                        <td>${user.id}</td>
                        <td>${user.plot_count}</td>
                        <td>${user.land_area}</td>
                        <td>
                            <select class="form-control" style="width: auto;" 
                                    onchange="updateUserRole('${user.id}', this.value)">
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="editUser('${user.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        </td>
                    </tr>
                `;
            });
            
            usersHTML += '</tbody></table></div>';
            document.getElementById('allUsersList').innerHTML = usersHTML;
        }
        
        async function updateUserRole(userId, newRole) {
            const { error } = await supabase
                .from('profiles')
                .update({ role: newRole })
                .eq('id', userId);
            
            if (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏: ${error.message}`, 'error');
                return;
            }
            
            showAlert(`‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ "${newRole}"`, 'success');
        }
        
        async function handleSetTariffs(event) {
            event.preventDefault();
            
            if (userRole !== 'admin') {
                showAlert('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ—ã', 'error');
                return;
            }
            
            const month = document.getElementById('tariffMonth').value + '-01';
            const lossRate = parseFloat(document.getElementById('lossRate').value);
            const rateUnder100 = parseFloat(document.getElementById('rateUnder100').value);
            const rateOver100 = parseFloat(document.getElementById('rateOver100').value);
            
            const { error } = await supabase.from('electricity_tariffs').upsert({
                month: month,
                loss_rate: lossRate,
                rate_under_100: rateUnder100,
                rate_over_100: rateOver100
            });
            
            if (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞: ${error.message}`, 'error');
                return;
            }
            
            showAlert('‚úÖ –¢–∞—Ä–∏—Ñ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
            document.getElementById('setTariffsForm').reset();
        }
        
        async function exportAllData() {
            if (userRole !== 'admin') {
                showAlert('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
                return;
            }
            
            // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
            const [users, meters, readings, fees, tariffs] = await Promise.all([
                supabase.from('profiles').select('*'),
                supabase.from('meters').select('*'),
                supabase.from('meter_readings').select('*'),
                supabase.from('membership_fees').select('*'),
                supabase.from('electricity_tariffs').select('*')
            ]);
            
            const exportData = {
                export_date: new Date().toISOString(),
                users: users.data,
                meters: meters.data,
                readings: readings.data,
                fees: fees.data,
                tariffs: tariffs.data
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `snt_zvezdochka_export_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }
        
        function processBatchFile() {
            const fileInput = document.getElementById('batchFile');
            if (!fileInput.files.length) {
                showAlert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const csvData = e.target.result;
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É CSV —Ñ–∞–π–ª–∞
                showAlert('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω. –û–±—Ä–∞–±–æ—Ç–∫–∞ CSV —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.', 'success');
            };
            
            reader.readAsText(file);
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase
            await checkSupabaseConnection();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('readingForm').addEventListener('submit', handleSubmitReadings);
            document.getElementById('addMeterForm').addEventListener('submit', handleAddMeter);
            document.getElementById('setTariffsForm').addEventListener('submit', handleSetTariffs);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤—Ö–æ–¥–æ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            });
            
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
            });
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadUserData();
                switchTab('userDashboard');
            }
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    currentUser = session.user;
                    await loadUserData();
                } else {
                    currentUser = null;
                    userRole = 'user';
                }
            });
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
        window.showAddMeterForm = showAddMeterForm;
        window.closeAddMeterModal = closeAddMeterModal;
        window.editUser = function(userId) {
            showAlert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'warning');
        };
        window.updateUserRole = updateUserRole;
        window.processBatchFile = processBatchFile;
        window.exportAllData = exportAllData;
    </script>
</body>
</html>
