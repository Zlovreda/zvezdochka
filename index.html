<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СНТ "Звездочка" - Учет показаний</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .auth-container, .user-container, .admin-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            display: none;
        }

        .active {
            display: block;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #4a5568;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        h3 {
            color: #4a5568;
            margin: 20px 0 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        input, select, button {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #48bb78;
        }

        button.danger {
            background: #f56565;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background-color: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert.error {
            background-color: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert.info {
            background-color: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            color: #4a5568;
            font-size: 16px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            background: none;
            width: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        tr:hover {
            background-color: #f7fafc;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
        }

        .logout-btn {
            width: auto;
            padding: 8px 20px;
            background: #f56565;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .header {
            position: relative;
            margin-bottom: 40px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .month-selector button {
            width: auto;
            padding: 8px 16px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: #48bb78;
        }

        .status-offline {
            background-color: #f56565;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .auth-container, .user-container, .admin-container {
                padding: 20px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Страница аутентификации -->
        <div id="authContainer" class="auth-container active">
            <h1>СНТ "Звездочка"</h1>
            <div class="alert" id="authAlert"></div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchAuthTab('login')">Вход</button>
                <button class="tab" onclick="switchAuthTab('register')">Регистрация</button>
            </div>
            
            <div id="loginTab" class="tab-content active">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Введите ваш email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword" placeholder="Введите пароль">
                </div>
                <button onclick="login()">Войти</button>
            </div>
            
            <div id="registerTab" class="tab-content">
                <div class="form-group">
                    <label for="registerName">ФИО:</label>
                    <input type="text" id="registerName" placeholder="Иванов Иван Иванович">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" placeholder="Введите ваш email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Пароль:</label>
                    <input type="password" id="registerPassword" placeholder="Придумайте пароль">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Подтвердите пароль:</label>
                    <input type="password" id="confirmPassword" placeholder="Повторите пароль">
                </div>
                <div class="form-group">
                    <label for="plotNumber">Номер участка:</label>
                    <input type="text" id="plotNumber" placeholder="Например: 45">
                </div>
                <button onclick="register()">Зарегистрироваться</button>
            </div>
        </div>

        <!-- Личный кабинет пользователя -->
        <div id="userContainer" class="user-container">
            <div class="header">
                <h1>Личный кабинет СНТ "Звездочка"</h1>
                <button class="logout-btn" onclick="logout()">Выйти</button>
            </div>
            
            <div class="alert" id="userAlert"></div>
            
            <div class="card">
                <h3>Информация о пользователе</h3>
                <p><strong>ФИО:</strong> <span id="userName"></span></p>
                <p><strong>Номер участка:</strong> <span id="userPlot"></span></p>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchUserTab('current')">Текущий месяц</button>
                <button class="tab" onclick="switchUserTab('counters')">Показания счетчиков</button>
                <button class="tab" onclick="switchUserTab('history')">История</button>
            </div>
            
            <div id="currentTab" class="tab-content active">
                <div class="month-selector">
                    <button onclick="prevMonth()">←</button>
                    <h3 id="currentMonth"></h3>
                    <button onclick="nextMonth()">→</button>
                </div>
                
                <div class="card">
                    <h3>Электроэнергия</h3>
                    <div id="electricityInfo"></div>
                </div>
                
                <div class="card">
                    <h3>Членские взносы</h3>
                    <div id="duesInfo"></div>
                </div>
                
                <div class="total-amount" id="totalAmount"></div>
            </div>
            
            <div id="countersTab" class="tab-content">
                <h3>Передать показания счетчиков</h3>
                <div class="form-group">
                    <label for="counterValue">Текущие показания (кВт·ч):</label>
                    <input type="number" id="counterValue" placeholder="Введите текущие показания" step="0.01">
                </div>
                <div class="form-group">
                    <label for="counterDate">Дата снятия показаний:</label>
                    <input type="date" id="counterDate">
                </div>
                <button onclick="submitCounter()">Передать показания</button>
                
                <h3 style="margin-top: 40px;">История показаний</h3>
                <div id="counterHistory"></div>
            </div>
            
            <div id="historyTab" class="tab-content">
                <h3>История начислений</h3>
                <div id="paymentHistory"></div>
            </div>
        </div>

        <!-- Кабинет администратора -->
        <div id="adminContainer" class="admin-container">
            <div class="header">
                <h1>Администратор СНТ "Звездочка"</h1>
                <button class="logout-btn" onclick="logout()">Выйти</button>
            </div>
            
            <div class="alert" id="adminAlert"></div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchAdminTab('users')">Пользователи</button>
                <button class="tab" onclick="switchAdminTab('tariffs')">Тарифы</button>
                <button class="tab" onclick="switchAdminTab('counters')">Показания</button>
                <button class="tab" onclick="switchAdminTab('dues')">Взносы</button>
                <button class="tab" onclick="switchAdminTab('export')">Экспорт/Импорт</button>
            </div>
            
            <div id="usersTab" class="tab-content active">
                <h3>Управление пользователями</h3>
                <button onclick="loadUsers()" class="secondary">Обновить список</button>
                <div id="usersList" class="loading">Загрузка пользователей...</div>
            </div>
            
            <div id="tariffsTab" class="tab-content">
                <h3>Управление тарифами</h3>
                <div class="grid">
                    <div class="card">
                        <h3>Электроэнергия</h3>
                        <div class="form-group">
                            <label for="lossesTariff">Потери (₽ за кВт·ч):</label>
                            <input type="number" id="lossesTariff" step="0.01" value="0.36">
                        </div>
                        <div class="form-group">
                            <label for="under100Tariff">До 100 кВт·ч (₽ за кВт·ч):</label>
                            <input type="number" id="under100Tariff" step="0.01" value="6.10">
                        </div>
                        <div class="form-group">
                            <label for="over100Tariff">Свыше 100 кВт·ч (₽ за кВт·ч):</label>
                            <input type="number" id="over100Tariff" step="0.01" value="7.30">
                        </div>
                        <button onclick="saveTariffs()">Сохранить тарифы</button>
                    </div>
                </div>
            </div>
            
            <div id="countersTab" class="tab-content">
                <h3>Управление показаниями</h3>
                <div class="form-group">
                    <label>Выберите пользователя:</label>
                    <select id="adminUserSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="adminCounterValue">Показания (кВт·ч):</label>
                    <input type="number" id="adminCounterValue" step="0.01">
                </div>
                <div class="form-group">
                    <label for="adminCounterMonth">Месяц и год:</label>
                    <input type="month" id="adminCounterMonth">
                </div>
                <button onclick="adminSubmitCounter()" class="secondary">Добавить показания</button>
                
                <h3 style="margin-top: 40px;">Все показания</h3>
                <div id="allCounters" class="loading">Загрузка показаний...</div>
            </div>
            
            <div id="duesTab" class="tab-content">
                <h3>Членские взносы</h3>
                <div class="form-group">
                    <label for="duesMonth">Месяц и год:</label>
                    <input type="month" id="duesMonth">
                </div>
                <div class="form-group">
                    <label for="salaryDue">Зарплата (₽):</label>
                    <input type="number" id="salaryDue" step="0.01" placeholder="Сумма">
                </div>
                <div class="form-group">
                    <label for="maintenanceDue">Содержание (₽):</label>
                    <input type="number" id="maintenanceDue" step="0.01" placeholder="Сумма">
                </div>
                <div class="form-group">
                    <label for="otherDue">Прочее (₽):</label>
                    <input type="number" id="otherDue" step="0.01" placeholder="Сумма">
                </div>
                <button onclick="setDuesForAll()" class="secondary">Применить ко всем пользователям</button>
                
                <h3 style="margin-top: 40px;">История взносов</h3>
                <div id="duesHistory" class="loading">Загрузка истории...</div>
            </div>
            
            <div id="exportTab" class="tab-content">
                <h3>Экспорт и импорт данных</h3>
                <div class="grid">
                    <div class="card">
                        <h3>Экспорт данных</h3>
                        <button onclick="exportData('users')" class="secondary">Экспорт пользователей</button>
                        <button onclick="exportData('counters')" class="secondary">Экспорт показаний</button>
                        <button onclick="exportData('dues')" class="secondary">Экспорт взносов</button>
                        <button onclick="exportData('payments')" class="secondary">Экспорт платежей</button>
                    </div>
                    
                    <div class="card">
                        <h3>Импорт данных</h3>
                        <div class="form-group">
                            <label for="importType">Тип данных:</label>
                            <select id="importType">
                                <option value="counters">Показания счетчиков</option>
                                <option value="dues">Членские взносы</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="importFile">CSV файл:</label>
                            <input type="file" id="importFile" accept=".csv">
                        </div>
                        <button onclick="importData()" class="secondary">Импортировать</button>
                        <p style="margin-top: 20px; font-size: 14px; color: #666;">
                            Формат CSV: для показаний - user_id,month,year,value; для взносов - month,year,salary,maintenance,other
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_9NXa4FwnnrICXnXmrOVqRg_KB5LHkmk';

        let supabase;
        let currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let allUsers = [];

        // Инициализация приложения
        async function initApp() {
            showAlert('authAlert', 'info', 'Проверка подключения к базе данных...', false);
            
            try {
                // Загружаем Supabase из CDN
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.onload = async () => {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    // Проверяем подключение
                    const { data, error } = await supabase.from('users').select('count');
                    
                    if (error && error.message.includes('does not exist')) {
                        // Таблицы не существуют, нужно их создать
                        await createDatabaseTables();
                        showAlert('authAlert', 'success', 'База данных успешно инициализирована!', true);
                    } else if (error) {
                        showAlert('authAlert', 'error', 'Ошибка подключения к базе данных: ' + error.message, true);
                    } else {
                        showAlert('authAlert', 'success', 'Подключение к базе данных успешно!', true);
                    }
                    
                    // Проверяем авторизацию
                    await checkAuth();
                };
                document.head.appendChild(script);
            } catch (error) {
                showAlert('authAlert', 'error', 'Ошибка загрузки библиотеки Supabase: ' + error.message, true);
            }
        }

        // Создание таблиц базы данных
        async function createDatabaseTables() {
            try {
                // Таблица пользователей
                const { error: usersError } = await supabase.from('users').insert([
                    {
                        email: 'admin@zvezdochka.ru',
                        password: 'admin123', // В реальном приложении пароль должен храниться в хэшированном виде
                        name: 'Администратор',
                        plot_number: '0',
                        is_admin: true,
                        created_at: new Date().toISOString()
                    }
                ]);

                if (usersError && !usersError.message.includes('duplicate')) {
                    console.error('Ошибка создания пользователя:', usersError);
                }

                // Создаем другие таблицы через SQL (в реальном приложении это делается через миграции)
                // Здесь мы просто создаем демо-данные
                await createInitialData();
                
            } catch (error) {
                console.error('Ошибка создания таблиц:', error);
            }
        }

        // Создание начальных данных
        async function createInitialData() {
            const tariffs = [
                { type: 'losses', value: 0.36, created_at: new Date().toISOString() },
                { type: 'under_100', value: 6.10, created_at: new Date().toISOString() },
                { type: 'over_100', value: 7.30, created_at: new Date().toISOString() }
            ];

            for (const tariff of tariffs) {
                await supabase.from('tariffs').insert(tariff);
            }
        }

        // Проверка авторизации
        async function checkAuth() {
            const userData = localStorage.getItem('snt_user');
            if (userData) {
                currentUser = JSON.parse(userData);
                
                if (currentUser.is_admin) {
                    showAdminPanel();
                    loadUsers();
                    loadTariffs();
                    loadAllCounters();
                    loadDuesHistory();
                } else {
                    showUserPanel();
                    loadUserData();
                    loadUserCounters();
                    loadPaymentHistory();
                }
            }
        }

        // Показать сообщение
        function showAlert(containerId, type, message, autoHide = true) {
            const alert = document.getElementById(containerId);
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            if (autoHide) {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }

        // Переключение вкладок авторизации
        function switchAuthTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        // Переключение вкладок пользователя
        function switchUserTab(tab) {
            document.querySelectorAll('#userContainer .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#userContainer .tab-content').forEach(t => t.classList.remove('active'));
            
            const tabMap = {
                'current': { tabIndex: 0, contentId: 'currentTab' },
                'counters': { tabIndex: 1, contentId: 'countersTab' },
                'history': { tabIndex: 2, contentId: 'historyTab' }
            };
            
            const config = tabMap[tab];
            document.querySelectorAll('#userContainer .tab')[config.tabIndex].classList.add('active');
            document.getElementById(config.contentId).classList.add('active');
        }

        // Переключение вкладок администратора
        function switchAdminTab(tab) {
            document.querySelectorAll('#adminContainer .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminContainer .tab-content').forEach(t => t.classList.remove('active'));
            
            const tabMap = {
                'users': { tabIndex: 0, contentId: 'usersTab' },
                'tariffs': { tabIndex: 1, contentId: 'tariffsTab' },
                'counters': { tabIndex: 2, contentId: 'countersTab' },
                'dues': { tabIndex: 3, contentId: 'duesTab' },
                'export': { tabIndex: 4, contentId: 'exportTab' }
            };
            
            const config = tabMap[tab];
            document.querySelectorAll('#adminContainer .tab')[config.tabIndex].classList.add('active');
            document.getElementById(config.contentId).classList.add('active');
        }

        // Вход в систему
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('authAlert', 'error', 'Заполните все поля');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (error) {
                    showAlert('authAlert', 'error', 'Пользователь не найден');
                    return;
                }
                
                // В реальном приложении нужно использовать хэширование паролей!
                if (data.password !== password) {
                    showAlert('authAlert', 'error', 'Неверный пароль');
                    return;
                }
                
                currentUser = data;
                localStorage.setItem('snt_user', JSON.stringify(data));
                
                if (data.is_admin) {
                    showAdminPanel();
                    loadUsers();
                } else {
                    showUserPanel();
                    loadUserData();
                }
                
                showAlert('authAlert', 'success', 'Вход выполнен успешно!', true);
                
            } catch (error) {
                showAlert('authAlert', 'error', 'Ошибка входа: ' + error.message);
            }
        }

        // Регистрация
        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const plotNumber = document.getElementById('plotNumber').value;
            
            if (!name || !email || !password || !confirmPassword || !plotNumber) {
                showAlert('authAlert', 'error', 'Заполните все поля');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('authAlert', 'error', 'Пароли не совпадают');
                return;
            }
            
            try {
                // Проверяем, есть ли уже пользователь с таким email
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('email')
                    .eq('email', email)
                    .single();
                
                if (existingUser) {
                    showAlert('authAlert', 'error', 'Пользователь с таким email уже существует');
                    return;
                }
                
                // Создаем нового пользователя
                const { data, error } = await supabase
                    .from('users')
                    .insert([
                        {
                            email: email,
                            password: password, // В реальном приложении нужно хэшировать!
                            name: name,
                            plot_number: plotNumber,
                            is_admin: false,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();
                
                if (error) {
                    showAlert('authAlert', 'error', 'Ошибка регистрации: ' + error.message);
                    return;
                }
                
                showAlert('authAlert', 'success', 'Регистрация успешна! Теперь войдите в систему.', true);
                switchAuthTab('login');
                document.getElementById('loginEmail').value = email;
                document.getElementById('loginPassword').value = '';
                
            } catch (error) {
                showAlert('authAlert', 'error', 'Ошибка регистрации: ' + error.message);
            }
        }

        // Выход из системы
        function logout() {
            currentUser = null;
            localStorage.removeItem('snt_user');
            showAuthPanel();
        }

        // Показать панель авторизации
        function showAuthPanel() {
            document.getElementById('authContainer').classList.add('active');
            document.getElementById('userContainer').classList.remove('active');
            document.getElementById('adminContainer').classList.remove('active');
        }

        // Показать панель пользователя
        function showUserPanel() {
            document.getElementById('authContainer').classList.remove('active');
            document.getElementById('userContainer').classList.add('active');
            document.getElementById('adminContainer').classList.remove('active');
            
            // Устанавливаем текущий месяц
            updateMonthDisplay();
            loadCurrentMonthData();
        }

        // Показать панель администратора
        function showAdminPanel() {
            document.getElementById('authContainer').classList.remove('active');
            document.getElementById('userContainer').classList.remove('active');
            document.getElementById('adminContainer').classList.add('active');
        }

        // Загрузка данных пользователя
        async function loadUserData() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userPlot').textContent = currentUser.plot_number;
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        // Обновление отображения месяца
        function updateMonthDisplay() {
            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            
            const displayYear = currentMonth < 0 ? currentYear - 1 : 
                              currentMonth > 11 ? currentYear + 1 : currentYear;
            const displayMonth = ((currentMonth % 12) + 12) % 12;
            
            document.getElementById('currentMonth').textContent = 
                `${monthNames[displayMonth]} ${displayYear}`;
        }

        // Предыдущий месяц
        function prevMonth() {
            currentMonth--;
            updateMonthDisplay();
            loadCurrentMonthData();
        }

        // Следующий месяц
        function nextMonth() {
            currentMonth++;
            updateMonthDisplay();
            loadCurrentMonthData();
        }

        // Загрузка данных за текущий месяц
        async function loadCurrentMonthData() {
            const displayYear = currentMonth < 0 ? currentYear - 1 : 
                              currentMonth > 11 ? currentYear + 1 : currentYear;
            const displayMonth = ((currentMonth % 12) + 12) % 12;
            
            // Загружаем тарифы
            const { data: tariffs } = await supabase
                .from('tariffs')
                .select('*');
            
            // Загружаем показания за предыдущий месяц
            const prevMonth = displayMonth === 0 ? 11 : displayMonth - 1;
            const prevYear = displayMonth === 0 ? displayYear - 1 : displayYear;
            
            const { data: prevCounter } = await supabase
                .from('counters')
                .select('value')
                .eq('user_id', currentUser.id)
                .eq('month', prevMonth + 1)
                .eq('year', prevYear)
                .single();
            
            // Загружаем показания за текущий месяц
            const { data: currentCounter } = await supabase
                .from('counters')
                .select('value')
                .eq('user_id', currentUser.id)
                .eq('month', displayMonth + 1)
                .eq('year', displayYear)
                .single();
            
            // Загружаем взносы за текущий месяц
            const { data: dues } = await supabase
                .from('dues')
                .select('*')
                .eq('month', displayMonth + 1)
                .eq('year', displayYear)
                .single();
            
            // Рассчитываем потребление
            let consumption = 0;
            if (prevCounter && currentCounter) {
                consumption = currentCounter.value - prevCounter.value;
            }
            
            // Рассчитываем стоимость электроэнергии
            const lossesTariff = tariffs?.find(t => t.type === 'losses')?.value || 0.36;
            const under100Tariff = tariffs?.find(t => t.type === 'under_100')?.value || 6.10;
            const over100Tariff = tariffs?.find(t => t.type === 'over_100')?.value || 7.30;
            
            let electricityCost = 0;
            let calculationDetails = '';
            
            if (consumption > 0) {
                const losses = consumption * lossesTariff;
                let under100 = 0;
                let over100 = 0;
                
                if (consumption <= 100) {
                    under100 = consumption * under100Tariff;
                } else {
                    under100 = 100 * under100Tariff;
                    over100 = (consumption - 100) * over100Tariff;
                }
                
                electricityCost = losses + under100 + over100;
                
                calculationDetails = `
                    <p>Потребление: ${consumption.toFixed(2)} кВт·ч</p>
                    <p>Потери (${lossesTariff} ₽/кВт·ч): ${losses.toFixed(2)} ₽</p>
                    <p>До 100 кВт·ч (${under100Tariff} ₽/кВт·ч): ${under100.toFixed(2)} ₽</p>
                    ${over100 > 0 ? `<p>Свыше 100 кВт·ч (${over100Tariff} ₽/кВт·ч): ${over100.toFixed(2)} ₽</p>` : ''}
                    <p><strong>Итого за электроэнергию: ${electricityCost.toFixed(2)} ₽</strong></p>
                `;
            } else {
                calculationDetails = '<p>Показания за текущий месяц отсутствуют</p>';
            }
            
            document.getElementById('electricityInfo').innerHTML = calculationDetails;
            
            // Отображаем взносы
            let duesInfo = '';
            let totalDues = 0;
            
            if (dues) {
                totalDues = dues.salary + dues.maintenance + dues.other;
                duesInfo = `
                    <p>Зарплата: ${dues.salary.toFixed(2)} ₽</p>
                    <p>Содержание: ${dues.maintenance.toFixed(2)} ₽</p>
                    <p>Прочее: ${dues.other.toFixed(2)} ₽</p>
                    <p><strong>Итого взносов: ${totalDues.toFixed(2)} ₽</strong></p>
                `;
            } else {
                duesInfo = '<p>Взносы за этот месяц еще не установлены</p>';
            }
            
            document.getElementById('duesInfo').innerHTML = duesInfo;
            
            // Отображаем общую сумму
            const totalAmount = electricityCost + totalDues;
            document.getElementById('totalAmount').textContent = `Общая сумма к оплате: ${totalAmount.toFixed(2)} ₽`;
        }

        // Отправка показаний счетчика
        async function submitCounter() {
            const value = parseFloat(document.getElementById('counterValue').value);
            const date = document.getElementById('counterDate').value;
            
            if (!value || value <= 0) {
                showAlert('userAlert', 'error', 'Введите корректные показания');
                return;
            }
            
            if (!date) {
                showAlert('userAlert', 'error', 'Выберите дату');
                return;
            }
            
            const dateObj = new Date(date);
            const month = dateObj.getMonth() + 1;
            const year = dateObj.getFullYear();
            
            try {
                // Проверяем, есть ли уже показания за этот месяц
                const { data: existing } = await supabase
                    .from('counters')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('month', month)
                    .eq('year', year)
                    .single();
                
                let result;
                if (existing) {
                    // Обновляем существующие
                    result = await supabase
                        .from('counters')
                        .update({ value: value, date: date })
                        .eq('id', existing.id);
                } else {
                    // Создаем новые
                    result = await supabase
                        .from('counters')
                        .insert([
                            {
                                user_id: currentUser.id,
                                value: value,
                                date: date,
                                month: month,
                                year: year,
                                created_at: new Date().toISOString()
                            }
                        ]);
                }
                
                if (result.error) {
                    showAlert('userAlert', 'error', 'Ошибка сохранения показаний: ' + result.error.message);
                    return;
                }
                
                showAlert('userAlert', 'success', 'Показания успешно сохранены!', true);
                document.getElementById('counterValue').value = '';
                document.getElementById('counterDate').value = '';
                
                loadUserCounters();
                loadCurrentMonthData();
                
            } catch (error) {
                showAlert('userAlert', 'error', 'Ошибка: ' + error.message);
            }
        }

        // Загрузка истории показаний пользователя
        async function loadUserCounters() {
            if (!currentUser) return;
            
            try {
                const { data: counters } = await supabase
                    .from('counters')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('year', { ascending: false })
                    .order('month', { ascending: false });
                
                if (!counters || counters.length === 0) {
                    document.getElementById('counterHistory').innerHTML = '<p>Показания не найдены</p>';
                    return;
                }
                
                let html = '<table>';
                html += '<tr><th>Месяц/Год</th><th>Показания</th><th>Дата снятия</th></tr>';
                
                counters.forEach(counter => {
                    const monthNames = [
                        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                    ];
                    
                    html += `
                        <tr>
                            <td>${monthNames[counter.month - 1]} ${counter.year}</td>
                            <td>${counter.value.toFixed(2)} кВт·ч</td>
                            <td>${new Date(counter.date).toLocaleDateString('ru-RU')}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('counterHistory').innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки показаний:', error);
                document.getElementById('counterHistory').innerHTML = '<p>Ошибка загрузки данных</p>';
            }
        }

        // Загрузка истории платежей
        async function loadPaymentHistory() {
            if (!currentUser) return;
            
            try {
                // В реальном приложении здесь должна быть загрузка реальных платежей
                // Сейчас покажем демо-данные
                const demoPayments = [
                    { month: 11, year: 2024, amount: 5899.90, paid: true },
                    { month: 10, year: 2024, amount: 5320.50, paid: true },
                    { month: 9, year: 2024, amount: 4780.25, paid: true }
                ];
                
                let html = '<table>';
                html += '<tr><th>Месяц/Год</th><th>Сумма</th><th>Статус</th></tr>';
                
                demoPayments.forEach(payment => {
                    const monthNames = [
                        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                    ];
                    
                    html += `
                        <tr>
                            <td>${monthNames[payment.month - 1]} ${payment.year}</td>
                            <td>${payment.amount.toFixed(2)} ₽</td>
                            <td>${payment.paid ? 'Оплачено' : 'Не оплачено'}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('paymentHistory').innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки платежей:', error);
                document.getElementById('paymentHistory').innerHTML = '<p>Ошибка загрузки данных</p>';
            }
        }

        // Загрузка пользователей (для админа)
        async function loadUsers() {
            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('plot_number');
                
                allUsers = users || [];
                
                let html = '<table>';
                html += '<tr><th>ID</th><th>ФИО</th><th>Участок</th><th>Email</th><th>Админ</th><th>Действия</th></tr>';
                
                users.forEach(user => {
                    html += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.plot_number}</td>
                            <td>${user.email}</td>
                            <td>${user.is_admin ? 'Да' : 'Нет'}</td>
                            <td>
                                <button onclick="editUser(${user.id})" style="padding: 5px 10px; margin: 2px;">Редактировать</button>
                                ${!user.is_admin ? `<button onclick="deleteUser(${user.id})" style="padding: 5px 10px; margin: 2px;" class="danger">Удалить</button>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('usersList').innerHTML = html;
                
                // Обновляем список пользователей в селекторе
                const userSelect = document.getElementById('adminUserSelect');
                userSelect.innerHTML = '<option value="">Выберите пользователя</option>';
                
                users.filter(u => !u.is_admin).forEach(user => {
                    userSelect.innerHTML += `<option value="${user.id}">${user.name} (уч. ${user.plot_number})</option>`;
                });
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                document.getElementById('usersList').innerHTML = '<p>Ошибка загрузки пользователей</p>';
            }
        }

        // Загрузка тарифов (для админа)
        async function loadTariffs() {
            try {
                const { data: tariffs } = await supabase
                    .from('tariffs')
                    .select('*');
                
                tariffs.forEach(tariff => {
                    switch(tariff.type) {
                        case 'losses':
                            document.getElementById('lossesTariff').value = tariff.value;
                            break;
                        case 'under_100':
                            document.getElementById('under100Tariff').value = tariff.value;
                            break;
                        case 'over_100':
                            document.getElementById('over100Tariff').value = tariff.value;
                            break;
                    }
                });
                
            } catch (error) {
                console.error('Ошибка загрузки тарифов:', error);
            }
        }

        // Сохранение тарифов (для админа)
        async function saveTariffs() {
            const losses = parseFloat(document.getElementById('lossesTariff').value);
            const under100 = parseFloat(document.getElementById('under100Tariff').value);
            const over100 = parseFloat(document.getElementById('over100Tariff').value);
            
            if (!losses || !under100 || !over100) {
                showAlert('adminAlert', 'error', 'Заполните все тарифы');
                return;
            }
            
            try {
                // Обновляем каждый тариф
                const tariffs = [
                    { type: 'losses', value: losses },
                    { type: 'under_100', value: under100 },
                    { type: 'over_100', value: over100 }
                ];
                
                for (const tariff of tariffs) {
                    await supabase
                        .from('tariffs')
                        .update({ value: tariff.value })
                        .eq('type', tariff.type);
                }
                
                showAlert('adminAlert', 'success', 'Тарифы успешно сохранены!', true);
                
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка сохранения тарифов: ' + error.message);
            }
        }

        // Загрузка всех показаний (для админа)
        async function loadAllCounters() {
            try {
                const { data: counters } = await supabase
                    .from('counters')
                    .select(`
                        *,
                        users!inner (name, plot_number)
                    `)
                    .order('year', { ascending: false })
                    .order('month', { ascending: false });
                
                if (!counters || counters.length === 0) {
                    document.getElementById('allCounters').innerHTML = '<p>Показания не найдены</p>';
                    return;
                }
                
                let html = '<table>';
                html += '<tr><th>Пользователь</th><th>Участок</th><th>Месяц/Год</th><th>Показания</th><th>Дата</th><th>Действия</th></tr>';
                
                counters.forEach(counter => {
                    const monthNames = [
                        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                    ];
                    
                    html += `
                        <tr>
                            <td>${counter.users.name}</td>
                            <td>${counter.users.plot_number}</td>
                            <td>${monthNames[counter.month - 1]} ${counter.year}</td>
                            <td>${counter.value.toFixed(2)} кВт·ч</td>
                            <td>${new Date(counter.date).toLocaleDateString('ru-RU')}</td>
                            <td>
                                <button onclick="editCounter(${counter.id})" style="padding: 5px 10px; margin: 2px;">Изменить</button>
                                <button onclick="deleteCounter(${counter.id})" style="padding: 5px 10px; margin: 2px;" class="danger">Удалить</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('allCounters').innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки показаний:', error);
                document.getElementById('allCounters').innerHTML = '<p>Ошибка загрузки данных</p>';
            }
        }

        // Добавление показаний администратором
        async function adminSubmitCounter() {
            const userId = document.getElementById('adminUserSelect').value;
            const value = parseFloat(document.getElementById('adminCounterValue').value);
            const monthYear = document.getElementById('adminCounterMonth').value;
            
            if (!userId || !value || !monthYear) {
                showAlert('adminAlert', 'error', 'Заполните все поля');
                return;
            }
            
            const [year, month] = monthYear.split('-');
            
            try {
                // Проверяем, есть ли уже показания
                const { data: existing } = await supabase
                    .from('counters')
                    .select('id')
                    .eq('user_id', userId)
                    .eq('month', parseInt(month))
                    .eq('year', parseInt(year))
                    .single();
                
                let result;
                if (existing) {
                    result = await supabase
                        .from('counters')
                        .update({ 
                            value: value,
                            date: new Date().toISOString().split('T')[0]
                        })
                        .eq('id', existing.id);
                } else {
                    result = await supabase
                        .from('counters')
                        .insert([
                            {
                                user_id: userId,
                                value: value,
                                date: new Date().toISOString().split('T')[0],
                                month: parseInt(month),
                                year: parseInt(year),
                                created_at: new Date().toISOString()
                            }
                        ]);
                }
                
                if (result.error) {
                    showAlert('adminAlert', 'error', 'Ошибка сохранения: ' + result.error.message);
                    return;
                }
                
                showAlert('adminAlert', 'success', 'Показания успешно сохранены!', true);
                document.getElementById('adminCounterValue').value = '';
                document.getElementById('adminCounterMonth').value = '';
                
                loadAllCounters();
                
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка: ' + error.message);
            }
        }

        // Установка взносов для всех
        async function setDuesForAll() {
            const monthYear = document.getElementById('duesMonth').value;
            const salary = parseFloat(document.getElementById('salaryDue').value);
            const maintenance = parseFloat(document.getElementById('maintenanceDue').value);
            const other = parseFloat(document.getElementById('otherDue').value);
            
            if (!monthYear || !salary || !maintenance || !other) {
                showAlert('adminAlert', 'error', 'Заполните все поля');
                return;
            }
            
            const [year, month] = monthYear.split('-');
            
            try {
                // Проверяем, есть ли уже взносы за этот месяц
                const { data: existing } = await supabase
                    .from('dues')
                    .select('id')
                    .eq('month', parseInt(month))
                    .eq('year', parseInt(year))
                    .single();
                
                let result;
                if (existing) {
                    result = await supabase
                        .from('dues')
                        .update({
                            salary: salary,
                            maintenance: maintenance,
                            other: other
                        })
                        .eq('id', existing.id);
                } else {
                    result = await supabase
                        .from('dues')
                        .insert([
                            {
                                month: parseInt(month),
                                year: parseInt(year),
                                salary: salary,
                                maintenance: maintenance,
                                other: other,
                                created_at: new Date().toISOString()
                            }
                        ]);
                }
                
                if (result.error) {
                    showAlert('adminAlert', 'error', 'Ошибка сохранения: ' + result.error.message);
                    return;
                }
                
                showAlert('adminAlert', 'success', 'Взносы успешно установлены!', true);
                loadDuesHistory();
                
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка: ' + error.message);
            }
        }

        // Загрузка истории взносов
        async function loadDuesHistory() {
            try {
                const { data: dues } = await supabase
                    .from('dues')
                    .select('*')
                    .order('year', { ascending: false })
                    .order('month', { ascending: false });
                
                if (!dues || dues.length === 0) {
                    document.getElementById('duesHistory').innerHTML = '<p>Взносы не найдены</p>';
                    return;
                }
                
                let html = '<table>';
                html += '<tr><th>Месяц/Год</th><th>Зарплата</th><th>Содержание</th><th>Прочее</th><th>Итого</th><th>Действия</th></tr>';
                
                dues.forEach(due => {
                    const monthNames = [
                        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                    ];
                    
                    const total = due.salary + due.maintenance + due.other;
                    
                    html += `
                        <tr>
                            <td>${monthNames[due.month - 1]} ${due.year}</td>
                            <td>${due.salary.toFixed(2)} ₽</td>
                            <td>${due.maintenance.toFixed(2)} ₽</td>
                            <td>${due.other.toFixed(2)} ₽</td>
                            <td>${total.toFixed(2)} ₽</td>
                            <td>
                                <button onclick="editDue(${due.id})" style="padding: 5px 10px; margin: 2px;">Изменить</button>
                                <button onclick="deleteDue(${due.id})" style="padding: 5px 10px; margin: 2px;" class="danger">Удалить</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('duesHistory').innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки взносов:', error);
                document.getElementById('duesHistory').innerHTML = '<p>Ошибка загрузки данных</p>';
            }
        }

        // Экспорт данных
        async function exportData(type) {
            try {
                let data = [];
                let filename = '';
                
                switch(type) {
                    case 'users':
                        const { data: users } = await supabase.from('users').select('*');
                        data = users;
                        filename = 'users.csv';
                        break;
                    case 'counters':
                        const { data: counters } = await supabase
                            .from('counters')
                            .select(`
                                *,
                                users!inner (name, plot_number)
                            `);
                        data = counters;
                        filename = 'counters.csv';
                        break;
                    case 'dues':
                        const { data: dues } = await supabase.from('dues').select('*');
                        data = dues;
                        filename = 'dues.csv';
                        break;
                    case 'payments':
                        // Демо-данные для платежей
                        data = [
                            { id: 1, user_id: 2, month: 11, year: 2024, amount: 5899.90, paid: true },
                            { id: 2, user_id: 3, month: 11, year: 2024, amount: 6200.50, paid: false }
                        ];
                        filename = 'payments.csv';
                        break;
                }
                
                // Конвертируем в CSV
                const csv = convertToCSV(data);
                
                // Создаем ссылку для скачивания
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                
                showAlert('adminAlert', 'success', `Данные экспортированы в ${filename}`, true);
                
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка экспорта: ' + error.message);
            }
        }

        // Конвертация в CSV
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const rows = data.map(row => 
                headers.map(header => 
                    JSON.stringify(row[header], (key, value) => 
                        value === null ? '' : value
                    )
                ).join(',')
            );
            
            return [headers.join(','), ...rows].join('\n');
        }

        // Импорт данных
        async function importData() {
            const fileInput = document.getElementById('importFile');
            const importType = document.getElementById('importType').value;
            
            if (!fileInput.files[0]) {
                showAlert('adminAlert', 'error', 'Выберите файл для импорта');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const rows = csv.split('\n').filter(row => row.trim());
                    const headers = rows[0].split(',').map(h => h.trim());
                    
                    let imported = 0;
                    let errors = [];
                    
                    for (let i = 1; i < rows.length; i++) {
                        const values = rows[i].split(',');
                        const rowData = {};
                        
                        headers.forEach((header, index) => {
                            rowData[header] = values[index] ? values[index].replace(/"/g, '') : '';
                        });
                        
                        try {
                            if (importType === 'counters') {
                                // Импорт показаний
                                await supabase
                                    .from('counters')
                                    .upsert({
                                        user_id: parseInt(rowData.user_id),
                                        month: parseInt(rowData.month),
                                        year: parseInt(rowData.year),
                                        value: parseFloat(rowData.value),
                                        date: new Date().toISOString().split('T')[0]
                                    });
                            } else if (importType === 'dues') {
                                // Импорт взносов
                                await supabase
                                    .from('dues')
                                    .upsert({
                                        month: parseInt(rowData.month),
                                        year: parseInt(rowData.year),
                                        salary: parseFloat(rowData.salary),
                                        maintenance: parseFloat(rowData.maintenance),
                                        other: parseFloat(rowData.other)
                                    });
                            }
                            imported++;
                        } catch (error) {
                            errors.push(`Строка ${i}: ${error.message}`);
                        }
                    }
                    
                    if (errors.length === 0) {
                        showAlert('adminAlert', 'success', `Успешно импортировано ${imported} записей`, true);
                        if (importType === 'counters') loadAllCounters();
                        if (importType === 'dues') loadDuesHistory();
                    } else {
                        showAlert('adminAlert', 'error', `Импортировано ${imported} записей. Ошибки: ${errors.join('; ')}`, false);
                    }
                    
                } catch (error) {
                    showAlert('adminAlert', 'error', 'Ошибка обработки файла: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Вспомогательные функции для администратора
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                const newName = prompt('Введите новое ФИО:', user.name);
                const newPlot = prompt('Введите новый номер участка:', user.plot_number);
                const newEmail = prompt('Введите новый email:', user.email);
                
                if (newName && newPlot && newEmail) {
                    updateUser(userId, newName, newPlot, newEmail);
                }
            }
        }

        async function updateUser(userId, name, plotNumber, email) {
            try {
                await supabase
                    .from('users')
                    .update({ name, plot_number: plotNumber, email })
                    .eq('id', userId);
                
                showAlert('adminAlert', 'success', 'Пользователь обновлен', true);
                loadUsers();
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка обновления: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Удалить этого пользователя? Все его данные будут удалены.')) return;
            
            try {
                await supabase.from('users').delete().eq('id', userId);
                showAlert('adminAlert', 'success', 'Пользователь удален', true);
                loadUsers();
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка удаления: ' + error.message);
            }
        }

        function editCounter(counterId) {
            // Реализация редактирования показаний
            alert('Редактирование показаний (реализуйте по необходимости)');
        }

        async function deleteCounter(counterId) {
            if (!confirm('Удалить эти показания?')) return;
            
            try {
                await supabase.from('counters').delete().eq('id', counterId);
                showAlert('adminAlert', 'success', 'Показания удалены', true);
                loadAllCounters();
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка удаления: ' + error.message);
            }
        }

        function editDue(dueId) {
            // Реализация редактирования взносов
            alert('Редактирование взносов (реализуйте по необходимости)');
        }

        async function deleteDue(dueId) {
            if (!confirm('Удалить эти взносы?')) return;
            
            try {
                await supabase.from('dues').delete().eq('id', dueId);
                showAlert('adminAlert', 'success', 'Взносы удалены', true);
                loadDuesHistory();
            } catch (error) {
                showAlert('adminAlert', 'error', 'Ошибка удаления: ' + error.message);
            }
        }

        // Инициализация при загрузке страницы
        window.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            // Устанавливаем текущую дату по умолчанию
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('counterDate').value = today;
            
            // Устанавливаем текущий месяц для админки
            const currentMonthInput = new Date().toISOString().slice(0, 7);
            document.getElementById('adminCounterMonth').value = currentMonthInput;
            document.getElementById('duesMonth').value = currentMonthInput;
        });
    </script>
</body>
</html>
