<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СНТ "Звездочка" - Система сбора показаний</title>
    <style>
        :root {
            --primary-color: #1e88e5;
            --secondary-color: #1565c0;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --light-color: #f5f5f5;
            --dark-color: #333;
            --border-radius: 4px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .auth-section {
            display: flex;
            gap: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e68900;
        }
        
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        table tr:hover {
            background-color: #f9f9f9;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom-color: white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
        }
        
        .dashboard-card h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .meter-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .electricity-calculation {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #777;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .meter-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <h1>СНТ "Звездочка"</h1>
            </div>
            <div class="user-info">
                <span id="current-user">Гость</span>
                <div class="auth-section" id="auth-section">
                    <button id="login-btn" class="btn btn-primary">Вход</button>
                    <button id="logout-btn" class="btn btn-danger hidden">Выйти</button>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Проверка соединения с Supabase -->
        <div id="connection-test" class="card">
            <h2>Проверка соединения с сервером</h2>
            <div id="connection-status" class="alert alert-info">
                Проверяем соединение с сервером...
            </div>
            <button id="test-connection" class="btn btn-primary">Проверить соединение</button>
            <button id="test-query" class="btn btn-primary">Тестовый запрос к базе</button>
        </div>
        
        <!-- Страница входа -->
        <div id="login-page" class="page active">
            <div class="card">
                <h2>Вход в систему</h2>
                <div id="login-message"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Логин</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Войти</button>
                </form>
                <div style="margin-top: 15px;">
                    <p>Тестовые пользователи:</p>
                    <ul>
                        <li><strong>Админ:</strong> admin / admin123</li>
                        <li><strong>Пользователь:</strong> user1 / user123</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Личный кабинет пользователя -->
        <div id="user-dashboard" class="page">
            <h1>Личный кабинет</h1>
            
            <div class="tabs">
                <div class="tab active" data-target="user-overview">Обзор</div>
                <div class="tab" data-target="user-meters">Показания счетчиков</div>
                <div class="tab" data-target="user-history">История платежей</div>
            </div>
            
            <div id="user-overview" class="tab-content active">
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h3>Текущий баланс</h3>
                        <div class="stat-value" id="current-balance">0 руб.</div>
                        <p>Сумма к уплате за текущий месяц</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Мои участки</h3>
                        <div class="stat-value" id="user-plots">0</div>
                        <p id="user-acres">Соток: 0</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Счетчики</h3>
                        <div class="stat-value" id="user-meters-count">0</div>
                        <p>активных счетчиков</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Детализация текущих начислений</h2>
                    <div id="current-charges-details">
                        <p>Загружаем данные...</p>
                    </div>
                </div>
            </div>
            
            <div id="user-meters" class="tab-content">
                <div class="card">
                    <h2>Передача показаний счетчиков</h2>
                    <p>Текущий период: <span id="current-period"></span></p>
                    <div id="user-meters-list">
                        <!-- Счетчики будут загружены динамически -->
                    </div>
                    <button id="submit-readings" class="btn btn-success">Отправить показания</button>
                </div>
                
                <div class="card">
                    <h2>История показаний</h2>
                    <div id="meter-readings-history">
                        <p>Загружаем историю показаний...</p>
                    </div>
                </div>
            </div>
            
            <div id="user-history" class="tab-content">
                <div class="card">
                    <h2>История платежей и начислений</h2>
                    <div id="payment-history">
                        <p>Загружаем историю платежей...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Панель администратора -->
        <div id="admin-dashboard" class="page">
            <h1>Панель администратора</h1>
            
            <div class="tabs">
                <div class="tab active" data-target="admin-overview">Обзор</div>
                <div class="tab" data-target="admin-users">Управление пользователями</div>
                <div class="tab" data-target="admin-tariffs">Тарифы</div>
                <div class="tab" data-target="admin-readings">Показания счетчиков</div>
                <div class="tab" data-target="admin-import-export">Импорт/Экспорт</div>
            </div>
            
            <div id="admin-overview" class="tab-content active">
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h3>Всего пользователей</h3>
                        <div class="stat-value" id="total-users">0</div>
                        <p>зарегистрированных в системе</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Передали показания</h3>
                        <div class="stat-value" id="users-with-readings">0</div>
                        <p>за текущий месяц</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Общая сумма начислений</h3>
                        <div class="stat-value" id="total-charges">0 руб.</div>
                        <p>за текущий месяц</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Быстрые действия</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="create-user-btn" class="btn btn-primary">Добавить пользователя</button>
                        <button id="set-tariffs-btn" class="btn btn-primary">Установить тарифы</button>
                        <button id="enter-readings-btn" class="btn btn-primary">Ввести показания</button>
                        <button id="export-data-btn" class="btn btn-success">Экспорт данных</button>
                        <button id="import-data-btn" class="btn btn-warning">Импорт данных</button>
                    </div>
                </div>
            </div>
            
            <div id="admin-users" class="tab-content">
                <div class="card">
                    <h2>Управление пользователями</h2>
                    <button id="add-user-btn" class="btn btn-success" style="margin-bottom: 20px;">Добавить пользователя</button>
                    <div id="users-list">
                        <p>Загружаем список пользователей...</p>
                    </div>
                </div>
            </div>
            
            <div id="admin-tariffs" class="tab-content">
                <div class="card">
                    <h2>Управление тарифами</h2>
                    
                    <div class="tabs" style="margin-bottom: 20px;">
                        <div class="tab active" data-target="electricity-tariffs">Электроэнергия</div>
                        <div class="tab" data-target="membership-tariffs">Членские взносы</div>
                        <div class="tab" data-target="tariff-history">История тарифов</div>
                    </div>
                    
                    <div id="electricity-tariffs" class="tab-content active">
                        <h3>Тарифы на электроэнергию</h3>
                        <p>Текущий месяц: <span id="current-month"></span></p>
                        <form id="electricity-tariff-form">
                            <div class="form-group">
                                <label for="loss-rate">Тариф на потери (руб./кВт·ч)</label>
                                <input type="number" step="0.01" id="loss-rate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="rate-below-100">Тариф до 100 кВт·ч (руб./кВт·ч)</label>
                                <input type="number" step="0.01" id="rate-below-100" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="rate-above-100">Тариф от 100 кВт·ч (руб./кВт·ч)</label>
                                <input type="number" step="0.01" id="rate-above-100" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Сохранить тарифы</button>
                        </form>
                    </div>
                    
                    <div id="membership-tariffs" class="tab-content">
                        <h3>Членские взносы</h3>
                        <p>Текущий месяц: <span id="current-month-membership"></span></p>
                        <form id="membership-tariff-form">
                            <div class="form-group">
                                <label for="salary-rate">Зарплата (руб. за участок)</label>
                                <input type="number" step="0.01" id="salary-rate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="maintenance-rate">Содержание (руб. за сотку)</label>
                                <input type="number" step="0.01" id="maintenance-rate" class="form-control" required>
                            </div>
                            <h4>Дополнительные взносы</h4>
                            <div class="form-group">
                                <label for="extra1-label">Название поля 1</label>
                                <input type="text" id="extra1-label" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="extra1-rate">Ставка 1</label>
                                <input type="number" step="0.01" id="extra1-rate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="extra2-label">Название поля 2</label>
                                <input type="text" id="extra2-label" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="extra2-rate">Ставка 2</label>
                                <input type="number" step="0.01" id="extra2-rate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="extra3-label">Название поля 3</label>
                                <input type="text" id="extra3-label" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="extra3-rate">Ставка 3</label>
                                <input type="number" step="0.01" id="extra3-rate" class="form-control">
                            </div>
                            <button type="submit" class="btn btn-primary">Сохранить взносы</button>
                        </form>
                    </div>
                    
                    <div id="tariff-history" class="tab-content">
                        <h3>История тарифов</h3>
                        <div id="tariff-history-list">
                            <p>Загружаем историю тарифов...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="admin-readings" class="tab-content">
                <div class="card">
                    <h2>Показания счетчиков пользователей</h2>
                    <p>Текущий период: <span id="admin-current-period"></span></p>
                    <div id="all-users-readings">
                        <p>Загружаем показания...</p>
                    </div>
                </div>
            </div>
            
            <div id="admin-import-export" class="tab-content">
                <div class="card">
                    <h2>Импорт и экспорт данных</h2>
                    
                    <div class="tabs" style="margin-bottom: 20px;">
                        <div class="tab active" data-target="export-data">Экспорт данных</div>
                        <div class="tab" data-target="import-data">Импорт данных</div>
                    </div>
                    
                    <div id="export-data" class="tab-content active">
                        <h3>Экспорт данных</h3>
                        <p>Выберите данные для экспорта:</p>
                        <div style="margin-bottom: 15px;">
                            <input type="checkbox" id="export-users" checked> <label for="export-users">Пользователи</label><br>
                            <input type="checkbox" id="export-meters" checked> <label for="export-meters">Счетчики</label><br>
                            <input type="checkbox" id="export-readings" checked> <label for="export-readings">Показания</label><br>
                            <input type="checkbox" id="export-tariffs" checked> <label for="export-tariffs">Тарифы</label>
                        </div>
                        <button id="export-btn" class="btn btn-success">Экспортировать в CSV</button>
                    </div>
                    
                    <div id="import-data" class="tab-content">
                        <h3>Импорт данных</h3>
                        <p>Выберите файл для импорта (CSV формат):</p>
                        <div class="form-group">
                            <input type="file" id="import-file" class="form-control" accept=".csv">
                        </div>
                        <div class="form-group">
                            <label for="import-type">Тип данных:</label>
                            <select id="import-type" class="form-control">
                                <option value="users">Пользователи</option>
                                <option value="meters">Счетчики</option>
                                <option value="readings">Показания</option>
                                <option value="tariffs">Тарифы</option>
                            </select>
                        </div>
                        <button id="import-btn" class="btn btn-warning">Импортировать данные</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Модальные окна -->
        <div id="modal-backdrop" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000;"></div>
        
        <!-- Модальное окно для добавления пользователя -->
        <div id="add-user-modal" class="hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 30px; border-radius: var(--border-radius); z-index: 1001; width: 90%; max-width: 500px;">
            <h2>Добавить пользователя</h2>
            <form id="add-user-form">
                <div class="form-group">
                    <label for="new-user-login">Логин</label>
                    <input type="text" id="new-user-login" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="new-user-password">Пароль</label>
                    <input type="password" id="new-user-password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="new-user-name">ФИО</label>
                    <input type="text" id="new-user-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="new-user-plots">Количество участков</label>
                    <input type="number" id="new-user-plots" class="form-control" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label for="new-user-acres">Количество соток</label>
                    <input type="number" id="new-user-acres" class="form-control" value="6" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="new-user-role">Роль</label>
                    <select id="new-user-role" class="form-control">
                        <option value="user">Пользователь</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <button type="button" id="cancel-add-user" class="btn btn-danger">Отмена</button>
                </div>
            </form>
        </div>
        
        <!-- Модальное окно для ввода показаний -->
        <div id="enter-readings-modal" class="hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 30px; border-radius: var(--border-radius); z-index: 1001; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2>Ввод показаний счетчиков</h2>
            <p>Текущий период: <span id="modal-current-period"></span></p>
            <div id="enter-readings-form">
                <!-- Форма будет заполнена динамически -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="save-readings-btn" class="btn btn-primary">Сохранить показания</button>
                <button id="cancel-readings" class="btn btn-danger">Отмена</button>
            </div>
        </div>
        
        <div class="footer">
            <p>СНТ "Звездочка" © 2023 | Система сбора показаний</p>
            <p>Версия 1.0</p>
        </div>
    </div>

    <!-- Подключаем библиотеки -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://chgbdbuiqzdmwiniyxrk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZ2JkYnVpcXpkbXdpbml5eHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU';
        
        // Инициализация Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Состояние приложения
        const appState = {
            currentUser: null,
            currentPage: 'login',
            currentTariffs: null,
            users: [],
            meters: [],
            readings: [],
            userMeters: []
        };
        
        // DOM элементы
        const elements = {
            // Страницы
            loginPage: document.getElementById('login-page'),
            userDashboard: document.getElementById('user-dashboard'),
            adminDashboard: document.getElementById('admin-dashboard'),
            
            // Элементы входа
            loginForm: document.getElementById('login-form'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            loginMessage: document.getElementById('login-message'),
            currentUser: document.getElementById('current-user'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            
            // Проверка соединения
            connectionStatus: document.getElementById('connection-status'),
            testConnectionBtn: document.getElementById('test-connection'),
            testQueryBtn: document.getElementById('test-query'),
            
            // Пользовательская панель
            currentBalance: document.getElementById('current-balance'),
            userPlots: document.getElementById('user-plots'),
            userAcres: document.getElementById('user-acres'),
            userMetersCount: document.getElementById('user-meters-count'),
            currentChargesDetails: document.getElementById('current-charges-details'),
            userMetersList: document.getElementById('user-meters-list'),
            submitReadingsBtn: document.getElementById('submit-readings'),
            meterReadingsHistory: document.getElementById('meter-readings-history'),
            paymentHistory: document.getElementById('payment-history'),
            currentPeriod: document.getElementById('current-period'),
            
            // Админ панель
            totalUsers: document.getElementById('total-users'),
            usersWithReadings: document.getElementById('users-with-readings'),
            totalCharges: document.getElementById('total-charges'),
            usersList: document.getElementById('users-list'),
            addUserBtn: document.getElementById('add-user-btn'),
            createUserBtn: document.getElementById('create-user-btn'),
            setTariffsBtn: document.getElementById('set-tariffs-btn'),
            enterReadingsBtn: document.getElementById('enter-readings-btn'),
            exportDataBtn: document.getElementById('export-data-btn'),
            importDataBtn: document.getElementById('import-data-btn'),
            
            // Тарифы
            electricityTariffForm: document.getElementById('electricity-tariff-form'),
            lossRate: document.getElementById('loss-rate'),
            rateBelow100: document.getElementById('rate-below-100'),
            rateAbove100: document.getElementById('rate-above-100'),
            membershipTariffForm: document.getElementById('membership-tariff-form'),
            salaryRate: document.getElementById('salary-rate'),
            maintenanceRate: document.getElementById('maintenance-rate'),
            extra1Label: document.getElementById('extra1-label'),
            extra1Rate: document.getElementById('extra1-rate'),
            extra2Label: document.getElementById('extra2-label'),
            extra2Rate: document.getElementById('extra2-rate'),
            extra3Label: document.getElementById('extra3-label'),
            extra3Rate: document.getElementById('extra3-rate'),
            tariffHistoryList: document.getElementById('tariff-history-list'),
            currentMonth: document.getElementById('current-month'),
            currentMonthMembership: document.getElementById('current-month-membership'),
            
            // Показания админа
            adminCurrentPeriod: document.getElementById('admin-current-period'),
            allUsersReadings: document.getElementById('all-users-readings'),
            
            // Импорт/экспорт
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importFile: document.getElementById('import-file'),
            importType: document.getElementById('import-type'),
            
            // Модальные окна
            modalBackdrop: document.getElementById('modal-backdrop'),
            addUserModal: document.getElementById('add-user-modal'),
            addUserForm: document.getElementById('add-user-form'),
            cancelAddUser: document.getElementById('cancel-add-user'),
            enterReadingsModal: document.getElementById('enter-readings-modal'),
            modalCurrentPeriod: document.getElementById('modal-current-period'),
            enterReadingsForm: document.getElementById('enter-readings-form'),
            saveReadingsBtn: document.getElementById('save-readings-btn'),
            cancelReadings: document.getElementById('cancel-readings')
        };
        
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        async function initApp() {
            // Проверяем соединение с Supabase
            await testSupabaseConnection();
            
            // Создаем таблицы при необходимости
            await createTablesIfNotExist();
            
            // Назначаем обработчики событий
            setupEventListeners();
            
            // Проверяем, есть ли сохраненная сессия
            await checkAuth();
            
            // Инициализируем табы
            initTabs();
        }
        
        async function testSupabaseConnection() {
            try {
                elements.connectionStatus.textContent = 'Проверяем соединение с Supabase...';
                elements.connectionStatus.className = 'alert alert-info';
                
                // Простая проверка соединения
                const { error } = await supabase.from('_test').select('*').limit(1);
                
                // Ожидаем ошибку, так как таблицы _test не существует, но это подтверждает, что Supabase отвечает
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                elements.connectionStatus.textContent = '✓ Соединение с Supabase успешно установлено';
                elements.connectionStatus.className = 'alert alert-success';
            } catch (error) {
                console.error('Ошибка подключения к Supabase:', error);
                elements.connectionStatus.textContent = '✗ Ошибка подключения к Supabase. Проверьте интернет соединение.';
                elements.connectionStatus.className = 'alert alert-danger';
            }
        }
        
        async function createTablesIfNotExist() {
            try {
                // Проверяем существование таблиц и создаем их, если нужно
                // В реальном приложении таблицы создаются через миграции в Supabase,
                // но для простоты мы проверим и создадим базовые таблицы
                
                // Создаем таблицу пользователей
                const { data: usersTable, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (usersError && usersError.code === 'PGRST116') {
                    // Таблицы не существует, создаем
                    console.log('Таблица users не существует. В реальном приложении создайте таблицы через SQL редактор в Supabase.');
                }
                
                // Для демонстрации создадим тестовые данные
                await createTestData();
                
            } catch (error) {
                console.error('Ошибка при проверке таблиц:', error);
            }
        }
        
        async function createTestData() {
            try {
                // Проверяем, есть ли уже тестовые данные
                const { data: existingUsers, error } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Ошибка при проверке тестовых данных:', error);
                    return;
                }
                
                // Если нет пользователей, создаем тестовых
                if (!existingUsers || existingUsers.length === 0) {
                    console.log('Создание тестовых данных...');
                    
                    // Создаем тестовых пользователей
                    const testUsers = [
                        {
                            login: 'admin',
                            password: 'admin123',
                            name: 'Администратор СНТ',
                            role: 'admin',
                            plots: 1,
                            acres: 6
                        },
                        {
                            login: 'user1',
                            password: 'user123',
                            name: 'Иванов Иван Иванович',
                            role: 'user',
                            plots: 1,
                            acres: 6
                        },
                        {
                            login: 'user2',
                            password: 'user123',
                            name: 'Петров Петр Петрович',
                            role: 'user',
                            plots: 2,
                            acres: 12
                        }
                    ];
                    
                    // В реальном приложении пароли должны хэшироваться!
                    for (const user of testUsers) {
                        const { error } = await supabase
                            .from('users')
                            .insert([{
                                login: user.login,
                                password: user.password, // В реальном приложении используйте хэширование!
                                name: user.name,
                                role: user.role,
                                plots: user.plots,
                                acres: user.acres
                            }]);
                        
                        if (error) {
                            console.error('Ошибка при создании пользователя:', error);
                        }
                    }
                    
                    console.log('Тестовые пользователи созданы');
                }
                
                // Проверяем и создаем тестовые тарифы
                const currentDate = new Date();
                const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
                
                const { data: existingTariffs } = await supabase
                    .from('electricity_tariffs')
                    .select('*')
                    .eq('period', currentMonth)
                    .limit(1);
                
                if (!existingTariffs || existingTariffs.length === 0) {
                    // Создаем тестовые тарифы на электроэнергию
                    await supabase
                        .from('electricity_tariffs')
                        .insert([{
                            period: currentMonth,
                            loss_rate: 0.36,
                            rate_below_100: 6.1,
                            rate_above_100: 7.3
                        }]);
                    
                    // Создаем тестовые тарифы на членские взносы
                    await supabase
                        .from('membership_tariffs')
                        .insert([{
                            period: currentMonth,
                            salary: 939.00,
                            maintenance: 44.00,
                            extra1_label: 'Ремонт дорог',
                            extra1_rate: 50.00,
                            extra2_label: 'Вывоз мусора',
                            extra2_rate: 100.00,
                            extra3_label: 'Охрана',
                            extra3_rate: 200.00
                        }]);
                    
                    console.log('Тестовые тарифы созданы');
                }
                
                // Создаем тестовые счетчики
                const { data: existingMeters } = await supabase
                    .from('meters')
                    .select('*')
                    .limit(1);
                
                if (!existingMeters || existingMeters.length === 0) {
                    // Получаем ID пользователей
                    const { data: users } = await supabase
                        .from('users')
                        .select('id, login');
                    
                    if (users) {
                        for (const user of users) {
                            // Создаем счетчики для каждого пользователя
                            const meterCount = user.login === 'admin' ? 1 : 2;
                            
                            for (let i = 1; i <= meterCount; i++) {
                                await supabase
                                    .from('meters')
                                    .insert([{
                                        user_id: user.id,
                                        name: `Счетчик ${i}`,
                                        is_active: true
                                    }]);
                            }
                        }
                        
                        console.log('Тестовые счетчики созданы');
                    }
                }
                
            } catch (error) {
                console.error('Ошибка при создании тестовых данных:', error);
            }
        }
        
        function setupEventListeners() {
            // Кнопки аутентификации
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.logoutBtn.addEventListener('click', handleLogout);
            elements.loginBtn.addEventListener('click', showLoginPage);
            
            // Тестирование соединения
            elements.testConnectionBtn.addEventListener('click', testSupabaseConnection);
            elements.testQueryBtn.addEventListener('click', testDatabaseQuery);
            
            // Табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', handleTabClick);
            });
            
            // Пользовательские действия
            elements.submitReadingsBtn.addEventListener('click', submitMeterReadings);
            
            // Админские действия
            elements.addUserBtn.addEventListener('click', showAddUserModal);
            elements.createUserBtn.addEventListener('click', showAddUserModal);
            elements.setTariffsBtn.addEventListener('click', () => {
                showAdminTab('admin-tariffs');
            });
            elements.enterReadingsBtn.addEventListener('click', showEnterReadingsModal);
            elements.exportDataBtn.addEventListener('click', exportData);
            elements.importDataBtn.addEventListener('click', importData);
            
            // Формы админа
            elements.electricityTariffForm.addEventListener('submit', saveElectricityTariffs);
            elements.membershipTariffForm.addEventListener('submit', saveMembershipTariffs);
            
            // Модальные окна
            elements.cancelAddUser.addEventListener('click', hideAddUserModal);
            elements.modalBackdrop.addEventListener('click', hideAllModals);
            elements.addUserForm.addEventListener('submit', addNewUser);
            elements.cancelReadings.addEventListener('click', hideEnterReadingsModal);
            elements.saveReadingsBtn.addEventListener('click', saveAllReadings);
            
            // Импорт/экспорт
            elements.exportBtn.addEventListener('click', exportData);
            elements.importBtn.addEventListener('click', importData);
        }
        
        function initTabs() {
            // Инициализация системы вкладок
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabContainer = this.closest('.tabs');
                    const targetId = this.getAttribute('data-target');
                    
                    // Убираем активный класс у всех вкладок в контейнере
                    tabContainer.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Добавляем активный класс текущей вкладке
                    this.classList.add('active');
                    
                    // Скрываем все содержимое вкладок в контейнере
                    const tabContents = tabContainer.parentElement.querySelectorAll('.tab-content');
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Показываем целевое содержимое
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }
        
        function handleTabClick(e) {
            const tab = e.target;
            const targetId = tab.getAttribute('data-target');
            
            // Убираем активный класс у всех вкладок в контейнере
            const tabContainer = tab.closest('.tabs');
            tabContainer.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Добавляем активный класс текущей вкладке
            tab.classList.add('active');
            
            // Скрываем все содержимое вкладок в контейнере
            const tabContents = tabContainer.parentElement.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Показываем целевое содержимое
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }
        
        async function testDatabaseQuery() {
            try {
                elements.connectionStatus.textContent = 'Выполняем тестовый запрос к базе...';
                elements.connectionStatus.className = 'alert alert-info';
                
                // Пробуем получить количество пользователей
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                elements.connectionStatus.textContent = `✓ Тестовый запрос выполнен успешно. Пользователей в базе: ${data}`;
                elements.connectionStatus.className = 'alert alert-success';
            } catch (error) {
                console.error('Ошибка тестового запроса:', error);
                elements.connectionStatus.textContent = `✗ Ошибка тестового запроса: ${error.message}`;
                elements.connectionStatus.className = 'alert alert-danger';
            }
        }
        
        async function checkAuth() {
            // Проверяем, есть ли сохраненный пользователь в localStorage
            const savedUser = localStorage.getItem('snt_zvezdochka_user');
            
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    await loginUser(user.login, user.password);
                } catch (error) {
                    console.error('Ошибка при восстановлении сессии:', error);
                    localStorage.removeItem('snt_zvezdochka_user');
                }
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = elements.usernameInput.value;
            const password = elements.passwordInput.value;
            
            await loginUser(username, password);
        }
        
        async function loginUser(username, password) {
            try {
                // В реальном приложении здесь должна быть безопасная аутентификация
                // Для демонстрации мы просто ищем пользователя в таблице users
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('login', username)
                    .eq('password', password)
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                if (users && users.length > 0) {
                    const user = users[0];
                    appState.currentUser = user;
                    
                    // Сохраняем пользователя в localStorage (в реальном приложении используйте токены)
                    localStorage.setItem('snt_zvezdochka_user', JSON.stringify({
                        login: user.login,
                        password: user.password
                    }));
                    
                    // Обновляем интерфейс
                    updateUIForUser();
                    
                    // Загружаем данные пользователя
                    await loadUserData();
                    
                    // Показываем сообщение об успешном входе
                    showMessage('success', `Добро пожаловать, ${user.name}!`);
                } else {
                    showMessage('danger', 'Неверный логин или пароль');
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                showMessage('danger', 'Ошибка при входе в систему');
            }
        }
        
        function handleLogout() {
            appState.currentUser = null;
            localStorage.removeItem('snt_zvezdochka_user');
            
            // Сбрасываем интерфейс
            showPage('login');
            elements.currentUser.textContent = 'Гость';
            elements.logoutBtn.classList.add('hidden');
            elements.loginBtn.classList.remove('hidden');
            
            showMessage('info', 'Вы вышли из системы');
        }
        
        function showLoginPage() {
            showPage('login');
        }
        
        function updateUIForUser() {
            if (!appState.currentUser) return;
            
            elements.currentUser.textContent = appState.currentUser.name;
            elements.logoutBtn.classList.remove('hidden');
            elements.loginBtn.classList.add('hidden');
            
            // Показываем соответствующую панель
            if (appState.currentUser.role === 'admin') {
                showPage('admin');
                loadAdminData();
            } else {
                showPage('user');
            }
        }
        
        function showPage(pageName) {
            // Скрываем все страницы
            elements.loginPage.classList.remove('active');
            elements.userDashboard.classList.remove('active');
            elements.adminDashboard.classList.remove('active');
            
            // Показываем нужную страницу
            if (pageName === 'login') {
                elements.loginPage.classList.add('active');
            } else if (pageName === 'user') {
                elements.userDashboard.classList.add('active');
            } else if (pageName === 'admin') {
                elements.adminDashboard.classList.add('active');
            }
            
            appState.currentPage = pageName;
        }
        
        async function loadUserData() {
            if (!appState.currentUser) return;
            
            try {
                // Загружаем счетчики пользователя
                const { data: meters, error: metersError } = await supabase
                    .from('meters')
                    .select('*')
                    .eq('user_id', appState.currentUser.id)
                    .eq('is_active', true);
                
                if (metersError) throw metersError;
                
                appState.userMeters = meters || [];
                
                // Загружаем текущие тарифы
                await loadCurrentTariffs();
                
                // Загружаем последние показания
                await loadUserMeterReadings();
                
                // Обновляем интерфейс
                updateUserDashboard();
                
            } catch (error) {
                console.error('Ошибка загрузки данных пользователя:', error);
                showMessage('danger', 'Ошибка загрузки данных');
            }
        }
        
        async function loadCurrentTariffs() {
            try {
                const currentDate = new Date();
                const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
                
                // Загружаем тарифы на электроэнергию
                const { data: electricityTariffs, error: electricityError } = await supabase
                    .from('electricity_tariffs')
                    .select('*')
                    .eq('period', currentMonth)
                    .limit(1);
                
                if (electricityError) throw electricityError;
                
                // Загружаем тарифы на членские взносы
                const { data: membershipTariffs, error: membershipError } = await supabase
                    .from('membership_tariffs')
                    .select('*')
                    .eq('period', currentMonth)
                    .limit(1);
                
                if (membershipError) throw membershipError;
                
                appState.currentTariffs = {
                    electricity: electricityTariffs && electricityTariffs.length > 0 ? electricityTariffs[0] : null,
                    membership: membershipTariffs && membershipTariffs.length > 0 ? membershipTariffs[0] : null
                };
                
                // Обновляем форму тарифов в админке
                if (appState.currentUser && appState.currentUser.role === 'admin') {
                    updateTariffForms();
                }
                
            } catch (error) {
                console.error('Ошибка загрузки тарифов:', error);
            }
        }
        
        function updateTariffForms() {
            if (!appState.currentTariffs) return;
            
            const currentDate = new Date();
            const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const monthIndex = currentDate.getMonth();
            
            elements.currentMonth.textContent = `${monthNames[monthIndex]} ${currentDate.getFullYear()}`;
            elements.currentMonthMembership.textContent = `${monthNames[monthIndex]} ${currentDate.getFullYear()}`;
            
            // Заполняем форму тарифов на электроэнергию
            if (appState.currentTariffs.electricity) {
                elements.lossRate.value = appState.currentTariffs.electricity.loss_rate || 0;
                elements.rateBelow100.value = appState.currentTariffs.electricity.rate_below_100 || 0;
                elements.rateAbove100.value = appState.currentTariffs.electricity.rate_above_100 || 0;
            }
            
            // Заполняем форму членских взносов
            if (appState.currentTariffs.membership) {
                elements.salaryRate.value = appState.currentTariffs.membership.salary || 0;
                elements.maintenanceRate.value = appState.currentTariffs.membership.maintenance || 0;
                elements.extra1Label.value = appState.currentTariffs.membership.extra1_label || '';
                elements.extra1Rate.value = appState.currentTariffs.membership.extra1_rate || 0;
                elements.extra2Label.value = appState.currentTariffs.membership.extra2_label || '';
                elements.extra2Rate.value = appState.currentTariffs.membership.extra2_rate || 0;
                elements.extra3Label.value = appState.currentTariffs.membership.extra3_label || '';
                elements.extra3Rate.value = appState.currentTariffs.membership.extra3_rate || 0;
            }
        }
        
        async function loadUserMeterReadings() {
            if (!appState.currentUser || appState.userMeters.length === 0) return;
            
            try {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                // Загружаем показания за последние 6 месяцев
                const { data: readings, error } = await supabase
                    .from('meter_readings')
                    .select('*, meters(name)')
                    .in('meter_id', appState.userMeters.map(m => m.id))
                    .order('period', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                appState.readings = readings || [];
                
            } catch (error) {
                console.error('Ошибка загрузки показаний:', error);
            }
        }
        
        function updateUserDashboard() {
            if (!appState.currentUser) return;
            
            // Обновляем основную информацию
            elements.userPlots.textContent = appState.currentUser.plots || 0;
            elements.userAcres.textContent = `Соток: ${appState.currentUser.acres || 0}`;
            elements.userMetersCount.textContent = appState.userMeters.length;
            
            // Устанавливаем текущий период
            const currentDate = new Date();
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const monthIndex = currentDate.getMonth();
            elements.currentPeriod.textContent = `${monthNames[monthIndex]} ${currentDate.getFullYear()}`;
            
            // Рассчитываем текущие начисления
            calculateCurrentCharges();
            
            // Обновляем список счетчиков для ввода показаний
            updateUserMetersList();
            
            // Обновляем историю показаний
            updateMeterReadingsHistory();
            
            // Обновляем историю платежей
            updatePaymentHistory();
        }
        
        function calculateCurrentCharges() {
            if (!appState.currentUser || !appState.currentTariffs) {
                elements.currentBalance.textContent = '0 руб.';
                elements.currentChargesDetails.innerHTML = '<p>Не удалось рассчитать начисления</p>';
                return;
            }
            
            let totalAmount = 0;
            let detailsHTML = '<table><tr><th>Наименование</th><th>Расчет</th><th>Сумма</th></tr>';
            
            // 1. Членские взносы
            const membership = appState.currentTariffs.membership;
            if (membership) {
                // Зарплата
                const salaryAmount = (appState.currentUser.plots || 0) * (membership.salary || 0);
                detailsHTML += `<tr><td>Зарплата (${appState.currentUser.plots} уч. × ${formatCurrency(membership.salary)})</td><td>${appState.currentUser.plots} × ${formatCurrency(membership.salary)}</td><td>${formatCurrency(salaryAmount)}</td></tr>`;
                totalAmount += salaryAmount;
                
                // Содержание
                const maintenanceAmount = (appState.currentUser.acres || 0) * (membership.maintenance || 0);
                detailsHTML += `<tr><td>Содержание (${appState.currentUser.acres} сот. × ${formatCurrency(membership.maintenance)})</td><td>${appState.currentUser.acres} × ${formatCurrency(membership.maintenance)}</td><td>${formatCurrency(maintenanceAmount)}</td></tr>`;
                totalAmount += maintenanceAmount;
                
                // Дополнительные взносы
                if (membership.extra1_label && membership.extra1_rate) {
                    const extra1Amount = (appState.currentUser.acres || 0) * (membership.extra1_rate || 0);
                    detailsHTML += `<tr><td>${membership.extra1_label} (${appState.currentUser.acres} сот. × ${formatCurrency(membership.extra1_rate)})</td><td>${appState.currentUser.acres} × ${formatCurrency(membership.extra1_rate)}</td><td>${formatCurrency(extra1Amount)}</td></tr>`;
                    totalAmount += extra1Amount;
                }
                
                if (membership.extra2_label && membership.extra2_rate) {
                    const extra2Amount = (appState.currentUser.acres || 0) * (membership.extra2_rate || 0);
                    detailsHTML += `<tr><td>${membership.extra2_label} (${appState.currentUser.acres} сот. × ${formatCurrency(membership.extra2_rate)})</td><td>${appState.currentUser.acres} × ${formatCurrency(membership.extra2_rate)}</td><td>${formatCurrency(extra2Amount)}</td></tr>`;
                    totalAmount += extra2Amount;
                }
                
                if (membership.extra3_label && membership.extra3_rate) {
                    const extra3Amount = (appState.currentUser.acres || 0) * (membership.extra3_rate || 0);
                    detailsHTML += `<tr><td>${membership.extra3_label} (${appState.currentUser.acres} сот. × ${formatCurrency(membership.extra3_rate)})</td><td>${appState.currentUser.acres} × ${formatCurrency(membership.extra3_rate)}</td><td>${formatCurrency(extra3Amount)}</td></tr>`;
                    totalAmount += extra3Amount;
                }
            }
            
            // 2. Электроэнергия (пример расчета для одного счетчика)
            // В реальном приложении нужно учитывать показания счетчиков
            const electricity = appState.currentTariffs.electricity;
            if (electricity && appState.userMeters.length > 0) {
                // Пример: предположим, что показания за месяц 763 кВт·ч
                const consumption = 763; // В реальном приложении это разница между текущими и предыдущими показаниями
                
                // Потери
                const lossAmount = consumption * (electricity.loss_rate || 0);
                detailsHTML += `<tr><td>Потери электроэнергии (${consumption} кВт·ч × ${formatCurrency(electricity.loss_rate)})</td><td>${consumption} × ${formatCurrency(electricity.loss_rate)}</td><td>${formatCurrency(lossAmount)}</td></tr>`;
                totalAmount += lossAmount;
                
                // До 100 кВт·ч
                const below100 = Math.min(consumption, 100);
                const below100Amount = below100 * (electricity.rate_below_100 || 0);
                detailsHTML += `<tr><td>Электроэнергия до 100 кВт·ч (${below100} кВт·ч × ${formatCurrency(electricity.rate_below_100)})</td><td>${below100} × ${formatCurrency(electricity.rate_below_100)}</td><td>${formatCurrency(below100Amount)}</td></tr>`;
                totalAmount += below100Amount;
                
                // Свыше 100 кВт·ч
                if (consumption > 100) {
                    const above100 = consumption - 100;
                    const above100Amount = above100 * (electricity.rate_above_100 || 0);
                    detailsHTML += `<tr><td>Электроэнергия свыше 100 кВт·ч (${above100} кВт·ч × ${formatCurrency(electricity.rate_above_100)})</td><td>${above100} × ${formatCurrency(electricity.rate_above_100)}</td><td>${formatCurrency(above100Amount)}</td></tr>`;
                    totalAmount += above100Amount;
                }
            }
            
            detailsHTML += `<tr style="font-weight: bold; background-color: #f5f5f5;"><td colspan="2">ИТОГО К УПЛАТЕ</td><td>${formatCurrency(totalAmount)}</td></tr>`;
            detailsHTML += '</table>';
            
            elements.currentBalance.textContent = formatCurrency(totalAmount);
            elements.currentChargesDetails.innerHTML = detailsHTML;
        }
        
        function updateUserMetersList() {
            if (!appState.userMeters || appState.userMeters.length === 0) {
                elements.userMetersList.innerHTML = '<p>У вас нет зарегистрированных счетчиков</p>';
                return;
            }
            
            let html = '';
            
            appState.userMeters.forEach(meter => {
                // Находим последние показания для этого счетчика
                const lastReading = appState.readings
                    .filter(r => r.meter_id === meter.id)
                    .sort((a, b) => new Date(b.period) - new Date(a.period))[0];
                
                const lastReadingValue = lastReading ? lastReading.reading : '';
                
                html += `
                <div class="meter-row">
                    <div class="form-group">
                        <label>${meter.name} (текущие показания)</label>
                        <input type="number" step="0.001" class="form-control meter-reading" data-meter-id="${meter.id}" placeholder="Введите показания" value="${lastReadingValue}">
                    </div>
                    <div class="form-group">
                        <label>Предыдущие показания</label>
                        <input type="text" class="form-control" value="${lastReadingValue || 'нет данных'}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Расход за месяц (кВт·ч)</label>
                        <input type="text" class="form-control" value="-" disabled>
                    </div>
                </div>
                `;
            });
            
            elements.userMetersList.innerHTML = html;
        }
        
        function updateMeterReadingsHistory() {
            if (!appState.readings || appState.readings.length === 0) {
                elements.meterReadingsHistory.innerHTML = '<p>История показаний отсутствует</p>';
                return;
            }
            
            let html = '<table><tr><th>Дата</th><th>Счетчик</th><th>Показания</th></tr>';
            
            // Группируем показания по периоду
            const readingsByPeriod = {};
            
            appState.readings.forEach(reading => {
                const period = reading.period;
                if (!readingsByPeriod[period]) {
                    readingsByPeriod[period] = [];
                }
                readingsByPeriod[period].push(reading);
            });
            
            // Сортируем периоды по убыванию
            const sortedPeriods = Object.keys(readingsByPeriod).sort((a, b) => new Date(b) - new Date(a));
            
            // Выводим по 6 последних периодов
            sortedPeriods.slice(0, 6).forEach(period => {
                const date = new Date(period);
                const periodFormatted = `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`;
                
                html += `<tr><td colspan="3" style="background-color: #f5f5f5; font-weight: bold;">${periodFormatted}</td></tr>`;
                
                readingsByPeriod[period].forEach(reading => {
                    html += `<tr><td></td><td>${reading.meters?.name || 'Счетчик'}</td><td>${reading.reading} кВт·ч</td></tr>`;
                });
            });
            
            html += '</table>';
            elements.meterReadingsHistory.innerHTML = html;
        }
        
        function updatePaymentHistory() {
            // В реальном приложении здесь должна быть загрузка истории платежей из базы
            // Для демонстрации создаем тестовые данные
            
            const currentDate = new Date();
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            
            let html = '<table><tr><th>Период</th><th>Электроэнергия</th><th>Членские взносы</th><th>Итого</th><th>Статус</th></tr>';
            
            // Генерируем историю за последние 6 месяцев
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                
                // Случайные суммы для демонстрации
                const electricityAmount = Math.floor(Math.random() * 5000) + 1000;
                const membershipAmount = Math.floor(Math.random() * 3000) + 1000;
                const totalAmount = electricityAmount + membershipAmount;
                
                // Случайный статус
                const statuses = ['Оплачено', 'Ожидает оплаты', 'Просрочено'];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const statusClass = status === 'Оплачено' ? 'success' : status === 'Ожидает оплаты' ? 'warning' : 'danger';
                
                html += `<tr>
                    <td>${month} ${year}</td>
                    <td>${formatCurrency(electricityAmount)}</td>
                    <td>${formatCurrency(membershipAmount)}</td>
                    <td>${formatCurrency(totalAmount)}</td>
                    <td><span class="btn btn-${statusClass}" style="padding: 5px 10px; font-size: 14px;">${status}</span></td>
                </tr>`;
            }
            
            html += '</table>';
            elements.paymentHistory.innerHTML = html;
        }
        
        async function submitMeterReadings() {
            if (!appState.currentUser) {
                showMessage('danger', 'Для передачи показаний необходимо войти в систему');
                return;
            }
            
            const currentDate = new Date();
            const currentPeriod = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
            
            // Собираем показания со всех счетчиков
            const readingInputs = document.querySelectorAll('.meter-reading');
            const readings = [];
            
            for (const input of readingInputs) {
                const meterId = parseInt(input.getAttribute('data-meter-id'));
                const readingValue = parseFloat(input.value);
                
                if (isNaN(readingValue) || readingValue < 0) {
                    showMessage('danger', `Пожалуйста, введите корректные показания для всех счетчиков`);
                    return;
                }
                
                readings.push({
                    meter_id: meterId,
                    period: currentPeriod,
                    reading: readingValue,
                    submitted_at: new Date().toISOString()
                });
            }
            
            try {
                // Сохраняем показания в базе
                for (const reading of readings) {
                    const { error } = await supabase
                        .from('meter_readings')
                        .upsert([reading], { onConflict: 'meter_id,period' });
                    
                    if (error) throw error;
                }
                
                showMessage('success', 'Показания успешно сохранены!');
                
                // Обновляем данные
                await loadUserMeterReadings();
                updateUserDashboard();
                
            } catch (error) {
                console.error('Ошибка сохранения показаний:', error);
                showMessage('danger', 'Ошибка при сохранении показаний');
            }
        }
        
        async function loadAdminData() {
            if (!appState.currentUser || appState.currentUser.role !== 'admin') return;
            
            try {
                // Загружаем всех пользователей
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .order('name');
                
                if (usersError) throw usersError;
                
                appState.users = users || [];
                
                // Загружаем все счетчики
                const { data: meters, error: metersError } = await supabase
                    .from('meters')
                    .select('*, users(name, login)');
                
                if (metersError) throw metersError;
                
                appState.meters = meters || [];
                
                // Загружаем все показания за текущий месяц
                const currentDate = new Date();
                const currentPeriod = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
                
                const { data: readings, error: readingsError } = await supabase
                    .from('meter_readings')
                    .select('*, meters(name, user_id)')
                    .eq('period', currentPeriod);
                
                if (readingsError) throw readingsError;
                
                appState.readings = readings || [];
                
                // Обновляем интерфейс админ-панели
                updateAdminDashboard();
                
            } catch (error) {
                console.error('Ошибка загрузки данных для админ-панели:', error);
                showMessage('danger', 'Ошибка загрузки данных');
            }
        }
        
        function updateAdminDashboard() {
            // Обновляем статистику
            elements.totalUsers.textContent = appState.users.length;
            
            // Считаем пользователей, которые передали показания за текущий месяц
            const usersWithReadings = new Set();
            appState.readings.forEach(reading => {
                if (reading.meters && reading.meters.user_id) {
                    usersWithReadings.add(reading.meters.user_id);
                }
            });
            
            elements.usersWithReadings.textContent = usersWithReadings.size;
            
            // Рассчитываем общую сумму начислений (примерно)
            let totalCharges = 0;
            appState.users.forEach(user => {
                // Примерный расчет: предположим, что у каждого пользователя начислено 5000 руб.
                totalCharges += 5000;
            });
            
            elements.totalCharges.textContent = formatCurrency(totalCharges);
            
            // Обновляем список пользователей
            updateUsersList();
            
            // Обновляем список показаний для админа
            updateAllUsersReadings();
            
            // Обновляем историю тарифов
            updateTariffHistory();
            
            // Устанавливаем текущий период в админке
            const currentDate = new Date();
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const monthIndex = currentDate.getMonth();
            elements.adminCurrentPeriod.textContent = `${monthNames[monthIndex]} ${currentDate.getFullYear()}`;
            elements.modalCurrentPeriod.textContent = `${monthNames[monthIndex]} ${currentDate.getFullYear()}`;
        }
        
        function updateUsersList() {
            if (!appState.users || appState.users.length === 0) {
                elements.usersList.innerHTML = '<p>Нет зарегистрированных пользователей</p>';
                return;
            }
            
            let html = '<table><tr><th>ID</th><th>ФИО</th><th>Логин</th><th>Участков</th><th>Соток</th><th>Роль</th><th>Действия</th></tr>';
            
            appState.users.forEach(user => {
                html += `<tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.login}</td>
                    <td>${user.plots}</td>
                    <td>${user.acres}</td>
                    <td>${user.role === 'admin' ? 'Администратор' : 'Пользователь'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editUser('${user.id}')">Редактировать</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Удалить</button>
                    </td>
                </tr>`;
            });
            
            html += '</table>';
            elements.usersList.innerHTML = html;
        }
        
        function updateAllUsersReadings() {
            if (!appState.users || appState.users.length === 0) {
                elements.allUsersReadings.innerHTML = '<p>Нет данных о пользователях</p>';
                return;
            }
            
            let html = '<table><tr><th>Пользователь</th><th>Счетчик</th><th>Показания</th><th>Дата передачи</th><th>Действия</th></tr>';
            
            const currentDate = new Date();
            const currentPeriod = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
            
            appState.users.forEach(user => {
                // Находим счетчики пользователя
                const userMeters = appState.meters.filter(meter => meter.user_id === user.id);
                
                if (userMeters.length === 0) {
                    html += `<tr>
                        <td>${user.name}</td>
                        <td colspan="4">Нет зарегистрированных счетчиков</td>
                    </tr>`;
                } else {
                    userMeters.forEach((meter, index) => {
                        // Находим показания для этого счетчика за текущий период
                        const reading = appState.readings.find(r => r.meter_id === meter.id);
                        
                        if (index === 0) {
                            // Первая строка с именем пользователя
                            html += `<tr>
                                <td rowspan="${userMeters.length}">${user.name}</td>
                                <td>${meter.name}</td>
                                <td>${reading ? reading.reading + ' кВт·ч' : 'не переданы'}</td>
                                <td>${reading ? new Date(reading.submitted_at).toLocaleDateString('ru-RU') : '-'}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editReading('${meter.id}', '${currentPeriod}')">Ввести/Изменить</button>
                                </td>
                            </tr>`;
                        } else {
                            // Последующие строки без имени пользователя
                            html += `<tr>
                                <td>${meter.name}</td>
                                <td>${reading ? reading.reading + ' кВт·ч' : 'не переданы'}</td>
                                <td>${reading ? new Date(reading.submitted_at).toLocaleDateString('ru-RU') : '-'}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editReading('${meter.id}', '${currentPeriod}')">Ввести/Изменить</button>
                                </td>
                            </tr>`;
                        }
                    });
                }
            });
            
            html += '</table>';
            elements.allUsersReadings.innerHTML = html;
        }
        
        async function updateTariffHistory() {
            try {
                // Загружаем историю тарифов на электроэнергию
                const { data: electricityTariffs, error: electricityError } = await supabase
                    .from('electricity_tariffs')
                    .select('*')
                    .order('period', { ascending: false })
                    .limit(12);
                
                if (electricityError) throw electricityError;
                
                // Загружаем историю тарифов на членские взносы
                const { data: membershipTariffs, error: membershipError } = await supabase
                    .from('membership_tariffs')
                    .select('*')
                    .order('period', { ascending: false })
                    .limit(12);
                
                if (membershipError) throw membershipError;
                
                let html = '<h4>Тарифы на электроэнергию</h4>';
                
                if (electricityTariffs && electricityTariffs.length > 0) {
                    html += '<table><tr><th>Период</th><th>Потери</th><th>До 100 кВт·ч</th><th>Свыше 100 кВт·ч</th></tr>';
                    
                    electricityTariffs.forEach(tariff => {
                        const date = new Date(tariff.period);
                        const periodFormatted = `${date.getMonth() + 1}/${date.getFullYear()}`;
                        
                        html += `<tr>
                            <td>${periodFormatted}</td>
                            <td>${formatCurrency(tariff.loss_rate)}</td>
                            <td>${formatCurrency(tariff.rate_below_100)}</td>
                            <td>${formatCurrency(tariff.rate_above_100)}</td>
                        </tr>`;
                    });
                    
                    html += '</table>';
                } else {
                    html += '<p>История тарифов отсутствует</p>';
                }
                
                html += '<h4 style="margin-top: 20px;">Тарифы на членские взносы</h4>';
                
                if (membershipTariffs && membershipTariffs.length > 0) {
                    html += '<table><tr><th>Период</th><th>Зарплата</th><th>Содержание</th><th>Доп. взносы</th></tr>';
                    
                    membershipTariffs.forEach(tariff => {
                        const date = new Date(tariff.period);
                        const periodFormatted = `${date.getMonth() + 1}/${date.getFullYear()}`;
                        
                        let extraFees = '';
                        if (tariff.extra1_label) extraFees += `${tariff.extra1_label}: ${formatCurrency(tariff.extra1_rate)}<br>`;
                        if (tariff.extra2_label) extraFees += `${tariff.extra2_label}: ${formatCurrency(tariff.extra2_rate)}<br>`;
                        if (tariff.extra3_label) extraFees += `${tariff.extra3_label}: ${formatCurrency(tariff.extra3_rate)}`;
                        
                        html += `<tr>
                            <td>${periodFormatted}</td>
                            <td>${formatCurrency(tariff.salary)}</td>
                            <td>${formatCurrency(tariff.maintenance)}</td>
                            <td>${extraFees || 'нет'}</td>
                        </tr>`;
                    });
                    
                    html += '</table>';
                } else {
                    html += '<p>История тарифов отсутствует</p>';
                }
                
                elements.tariffHistoryList.innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки истории тарифов:', error);
                elements.tariffHistoryList.innerHTML = '<p>Ошибка загрузки истории тарифов</p>';
            }
        }
        
        function showAddUserModal() {
            elements.modalBackdrop.classList.remove('hidden');
            elements.addUserModal.classList.remove('hidden');
        }
        
        function hideAddUserModal() {
            elements.modalBackdrop.classList.add('hidden');
            elements.addUserModal.classList.add('hidden');
            elements.addUserForm.reset();
        }
        
        async function addNewUser(e) {
            e.preventDefault();
            
            const login = document.getElementById('new-user-login').value;
            const password = document.getElementById('new-user-password').value;
            const name = document.getElementById('new-user-name').value;
            const plots = parseInt(document.getElementById('new-user-plots').value);
            const acres = parseFloat(document.getElementById('new-user-acres').value);
            const role = document.getElementById('new-user-role').value;
            
            try {
                // В реальном приложении пароль должен хэшироваться!
                const { data, error } = await supabase
                    .from('users')
                    .insert([{
                        login: login,
                        password: password,
                        name: name,
                        role: role,
                        plots: plots,
                        acres: acres
                    }]);
                
                if (error) throw error;
                
                showMessage('success', `Пользователь ${name} успешно добавлен`);
                hideAddUserModal();
                
                // Обновляем данные
                await loadAdminData();
                
            } catch (error) {
                console.error('Ошибка добавления пользователя:', error);
                showMessage('danger', 'Ошибка при добавлении пользователя');
            }
        }
        
        async function saveElectricityTariffs(e) {
            e.preventDefault();
            
            const currentDate = new Date();
            const currentPeriod = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
            
            const lossRate = parseFloat(elements.lossRate.value);
            const rateBelow100 = parseFloat(elements.rateBelow100.value);
            const rateAbove100 = parseFloat(elements.rateAbove100.value);
            
            try {
                const { data, error } = await supabase
                    .from('electricity_tariffs')
                    .upsert([{
                        period: currentPeriod,
                        loss_rate: lossRate,
                        rate_below_100: rateBelow100,
                        rate_above_100: rateAbove100
                    }], { onConflict: 'period' });
                
                if (error) throw error;
                
                showMessage('success', 'Тарифы на электроэнергию успешно сохранены');
                
                // Обновляем текущие тарифы
                await loadCurrentTariffs();
                
            } catch (error) {
                console.error('Ошибка сохранения тарифов:', error);
                showMessage('danger', 'Ошибка при сохранении тарифов');
            }
        }
        
        async function saveMembershipTariffs(e) {
            e.preventDefault();
            
            const currentDate = new Date();
            const currentPeriod = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
            
            const salaryRate = parseFloat(elements.salaryRate.value);
            const maintenanceRate = parseFloat(elements.maintenanceRate.value);
            const extra1Label = elements.extra1Label.value;
            const extra1Rate = parseFloat(elements.extra1Rate.value) || 0;
            const extra2Label = elements.extra2Label.value;
            const extra2Rate = parseFloat(elements.extra2Rate.value) || 0;
            const extra3Label = elements.extra3Label.value;
            const extra3Rate = parseFloat(elements.extra3Rate.value) || 0;
            
            try {
                const { data, error } = await supabase
                    .from('membership_tariffs')
                    .upsert([{
                        period: currentPeriod,
                        salary: salaryRate,
                        maintenance: maintenanceRate,
                        extra1_label: extra1Label,
                        extra1_rate: extra1Rate,
                        extra2_label: extra2Label,
                        extra2_rate: extra2Rate,
                        extra3_label: extra3Label,
                        extra3_rate: extra3Rate
                    }], { onConflict: 'period' });
                
                if (error) throw error;
                
                showMessage('success', 'Тарифы на членские взносы успешно сохранены');
                
                // Обновляем текущие тарифы
                await loadCurrentTariffs();
                
            } catch (error) {
                console.error('Ошибка сохранения тарифов:', error);
                showMessage('danger', 'Ошибка при сохранении тарифов');
            }
        }
        
        function showEnterReadingsModal() {
            // Заполняем форму показаний
            let formHTML = '';
            
            appState.users.forEach(user => {
                // Находим счетчики пользователя
                const userMeters = appState.meters.filter(meter => meter.user_id === user.id);
                
                if (userMeters.length > 0) {
                    formHTML += `<div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                        <h4>${user.name}</h4>`;
                    
                    userMeters.forEach(meter => {
                        // Находим текущие показания для этого счетчика
                        const currentDate = new Date();
                        const currentPeriod = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
                        
                        const reading = appState.readings.find(r => r.meter_id === meter.id && r.period === currentPeriod);
                        
                        formHTML += `
                        <div class="form-group" style="margin-left: 20px;">
                            <label>${meter.name}</label>
                            <input type="number" step="0.001" class="form-control admin-meter-reading" 
                                data-user-id="${user.id}" data-meter-id="${meter.id}" 
                                placeholder="Введите показания" value="${reading ? reading.reading : ''}">
                        </div>`;
                    });
                    
                    formHTML += `</div>`;
                }
            });
            
            elements.enterReadingsForm.innerHTML = formHTML;
            
            // Показываем модальное окно
            elements.modalBackdrop.classList.remove('hidden');
            elements.enterReadingsModal.classList.remove('hidden');
        }
        
        function hideEnterReadingsModal() {
            elements.modalBackdrop.classList.add('hidden');
            elements.enterReadingsModal.classList.add('hidden');
        }
        
        async function saveAllReadings() {
            const currentDate = new Date();
            const currentPeriod = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
            
            // Собираем все показания из формы
            const readingInputs = document.querySelectorAll('.admin-meter-reading');
            const readings = [];
            
            for (const input of readingInputs) {
                const meterId = parseInt(input.getAttribute('data-meter-id'));
                const readingValue = parseFloat(input.value);
                
                // Если поле пустое, пропускаем его
                if (isNaN(readingValue)) {
                    continue;
                }
                
                if (readingValue < 0) {
                    showMessage('danger', 'Показания не могут быть отрицательными');
                    return;
                }
                
                readings.push({
                    meter_id: meterId,
                    period: currentPeriod,
                    reading: readingValue,
                    submitted_at: new Date().toISOString()
                });
            }
            
            try {
                // Сохраняем показания в базе
                for (const reading of readings) {
                    const { error } = await supabase
                        .from('meter_readings')
                        .upsert([reading], { onConflict: 'meter_id,period' });
                    
                    if (error) throw error;
                }
                
                showMessage('success', 'Показания успешно сохранены!');
                hideEnterReadingsModal();
                
                // Обновляем данные
                await loadAdminData();
                
            } catch (error) {
                console.error('Ошибка сохранения показаний:', error);
                showMessage('danger', 'Ошибка при сохранении показаний');
            }
        }
        
        async function exportData() {
            try {
                // Собираем данные для экспорта
                const exportData = {};
                
                // Пользователи
                if (document.getElementById('export-users').checked) {
                    const { data: users, error } = await supabase
                        .from('users')
                        .select('*');
                    
                    if (error) throw error;
                    exportData.users = users;
                }
                
                // Счетчики
                if (document.getElementById('export-meters').checked) {
                    const { data: meters, error } = await supabase
                        .from('meters')
                        .select('*');
                    
                    if (error) throw error;
                    exportData.meters = meters;
                }
                
                // Показания
                if (document.getElementById('export-readings').checked) {
                    const { data: readings, error } = await supabase
                        .from('meter_readings')
                        .select('*');
                    
                    if (error) throw error;
                    exportData.readings = readings;
                }
                
                // Тарифы
                if (document.getElementById('export-tariffs').checked) {
                    // Электроэнергия
                    const { data: electricityTariffs, error: electricityError } = await supabase
                        .from('electricity_tariffs')
                        .select('*');
                    
                    if (electricityError) throw electricityError;
                    exportData.electricityTariffs = electricityTariffs;
                    
                    // Членские взносы
                    const { data: membershipTariffs, error: membershipError } = await supabase
                        .from('membership_tariffs')
                        .select('*');
                    
                    if (membershipError) throw membershipError;
                    exportData.membershipTariffs = membershipTariffs;
                }
                
                // Преобразуем в JSON
                const jsonData = JSON.stringify(exportData, null, 2);
                
                // Создаем и скачиваем файл
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `snt_zvezdochka_export_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('success', 'Данные успешно экспортированы');
                
            } catch (error) {
                console.error('Ошибка экспорта данных:', error);
                showMessage('danger', 'Ошибка при экспорте данных');
            }
        }
        
        async function importData() {
            const fileInput = elements.importFile;
            const importType = elements.importType.value;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showMessage('danger', 'Пожалуйста, выберите файл для импорта');
                return;
            }
            
            const file = fileInput.files[0];
            
            try {
                const fileContent = await readFileAsText(file);
                let data;
                
                // Пробуем распарсить JSON
                try {
                    data = JSON.parse(fileContent);
                } catch (e) {
                    // Если не JSON, пробуем CSV
                    data = parseCSV(fileContent);
                }
                
                // В зависимости от типа данных импортируем в соответствующую таблицу
                if (importType === 'users' && data.users) {
                    await importUsers(data.users);
                } else if (importType === 'meters' && data.meters) {
                    await importMeters(data.meters);
                } else if (importType === 'readings' && data.readings) {
                    await importReadings(data.readings);
                } else if (importType === 'tariffs') {
                    if (data.electricityTariffs) {
                        await importElectricityTariffs(data.electricityTariffs);
                    }
                    if (data.membershipTariffs) {
                        await importMembershipTariffs(data.membershipTariffs);
                    }
                } else {
                    showMessage('danger', 'Неверный формат данных для выбранного типа импорта');
                    return;
                }
                
                showMessage('success', 'Данные успешно импортированы');
                fileInput.value = '';
                
                // Обновляем данные
                if (appState.currentUser.role === 'admin') {
                    await loadAdminData();
                } else {
                    await loadUserData();
                }
                
            } catch (error) {
                console.error('Ошибка импорта данных:', error);
                showMessage('danger', 'Ошибка при импорте данных');
            }
        }
        
        async function importUsers(users) {
            for (const user of users) {
                const { error } = await supabase
                    .from('users')
                    .upsert([user], { onConflict: 'login' });
                
                if (error) throw error;
            }
        }
        
        async function importMeters(meters) {
            for (const meter of meters) {
                const { error } = await supabase
                    .from('meters')
                    .upsert([meter], { onConflict: 'id' });
                
                if (error) throw error;
            }
        }
        
        async function importReadings(readings) {
            for (const reading of readings) {
                const { error } = await supabase
                    .from('meter_readings')
                    .upsert([reading], { onConflict: 'meter_id,period' });
                
                if (error) throw error;
            }
        }
        
        async function importElectricityTariffs(tariffs) {
            for (const tariff of tariffs) {
                const { error } = await supabase
                    .from('electricity_tariffs')
                    .upsert([tariff], { onConflict: 'period' });
                
                if (error) throw error;
            }
        }
        
        async function importMembershipTariffs(tariffs) {
            for (const tariff of tariffs) {
                const { error } = await supabase
                    .from('membership_tariffs')
                    .upsert([tariff], { onConflict: 'period' });
                
                if (error) throw error;
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            const headers = lines[0].split(',');
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const obj = {};
                const currentLine = lines[i].split(',');
                
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j].trim()] = currentLine[j] ? currentLine[j].trim() : '';
                }
                
                result.push(obj);
            }
            
            return result;
        }
        
        function showMessage(type, text) {
            // Создаем элемент сообщения
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = text;
            
            // Вставляем сообщение в начало контейнера
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            // Удаляем сообщение через 5 секунд
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 2
            }).format(amount);
        }
        
        function hideAllModals() {
            hideAddUserModal();
            hideEnterReadingsModal();
        }
        
        function showAdminTab(tabId) {
            // Активируем вкладку в админ-панели
            const tab = document.querySelector(`.tab[data-target="${tabId}"]`);
            if (tab) {
                tab.click();
            }
        }
        
        // Глобальные функции для кнопок действий
        window.editUser = function(userId) {
            alert(`Редактирование пользователя ${userId} - эта функциональность в разработке`);
        };
        
        window.deleteUser = function(userId) {
            if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                alert(`Удаление пользователя ${userId} - эта функциональность в разработке`);
            }
        };
        
        window.editReading = function(meterId, period) {
            alert(`Редактирование показаний для счетчика ${meterId} - эта функциональность в разработке`);
        };
    </script>
</body>
</html>
