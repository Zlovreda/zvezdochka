<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора - ЭнергоУчет</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        .admin-sidebar {
            background: #2c3e50;
            min-height: 100vh;
            color: white;
        }
        .admin-sidebar .nav-link {
            color: #ecf0f1;
        }
        .admin-sidebar .nav-link:hover {
            background: #34495e;
            color: white;
        }
        .admin-sidebar .nav-link.active {
            background: #3498db;
        }
        .stat-card {
            border-radius: 10px;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Сайдбар админа -->
            <nav class="col-md-3 col-lg-2 admin-sidebar d-md-block p-3">
                <div class="position-sticky">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-shield-lock"></i> Админ-панель
                    </h4>
                    
                    <div class="text-center mb-4">
                        <div class="bg-primary rounded-circle d-inline-flex p-3">
                            <i class="bi bi-person-fill" style="font-size: 2rem;"></i>
                        </div>
                        <h6 id="adminName" class="mt-2">Администратор</h6>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard">
                                <i class="bi bi-speedometer2 me-2"></i> Дашборд
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#users" onclick="showUsers()">
                                <i class="bi bi-people me-2"></i> Пользователи
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#meters" onclick="showMeters()">
                                <i class="bi bi-speedometer me-2"></i> Счетчики
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tariffs" onclick="showTariffs()">
                                <i class="bi bi-currency-exchange me-2"></i> Тарифы
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#reports">
                                <i class="bi bi-file-earmark-bar-graph me-2"></i> Отчеты
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#importExport">
                                <i class="bi bi-arrow-left-right me-2"></i> Импорт/Экспорт
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <button class="btn btn-outline-light w-100" onclick="logout()">
                                <i class="bi bi-box-arrow-left me-2"></i> Выход
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Основной контент -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <!-- Дашборд -->
                <div id="dashboard">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h2>Дашборд администратора</h2>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-success me-2" onclick="exportData()">
                                <i class="bi bi-file-earmark-excel me-2"></i> Экспорт
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="bi bi-person-plus me-2"></i> Добавить пользователя
                            </button>
                        </div>
                    </div>

                    <!-- Статистика -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card bg-primary text-white p-3">
                                <h6>Всего пользователей</h6>
                                <h2 id="totalUsers">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card bg-success text-white p-3">
                                <h6>Активных счетчиков</h6>
                                <h2 id="activeMeters">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card bg-warning text-white p-3">
                                <h6>Показания за месяц</h6>
                                <h2 id="readingsThisMonth">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card bg-danger text-white p-3">
                                <h6>Общая задолженность</h6>
                                <h2 id="totalSystemDebt">0 руб</h2>
                            </div>
                        </div>
                    </div>

                    <!-- Последние показания -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i> Последние показания
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="recentReadings">
                                    <thead>
                                        <tr>
                                            <th>Дата</th>
                                            <th>Пользователь</th>
                                            <th>Счетчик</th>
                                            <th>Показания</th>
                                            <th>Расход</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Заполняется через JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Управление пользователями -->
                <div id="users" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Управление пользователями</h3>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus me-2"></i> Добавить
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Логин</th>
                                    <th>Имя</th>
                                    <th>Адрес</th>
                                    <th>Участков</th>
                                    <th>Соток</th>
                                    <th>Телефон</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="usersBody">
                                <!-- Заполняется через JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Управление тарифами -->
                <div id="tariffs" style="display: none;">
                    <h3 class="mb-3">Управление тарифами</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Тарифы на электроэнергию</h5>
                                </div>
                                <div class="card-body">
                                    <form id="electricityTariffForm">
                                        <div class="mb-3">
                                            <label class="form-label">Тариф до 100 кВт·ч</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="rateUpTo100" value="6.10">
                                                <span class="input-group-text">руб/кВт·ч</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Тариф свыше 100 кВт·ч</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="rateOver100" value="7.30">
                                                <span class="input-group-text">руб/кВт·ч</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Потери (%)</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="lossRate" value="3.60">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="bi bi-check-circle me-2"></i> Сохранить тарифы
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Членские взносы</h5>
                                </div>
                                <div class="card-body">
                                    <form id="membershipForm">
                                        <div class="mb-3">
                                            <label class="form-label">За участок (в месяц)</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="membershipPerPlot" value="939.00">
                                                <span class="input-group-text">руб</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">За сотку (в месяц)</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="membershipPerSotka" value="8.77">
                                                <span class="input-group-text">руб/сотка</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Целевой сбор 1</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="targetFee1" value="0.00">
                                                <span class="input-group-text">руб</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Целевой сбор 2</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="targetFee2" value="0.00">
                                                <span class="input-group-text">руб</span>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="bi bi-check-circle me-2"></i> Сохранить взносы
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Модальное окно добавления пользователя -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить нового пользователя</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Логин *</label>
                                    <input type="text" class="form-control" id="newUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Пароль *</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ФИО *</label>
                                    <input type="text" class="form-control" id="newFullName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Адрес</label>
                                    <input type="text" class="form-control" id="newAddress">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Телефон</label>
                                    <input type="tel" class="form-control" id="newPhone">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="newEmail">
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                Информация об участках
                            </div>
                            <div class="card-body">
                                <div id="plotsContainer">
                                    <div class="plot-item mb-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Номер участка</label>
                                                <input type="text" class="form-control" name="plotNumber[]">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Количество соток</label>
                                                <input type="number" step="0.01" class="form-control" name="plotSotki[]">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addPlotField()">
                                    <i class="bi bi-plus-circle me-1"></i> Добавить участок
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewUser()">
                        <i class="bi bi-save me-2"></i> Сохранить пользователя
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Инициализация Supabase
        const supabaseUrl = 'https://ihydjzxctlguvflswzhg.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImloeWRqenhjdGxndXZmbHN3emhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NzY5MzUsImV4cCI6MjA4NDU1MjkzNX0.KvpKM7FggBOWNuFR8gmL7cjk64tt6CCgAI-UlkP7ZXU'
        const supabase = supabase.createClient(supabaseUrl, supabaseKey)
        
        let currentAdmin = null
        
        // Проверка авторизации
        document.addEventListener('DOMContentLoaded', async () => {
            const userData = localStorage.getItem('user')
            if (!userData) {
                window.location.href = 'index.html'
                return
            }
            
            currentAdmin = JSON.parse(userData)
            if (currentAdmin.role !== 'admin') {
                window.location.href = 'user.html'
                return
            }
            
            document.getElementById('adminName').textContent = currentAdmin.name || 'Администратор'
            
            // Загрузка статистики
            await loadStatistics()
            await loadRecentReadings()
            await loadAllUsers()
        })
        
        async function loadStatistics() {
            // Получаем общее количество пользователей
            const { count: userCount } = await supabase
                .from('users')
                .select('*', { count: 'exact', head: true })
            
            // Получаем количество счетчиков
            const { count: meterCount } = await supabase
                .from('meters')
                .select('*', { count: 'exact', head: true })
            
            // Получаем показания за текущий месяц
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1)
            const { count: readingsCount } = await supabase
                .from('meter_readings')
                .select('*', { count: 'exact', head: true })
                .gte('created_at', startOfMonth.toISOString())
            
            // Обновляем статистику
            document.getElementById('totalUsers').textContent = userCount || 0
            document.getElementById('activeMeters').textContent = meterCount || 0
            document.getElementById('readingsThisMonth').textContent = readingsCount || 0
        }
        
        async function loadRecentReadings() {
            const { data: readings, error } = await supabase
                .from('meter_readings')
                .select(`
                    *,
                    meters(number),
                    users(name, username)
                `)
                .order('created_at', { ascending: false })
                .limit(10)
            
            if (error) {
                console.error('Error loading readings:', error)
                return
            }
            
            const tbody = document.querySelector('#recentReadings tbody')
            tbody.innerHTML = ''
            
            readings.forEach(reading => {
                const row = tbody.insertRow()
                const consumption = reading.current_reading - reading.previous_reading
                
                row.innerHTML = `
                    <td>${new Date(reading.reading_date).toLocaleDateString('ru-RU')}</td>
                    <td>${reading.users?.name || reading.users?.username}</td>
                    <td>${reading.meters?.number || 'N/A'}</td>
                    <td>${reading.current_reading}</td>
                    <td>${consumption.toFixed(2)} кВт·ч</td>
                `
            })
        }
        
        async function loadAllUsers() {
            const { data: users, error } = await supabase
                .from('users')
                .select(`
                    *,
                    plots(count)
                `)
                .order('created_at', { ascending: false })
            
            if (error) {
                console.error('Error loading users:', error)
                return
            }
            
            const tbody = document.getElementById('usersBody')
            tbody.innerHTML = ''
            
            users.forEach(user => {
                // Подсчитываем общее количество соток
                let totalSotki = 0
                if (user.plots) {
                    // Здесь нужно будет доработать для получения суммы соток
                }
                
                const row = tbody.insertRow()
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.name || '-'}</td>
                    <td>${user.address || '-'}</td>
                    <td>${user.plots?.length || 0}</td>
                    <td>${totalSotki}</td>
                    <td>${user.phone || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `
            })
        }
        
        function showUsers() {
            document.getElementById('dashboard').style.display = 'none'
            document.getElementById('tariffs').style.display = 'none'
            document.getElementById('users').style.display = 'block'
        }
        
        function showTariffs() {
            document.getElementById('dashboard').style.display = 'none'
            document.getElementById('users').style.display = 'none'
            document.getElementById('tariffs').style.display = 'block'
        }
        
        function addPlotField() {
            const container = document.getElementById('plotsContainer')
            const div = document.createElement('div')
            div.className = 'plot-item mb-3'
            div.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Номер участка</label>
                        <input type="text" class="form-control" name="plotNumber[]">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Количество соток</label>
                        <input type="number" step="0.01" class="form-control" name="plotSotki[]">
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="this.parentElement.remove()">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            `
            container.appendChild(div)
        }
        
        async function saveNewUser() {
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                name: document.getElementById('newFullName').value,
                address: document.getElementById('newAddress').value,
                phone: document.getElementById('newPhone').value,
                email: document.getElementById('newEmail').value,
                role: 'user',
                created_at: new Date().toISOString()
            }
            
            // Сохраняем пользователя
            const { data: user, error } = await supabase
                .from('users')
                .insert([userData])
                .select()
                .single()
            
            if (error) {
                alert('Ошибка сохранения: ' + error.message)
                return
            }
            
            // Сохраняем участки
            const plotNumbers = document.getElementsByName('plotNumber[]')
            const plotSotki = document.getElementsByName('plotSotki[]')
            
            const plots = []
            for (let i = 0; i < plotNumbers.length; i++) {
                if (plotNumbers[i].value) {
                    plots.push({
                        user_id: user.id,
                        number: plotNumbers[i].value,
                        sotki: parseFloat(plotSotki[i].value) || 0,
                        created_at: new Date().toISOString()
                    })
                }
            }
            
            if (plots.length > 0) {
                await supabase.from('plots').insert(plots)
            }
            
            alert('Пользователь успешно добавлен!')
            $('#addUserModal').modal('hide')
            location.reload()
        }
        
        function exportData() {
            // Здесь можно реализовать экспорт данных в Excel/CSV
            alert('Функция экспорта будет реализована в следующем обновлении')
        }
        
        function logout() {
            localStorage.removeItem('user')
            window.location.href = 'index.html'
        }
    </script>
</body>
</html>